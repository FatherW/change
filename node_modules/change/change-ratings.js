import { PolymerElement, html } from '/node_modules/@polymer/polymer/polymer-element.js';
// import '/node_modules/@vaadin/vaadin-dialog/vaadin-dialog.js';
import {Dazzle} from '/node_modules/@dazzle/dz-dazzle/dz-library.js';
import './change-user-tag.js';
class dzElm extends PolymerElement {
  static get properties () {
    return {
        "query": {
            "type": Object
        }
    };
  }

  constructor() {
    super();
    Dazzle.uid = "change";
    let loc = location.search;
    loc = loc.substring(1);
    this.token = loc;

    let key,token;
  
    this.userManager = new DataPackage("_user");
    this.tokenManager = new DataPackage("token");
    console.log('Token',this.token);


    this.innerHTML = `   
    <div class="rateit" data-rateit-mode="font"  style="font-size:50px">
    </div>`;


  }
  ready() {
      super.ready();
      this.tokenManager.getDataByCache(this.token).then(json=>{
        console.log('Token',this.token,json);
        this.id = json['email'];
        let userTag = document.createElement('change-user-tag');
        userTag.id = this.id;
        this.shadowRoot.querySelector('#a1').appendChild(userTag);

    });
      // For Star initialization
    //   $('#star1').starrr({
    //     change: function(e, value){
    //       if (value) {
    //         $('.your-choice-was').show();
    //         $('.choice').text(value);
    //       } else {
    //         $('.your-choice-was').hide();
    //       }
    //     }
    //   });

    $('.rateit').rateit();

      console.log("Ready here:");
      let that = this;
      let shadow = this.shadowRoot;

    //   //*************Get value from rating stars************//
    //   shadow.querySelectorAll('.rates').forEach((item) => {
    //       item.addEventListener('click', (e) => {
    //           this.userRate = item.value;
    //       });
    //   });
      console.log('JSON',this.token);
}

_submit() {
    let that = this;
    let shadow = this.shadowRoot;

    this.userRate = document.querySelector('.rateit-range').getAttribute('aria-valuenow') || 0;
    console.log('User Rate',this.userRate,this.token);

    
    Dazzle.decryptToken(this.token).then(json=>{
        console.log('JSON',json);
        this.userManager.getDataByCache(json['email']).then(res=>{
                console.log('Rating User',res);
                if (!res['numberRate']) {
                    res['numberRate']  = 0;
                    res['score'] = 0;
                }
                res['score'] += this.userRate;
                res['numberRate']++;
                console.log('Rating User',res);
                this.userManager.saveDataWithCache(res['id'],res);
                this.tokenManager.removeData(this.token);
                alert('已評分');
               location.href="/index.html";
        },err=>{
            alert('已評分, 或評分過期');
            location.href="/index.html";
        });
    });



}
  static get template () {
    // Template getter must return an instance of HTMLTemplateElement.
    // The html helper function makes this easy.
    return html`
    <style>
    #container {
        /* height: 500px; */
    }

    #a1 {
        margin-top: 40px;
    }

    p {
        font-family: sans-serif, Microsoft JhengHei;
        color: black;
    }

    #container {
        text-align: center;
    }

    .head {
        height: 75px;
    }

    .rate {
        font-family: sans-serif, Microsoft JhengHei;
        color: white;
        font-size: 15px;
        background-color: red;
        border: 1px solid red;
        border-radius: 3px;
        padding: 15px 125px;
        margin-bottom: 40px;
    }

    /* fieldset,
    label {
        margin: 0;
        padding: 0;
    } */

    h1 {
        font-size: 1.5em;
        margin: 10px;
    }

    /****** Style Star Rating Widget *****/

    .rating {
        border: none;
        /* float: left; */
        width: 280px;
        margin: 0 auto;
    }

    .rating>input {
        display: none;
    }

    .rating>label:before {
        margin: 5px;
        font-size: 3em;
        font-family: FontAwesome;
        display: inline-block;
        content: "\f005";
    }

    .rating>.half:before {
        content: "\f089";
        position: absolute;
    }

    .rating>label {
        color: #ddd;
        float: right;
    }

    /***** CSS Magic to Highlight Stars on Hover *****/

    .rating>input:checked~label,
    /* show gold star when clicked */
    .rating:not(:checked)>label:hover,
    /* hover current star */
    .rating:not(:checked)>label:hover~label {
        color: red;
    }

    /* hover previous stars in list */

    .rating>input:checked+label:hover,
    /* hover current star when changing rating */
    .rating>input:checked~label:hover,
    .rating>label:hover~input:checked~label,
    /* lighten current selection */
    .rating>input:checked~label:hover~label {
        color: #FFED85;
    }
    #a1{
        width:150px;
        display:block;
        margin:0 auto;
    }
</style>
<style include="icon-styles"></style>
<div id="container">
    <div id="a1">
    </div>
    <p style="font-weight: bold;">喜歡賣家服務嗎?</p>
    <p>點一下星星來在Get Change 評分</p>
    <slot></slot>


    <fieldset class="rating">
        <input class="rates" type="radio" id="star5" name="rating" value="5" /><label class="full" for="star5"
            title="5分"></label>
        <input class="rates" type="radio" id="star4half" name="rating" value="4.5" /><label class="half"
            for="star4half" title="4.5分"></label>
        <input class="rates" type="radio" id="star4" name="rating" value="4" /><label class="full" for="star4"
            title="4分"></label>
        <input class="rates" type="radio" id="star3half" name="rating" value="3.5" /><label class="half"
            for="star3half" title="3.5分"></label>
        <input class="rates" type="radio" id="star3" name="rating" value="3" /><label class="full" for="star3"
            title="3分"></label>
        <input class="rates" type="radio" id="star2half" name="rating" value="2.5" /><label class="half"
            for="star2half" title="2.5分"></label>
        <input class="rates" type="radio" id="star2" name="rating" value="2" /><label class="full" for="star2"
            title="2分"></label>
        <input class="rates" type="radio" id="star1half" name="rating" value="1.5" /><label class="half"
            for="star1half" title="1.5分"></label>
        <input class="rates" type="radio" id="star1" name="rating" value="1" /><label class="full" for="star1"
            title="1分"></label>
        <input class="rates" type="radio" id="starhalf" name="rating" value="0.5" /><label class="half"
            for="starhalf" title="0.5分"></label>
    </fieldset>
    <button on-click="_submit" class="rate">評分</button>
</div>

<div id="container">

</div>
    `;
  }
}

// Register the element with the browser.
customElements.define('change-ratings', dzElm);

