
import { PolymerElement, html } from 'https://d25k6mzsu7mq5l.cloudfront.net/node_modules/@polymer/polymer/polymer-element.js';
import 'https://d25k6mzsu7mq5l.cloudfront.net/node_modules/@vaadin/vaadin-dialog/vaadin-dialog.js';
import {Dazzle} from 'https://d25k6mzsu7mq5l.cloudfront.net/node_modules/@dazzle/dz-dazzle/dz-library.js';
import './change-webcom.js';
import './change-picslide.js';
import './change-orderlist-storage.js';
import './change-order-list.js';
import './change-edit-bar.js';
import './change-user-tag.js';



Dazzle.loadStyle("https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.4.2/jquery.fancybox.min.css");
Dazzle.loadScript("//code.jquery.com/jquery-3.2.1.min.js");
Dazzle.loadScript("https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.4.2/jquery.fancybox.min.js");



class dzElm extends PolymerElement {
  static get properties () {
    return {
        "id": {
            "type": String
        },
        "uid": {
            "type": String
        }


    };
  }

  constructor() {
    super();
    console.log("Entered Created");
    // call close pop-up in change-confirm
    document.addEventListener('close-item-dialog', e => {
        this.shadowRoot.querySelector('vaadin-dialog').opened = false;
        // console.log("(Btn) close successfully");
    });

    let user = store.get('change-user') || null;
    this.user = user;
    if (user)
        this.fileManager = new AwsPackage(user);

    this.dataManager = new DataPackage('product');
    this.userManager = new DataPackage('_user');
    this.orderManager = new DataPackage('order');
    // this.generateToken();
  }
  ready() {
      super.ready();
      let div0 = this.shadowRoot.querySelector('#div0');
      let div1 = this.shadowRoot.querySelector('#div1');
      let div2 = this.shadowRoot.querySelector('#div2');
      let div3 = this.shadowRoot.querySelector('#div3');
      let div4 = this.shadowRoot.querySelector('#div4');
      $(div0).fancybox();
      $(div1).fancybox();
      $(div2).fancybox();
      $(div3).fancybox();
      $(div4).fancybox();
      console.log("Entered Ready");
      let loc = location.search;
      let pid = "";
      let posit = 0;
      // for (i = 2; i < loc.length; i++) {
      //     pid += loc[i]
      // };
if (window.location.hash)
    pid = window.location.hash.substring(1);
else
      pid = document.head.querySelector('meta[name=product-id]').getAttribute('content') || null;

      console.log('Hash',window.location.hash);
    console.log('PID',pid);
      //For testing call SELLER from webcom
      // this.SELLER = pid;

      let that = this;
      let shadow = this.shadowRoot;
      console.log("good123123");
      this.loadProduct(pid).then(prod => {
          console.log('Product', prod);
          this.uid = prod['ownerId']
          this.initProduct(prod);
      }, err => {
          alert('不能載入資料');
      });



}


initProduct(prod) {
    let that = this;
    let shadow = this.shadowRoot;

    this.product = prod;
    console.log('Product',this.product);
    // let a = res.resolve['price'];
    // shadow.querySelector('#aaa').innerHTML = "$" + a;
    if (!this.product['pics']) {} else {
        if (!Array.isArray(this.product['pics']))
            this.product['pics'] = [this.product['pics']];

        for (let qwe = 0; qwe < this.product['pics'].length; qwe++) {
            if (this.product['pics'][qwe]) {
                shadow.querySelector('#div' + qwe).style.backgroundImage = 'url(' + this.product['pics'][qwe] + ')';
                shadow.querySelector('#div' + qwe).style.visibility = "visible";
                shadow.querySelector('#div' + qwe).setAttribute('data-animation-effect',true);
                shadow.querySelector('#div' + qwe).setAttribute('href',this.product['pics'][qwe]);
            }
        }
    }



    if (prod.isFanpage || prod.isFanpage == true) {

    }
    that.timeStr = that.loadUpdate(prod.createTime);
    this.loadTags();
    // shadow.querySelector('.unib').innerHTML = this.product['description'];
    // shadow.querySelector('.deliveryDesc').innerHTML = this.product['deliveryDesc'];
    this.loadOwner();

    // if (this.product[''])

    // if (this.user) {
        let orderList = document.createElement('change-orderlist-storage');
        orderList.orders = this.product['replyArray'];
        this.product['replyArray'].forEach(item => {
            console.log('Order Item',item); 
            let listItem = document.createElement('change-order-list');
            listItem.id = item;
            listItem.product = this.product;
            listItem.setAttribute('id', item);
            orderList.appendChild(listItem);
        });
        if (this.product['replyArray'].length>0)
           shadow.appendChild(orderList);

    // }
}
loadProduct(pid) {
    let that = this;
    return new Promise(function(resolve, reject) {
        that.dataManager.getDataByCache(pid).then(res=>{
                resolve(res);
        },err=>{
            reject();
        });
    });


}
_findseller() {
    let user = store.get('change-user') || null;
    loc = location.search;
    let posit = 0;
    let pid = "";
    for (i = 2; i < loc.length; i++) {
        pid += loc[i];
    };
    let uid = this.uid;
    //**NEW USERS USE "id"
    // console.log("CURRENT UID (new users)", user['id']);
    //**OLD USERS USE "_id"
    // console.log("CURRENT UID (old users", user['_id']);

    console.log("CURRENT PRODUCT OWNER", uid);
    if (user == null) {
        alert("請先登入!");
    } else if (user['id'] == uid) {
        alert("不能留言自己貨物!");
    } else {
        console.log('contacting seller');
        let shadow = this.shadowRoot;
        let that = this;
        let popup = document.createElement('change-webcom');
        popup.seller = this.owner;
        popup.product = this.product;
        popup.dialog = this.shadowRoot.querySelector('vaadin-dialog');
        Dazzle.componentPopup(popup, '500px', '800px');

        // Dazzle.popup(dialog, "change", "change-webcom", "500px", "400px");
        console.log("end process in contact seller");
    }
}
componentPopup(component, width, height) {
    let dialog = this.shadowRoot.querySelector('vaadin-dialog#seller');
    // let dialog = Dazzle.dialog;
    // let dialog = document.querySelector('vaadin-dialog');
    dialog.renderer = function(root, dialog) {
        // root.innerHTML = '<' + component + '></' + component + '>';
        if (root.firstElementChild) {
            return;
        }
        root.appendChild(component);
    };

    dialog.resizable = true;
    dialog.resize(width, height);
    dialog.opened = true;
    // Dazzle.activeDialog = dialog;   

}
loadImages(imgs) {

}

loadTags() {
    let shadow = this.shadowRoot;

    try{
        //get and pass tag data
        let itemtag = "";
        let tags = document.createElement('div');
        for (var count = 0; count < this.product['tags'].length; count++) {
            let button = document.createElement('button');
            button.setAttribute('id', 'tagbutton');
            let a = document.createElement('a');
            a.setAttribute('href', '/list-product.html?tag=' + this.product['tags'][count]);
            a.innerHTML = this.product['tags'][count];
            button.appendChild(a);
            tags.appendChild(button);
            // itemtag += '<button id=\"tagbutton\">' + '<a href="list-product.html?tag=' + encodeURIComponent(res.resolve['tags'][count]) + '">' + res.resolve['tags'][count] + "</a></button>";
        }
        console.log('Tag', tags);
        shadow.querySelector('#t').innerHTML = tags.innerHTML;
    }catch(e){
        shadow.querySelector('#t').innerHTML ='';
    }

}


loadOrder(pid) {
    let that = this;
    return new Promise(function(resolve, reject) {
        that.orderManager.getDataByCache(pid).then(res=>{
            resolve(res);
        });
    });


}
loadUser(userId) {
    
    let that = this;
    let shadow = this.shadowRoot;
    this.userManager.getDataByCache(userId).then(res=>{
        that.owner = res;
        that.username = that.owner['username'];
        if (res['alias'])
            that.userAlias = '/user/'+res['alias'];
        else    
            that.userAlias = '/user.html?'+res['id'];
        shadow.querySelector('change-user-tag').loadData(res['id'],res['createTime']);
    });


}
loadPage(pageId) {
    let that = this;
    this.userManager.getDataByCache(pageId).then(res=>{
        that.owner = res;
        that.username = that.owner['pagename'];
       
    });
}
loadOwner() {
    let o = this.product['ownerId'];
    let isFanpage = this.product['isFanpage'] || null;
    // console.log('is Fan Page', isFanpage);
    if (!isFanpage || isFanpage == false)
        this.loadUser(o);
    else
        this.loadPage(o);

}
loadUpdate(time) {
    let _thetimenow = Date.now();
    let comparetime = (_thetimenow - time) / 1000;
    if (comparetime < 60) {
        return "剛剛";
    } else if (comparetime / 60 < 60) {
        return Math.floor(comparetime / 60) + "分鐘前";
    } else if (comparetime / 60 / 60 < 24) {
        return Math.floor(comparetime / 60 / 60) + "小時前";
    } else if (comparetime / 60 / 60 / 24 < 7) {
        return Math.floor(comparetime / 60 / 60 / 24) + "日前";
    } else if (comparetime / 60 / 60 / 24 / 7 < 30) {
        return Math.floor(comparetime / 60 / 60 / 24 / 7) + "星期前";
    } else if (comparetime / 60 / 60 / 24 / 7 / 30 < 365) {
        return Math.floor(comparetime / 60 / 60 / 24 / 30) + "月前";
    }
}
  static get template () {
    // Template getter must return an instance of HTMLTemplateElement.
    // The html helper function makes this easy.
    return html`
    <style>
    * {
        color: black;
        font-family: sans-serif, Microsoft JhengHei;
    }

    vaadin-dialog[part="content"] {
        padding: 0px;
        overflow: hidden;
    }

    hr {
        max-width: 100px;
        margin-left: 0;
        margin-bottom: 10px;
    }

    ul {
        display: flex;
        margin-bottom: 0px;
    }

    li {
        list-style: none;
    }

    .top-banner {
        margin-right: 1%;
        background: #FFE9BF;
        background-repeat: no-repeat;
        background-size: contain;
        
    }

    #banner3 {
        width: 100%;
        height: auto;
        display: block;
    }

    .change-new-product-container {
        display: grid;
        grid-template-columns: 1fr 0.8fr;
        height: auto;
        margin: 0 auto;
        background: white;
        width: 92.5%;
        border: solid 1px #ccc;
    }

    button {
        cursor: pointer;
    }

    .buttons button {
        padding: 3px;
        margin-top: 20px;
    }

    #upload {
        border-radius: 0;
        padding: 8px;
        float: right;
        margin-top: 30px;
        min-block-size: fit-content;
        border: 1px solid #ccc;
        width: 22%;
        height: 40px;
        background-color: white;
    }

    .u {
        margin-right: 0;
    }

    .outer {
        margin: 0;
        width: 100%;
        background-image: url("https://www.gettv.hk/img/background/3.jpg");
        padding-bottom: 50px;
    }

    .left-pics {
        border-right: none;
        padding: 50px 10% 0 10%;
        height: auto;
        width: 80%;
    }

    .right-product {
        padding-top: 50px;
        height: auto;
        padding-bottom: 50px;
    }

    .bigPic,
    #div0 {
        height: 450px;
        background-image: url("https://www.gettv.hk/img/nopic.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center center;
        border: 1px solid #ccc;
    }

    .consmall {
        display: grid;
        grid-template-columns: 22% 22% 22% 22%;
        grid-column-gap: 4%;
        margin-top: 30px;
        height: 100px;
    }

    #div1,
    #div2,
    #div3,
    #div4 {
        height: 95%;
        background-image: url("https://www.gettv.hk//img/nopic.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center center;
        border-style: solid;
        border: 1px solid #ccc;
        margin-top: 2px;
        visibility: hidden;

    }

    .fullWidth {
        width: 100%;
        margin-bottom: 20px;
        display: flex;
    }

    /* #head {
        background-image: url('./img/symbol/s5.png');
        width: 60px;
        height: 60px;
        background-size: cover;
        grid-column-start: 1;
        grid-column-end: 2;
        grid-row-start: 1;
        grid-row-end: 3;

    } */

    .yaqzaan {
        float: left;
    }

    svg.new {
        margin: 5px;
        height: 32px;
        width: 80px;
        border-radius: 2px;
        display: inline-block;
    }

    .store {
        font-size: 23px;
        display: inline-block;
        padding-top: 10px;
    }

    .dollar {
        font-size: 2em;
        margin-bottom: 20px;
    }


    #location {
        width: 30px;
        height: 30px;
        background-image: url('https://www.gettv.hk/img/icon/location.png');
        background-size: cover;
        display: inline-block;
    }

    .b1 {
        display: inline-block;
        margin-left: 10px;
    }

    #delivery {
        width: 30px;
        height: 30px;
        background-image: url('https://www.gettv.hk/img/icon/delivery.png');
        background-size: cover;
        display: inline-block;
    }

    .b2 {
        display: inline-block;
        margin-left: 10px;
    }

    .quan {
        font-size: 20px;
        display: inline-block;
    }

    .control {
        display: inline-block;
    }

    .storage {
        display: inline-block;
        font-size: 20px;
        margin-left: 10px;
    }

    #buy {
        background-color: lightcoral;
        width: 140px;
        height: 45px;
        border-radius: 3px;
        color: white;
        border: none;
        font-size: large;
    }

    #contact {
        background-color: grey;
        width: 140px;
        height: 45px;
        border-radius: 3px;
        color: white;
        border: none;
        font-size: large;
        margin-top: 52px;
    }
    #purchase {
        background-color: red;
        width: 140px;
        height: 45px;
        border-radius: 3px;
        color: white;
        border: none;
        font-size: large;
        margin-top: 52px;
    }

    .b3 {
        margin-top: 20px;
    }

    .bigsize {
        font-size: 25px;
        background-image: url('./img/');
        margin-top: 110px;
    }

    /* .sMes {
        margin-top: 15px;
    } */

    .tagContainer {}

    .tag {
        display: inline-block;
    }

    #tagbutton {
        border-radius: 8px;
        padding-left: 14px;
        padding-right: 14px;
        background: white;
        border: 2px solid #a7a7a7;
        color: #000;

    }

    a:link,
    a:visited {
        text-decoration: none;
        color: black;
    }

    a:hover {
        text-decoration: none;

    }

    .buttontag {
        display: inline-block;
    }

    .myButton {
        background: linear-gradient(to bottom, #ededed 5%, #dfdfdf 100%);
        background-color: #ededed;
        border-radius: 28px;
        border: 1px solid #dcdcdc;
        display: inline-block;
        cursor: pointer;
        color: black;
        font-family: Arial;
        font-size: 17px;
        padding: 0px 20px;
        text-decoration: none;
        text-shadow: 0px 1px 0px #ffffff;
    }

    .myButton:hover {
        background: linear-gradient(to bottom, #dfdfdf 5%, #ededed 100%);
        background-color: #dfdfdf;
    }

    .myButton:active {
        position: relative;
        top: 1px;
    }


    .userinfo {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        margin-bottom: 30px;
    }

    #usericon {
        display: flex;
    }

    #a1 {
        display: inline-block;
        font-size: 15px;
    }

    #a2 {
        display: inline-block;
        font-size: 15px;
        margin-left: 5px;
    }

    #a1 img {
        width: 40px;
        height: 40px;
        border-radius: 9999999999999px;
    }

    /* .user {
        width: 100px;
        height: 100px;
    } */

    #t1 {
        margin-left: 350px;
    }

    .myButton1 {
        box-shadow: inset 0px 1px 0px 0px #f29c93;
        background: linear-gradient(to bottom, #fe1a00 5%, #ce0100 100%);
        background-color: #fe1a00;
        border-radius: 3px;
        border: 1px solid #d83526;
        display: inline-block;
        cursor: pointer;
        color: #ffffff;
        font-family: Arial;
        font-size: 13px;
        padding: 6px 24px;
        text-decoration: none;
        text-shadow: 0px 1px 0px #b23e35;
    }

    .myButton1:hover {
        background: linear-gradient(to bottom, #ce0100 5%, #fe1a00 100%);
        background-color: #ce0100;
    }

    .myButton1:active {
        position: relative;
        top: 1px;
    }

    .deliveryDesc {
        margin-top: 20px;
    }

    @media only screen and (max-width: 768px) {
        .change-new-product-container {
            grid-template-columns: 100%;
        }

        .left-pics {
            width: 100%;
            margin-left: 0px;
            margin-right: 0px;
            padding-left: 0px;
            padding-right: 0px;
        }

        .right-product {
            width: 90%;
            padding: 20px;
        }
    }
</style>
<!-- <a data-fancybox="gallery" href="http://www.gettv.hk/img/WX20200513-110548@2x.png"><img src="http://www.gettv.hk/img/WX20200513-110548@2x.png"></a> -->
<div class="top-banner">
    <img id="banner3" src="http://www.gettv.hk/img/WX20200513-110548@2x.png" data-animation-effect="true" href="http://www.gettv.hk/img/WX20200513-110548@2x.png">
    <!-- ./img/WX20200513-110548@2x.png -->
</div>

<!-- <div>
    <ul>
        <li><span>主頁 / </span></li>
        <li><span>家居生活 / </span></li>
        <li><span>家居 / </span></li>
        <li><span>儲物 / </span></li>
    </ul>
</div> -->

<change-edit-bar></change-edit-bar>

<div class="outer">
    <div class="change-new-product-container">
        <div class="left-pics">
            <!-- input pictures -->
            <div class="bigPic" id="div0"></div>
            <div>

                <!-- GG get Array Pic from Database -->
                <div class="consmall" on-click="_test">
                    <div>
                        <div id="div1"></div>
                    </div>
                    <div>
                        <div id="div2"></div>
                    </div>
                    <div>
                        <div id="div3"></div>
                    </div>
                    <div>
                        <div id="div4"></div>
                    </div>
                </div>
            </div>
            <!-- <vaadin-dialog id="picslide"></vaadin-dialog> -->
        </div>

        <div class="right-product">
            <div class="fullWidth">
                <div class="yaqzaan" style="display: inline-block;">
                    
                    <template is="dom-if" if="{{product.isNew}}">
                        <svg class="new">
                        <polygon points="0,0 80,0 60,32 0,32" style="fill:#ebbd35;stroke:#ebbd35;stroke-width:0"></polygon><text x="6" y="23" fill="white" id="isNew" >全新</text>
                            </svg>
                    </template>

<template is="dom-if" if="{{!product.isNew}}">
                            <svg class="new">
                                <polygon points="0,0 80,0 60,32 0,32" style="fill:#7cd3da;stroke:#7cd3da;stroke-width:0"></polygon><text x="6" y="23" fill="white" id="isNew" >二手</text>
                            </svg>
                      </template>
</div>

<div style="display: inline-block;">
<span id="pn" class="store">{{product.productname}}</span>
</div>
</div>
<change-user-tag id$="{{product.ownerId}}"></change-user-tag>
<!-- <a id="userSite" href$="{{userAlias}}">
<div class="userinfo">
    <div id="usericon">
        <div id="a1">
            <img class="head" src$="{{owner.head}}">
        </div>
        <div id="a2">
            <div class="name" id="owner">{{username}}</div>
        </div>
    </div>
</div>
</a> -->



<div class="dollar" id="aaa"><span>$</span>{{product.price}}</div>

<hr>

<div>
<div id="location"></div>
<p id="dis" class="b1">

    {{product.district}}
</p>
</div>
<div>
<div id="delivery"></div>
<p id="dm" class="b2">
    {{product.deliveryMethod}}
</p>
</div>
<hr>
<br>
<template is="dom-if" if="{{!product.isPurchase}}">
<button id="contact" on-click="_findseller">聯絡賣家</button>
</template>
<template is="dom-if" if="{{product.isPurchase}}">
<button id="purchase">已出售</button>
</template>
<vaadin-dialog id="seller"></vaadin-dialog>

<div class="b3">刊登於 {{timeStr}}</div>
<br>

<div class="bigsize">
<span>產品資料:</span>
</div>
<br>
<div class="unib">
{{product.description}}
</div>
<br>

<div class="tagContainer">
<div class="tag">
    <span> 標籤： </span>
</div>
<div class="buttontag">
    <div id="t"></div>
</div>
</div>
<br>
<hr>

<div>
<span class="bigsize">運輸：</span>
<div class="deliveryDesc">
    {{product.deliveryDesc}} </div>


</div>
<br>
</div>

</div>
</div>

    `;
  }
}

// Register the element with the browser.
customElements.define('change-new-product', dzElm);





