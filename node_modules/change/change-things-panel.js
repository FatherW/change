import { PolymerElement, html } from 'https://d25k6mzsu7mq5l.cloudfront.net/node_modules/@polymer/polymer/polymer-element.js';
import 'https://d25k6mzsu7mq5l.cloudfront.net/node_modules/@vaadin/vaadin-dialog/vaadin-dialog.js';
import { Dazzle } from 'https://d25k6mzsu7mq5l.cloudfront.net/node_modules/@dazzle/dz-dazzle/dz-library.js';
// import 'change/change-status';


class dzElm extends PolymerElement {
    static get properties() {
        return {
            ownerid: {
                type: String,
                value: false,
                notify: true,
                reflectToAttribute: true
              },
              pid: {
                type: String,
                value: false,
                notify: true,
                reflectToAttribute: true
              },
        };
    }

    constructor() {
        super();
        this.user = store.get('change-user') || null;

    }

    _deleteproduct() {
        let that = this;
        let shadow = this.shadowRoot;
        let dialog = shadow.querySelector('#tempqqq' + this.id);
        Dazzle.loadComponent('change', 'change-confirm');
        Dazzle.popup(dialog, "change", "change-confirm", "30%", "200px");
    }



    showOrHide(bool){
        if (bool)
            this.shadowRoot.querySelector('#admin_panel').style.display="block";
        else
            this.shadowRoot.querySelector('#admin_panel').style.display="none";
        
    }
    attributeChangedCallback(name, oldValue, newValue){
      
        // console.log('Show',this.ownerId,this.user.id);
        try {
            this.ownerId = this.getAttribute('ownerid') || false;
            let id = String(this.user.id) || null;
            if (this.user.isAdmin)
                this.showOrHide(true);
            else if (this.ownerId === id)
                this.showOrHide(true);
            else
                this.showOrHide(false);
        } catch(e){
            this.showOrHide(false);
        }
    }
    ready() {
        super.ready();
        // this.ownerId = this.getAttribute('ownerid') || false;



    }
    isShow(user, product) {
        try {
            let ownerId = product['ownerId'];

            if (user.isAdmin)
                this.isEdit = true;
            else if (user.id == ownerId)
                this.isEdit = true;
            else {
                let userId = String(user.id);

                this.dataManager.getDataByCache(ownerId).then(res => {
                        console.log('Admin', res, res.isFanpage, res.fansAdmin.indexOf(userId), userId);
                        if (res.isFanpage && res.fansAdmin.indexOf(userId) > -1)
                            this.isEdit = true;
                        else
                            this.isEdit = false;

                    },
                    err => {
                        console.log('Admin false');
                        this.isEdit = false;
                    });
            }

        } catch (e) {
            this.isEdit = false;
        }

        console.log('Is show edit bar', this.isEdit);

        /*
                if (user)
                    if(res.ownerId == user['id'] || user.isAdmin == true){
                        shadow.querySelector('#tbar').style.display = "block";
                    }

                    */
    }
    generateNewId() {
        let no = new Date().getTime() % 10000;
        let str;
        this.fileManager.listFile('product/').then(res => {
            this.newId = String(no) + String(res.length + 1);
        });
    }

    reAlias() {
        let alias = this.product['productname'];
        alias = alias.replace(/^\s+|\s+$/gm, '')
        alias = alias.replace(/ /gm, '-');
        alias = alias.replace(/\//gm, '-');

        this.prodManager.matchData({ "productname": this.product['productname'] }).then(res => {
            if (res.length > 1)
                this.product['alias'] = alias + res.length;
            else
                this.product['alias'] = alias;

            console.log('Change Alias');
        });
    }

    _edit() {
        let user = Dazzle.subUser;

        // store.set('new-product-id',this.id); 
        Dazzle.loadChangeComponent('change', 'change-add-product');

        let product = this.product;
        store.set('new-product-id', product['id']);
        let dzPopup = document.createElement('change-add-product');
        dzPopup.product = this.product;
        dzPopup.dialog = this.dialog;
        Dazzle.componentPopup(dzPopup, '95%', '95%');

        // store.set('new-product',product);
        // location.replace("/add-product.html");

    }
    _delete() {
        //GET USER ID
        let user = store.get("change-user") || null;
        let tempid = user['_id'];

        this.prodManager.removeData(this.id).then(res => {
            console.log("check:", res.code);
            if (res.code > 0) {
                //alert("STATUS: DELETE SUCCESSFUL");

                alert('已刪除貨品');
                location.replace("/index.html");
            } else {
                alert("不能刪除貨品");
            }
        });

    }

    _copy() {

        //GENERATE UNIQUE TIME AS PRODUCT ID
        let a = Date.now();
        let user = Dazzle.subUser;


        let product = this.product;


        product['id'] = this.newId;
        product['ownerId'] = user['id'];
        product['postStatus'] = false;
        store.set('new-product-id', product['id']);
        this.prodManager.saveDataWithCache(product['id'], product);


        // store.set('new-product-id',this.id); 
        Dazzle.loadChangeComponent('change', 'change-add-product');

        // let product = this.product;
        // store.set('new-product-id',product['id']);

        let dzPopup = document.createElement('change-add-product');
        dzPopup.dialog = this.dialog;
        dzPopup.product = product;
        Dazzle.componentPopup(dzPopup, '95%', '95%');



        // store.set('new-product',product);
        // location.replace("/add-product.html");



    }

    savejson(x, y, z) {
        let that = this;
        let user = store.get('change-user') || null;
        this.fileManager = new AwsPackage(user);

        // console.log("omg1:", x);
        // console.log("omg2:", y);
        // console.log("omg3:", z);

        this.fileManager.saveFile('json/product-' + y + '.json', JSON.stringify(x)).then(res => {
            location.replace("./add-product.html?p" + y + "u" + z);
            // console.log("save copy JSON success!");
        });

    }
    static get template() {
        // Template getter must return an instance of HTMLTemplateElement.
        // The html helper function makes this easy.
        return html `
        <style include="main-style"></style>
        <style>
        * {
            color: black;
            font-family: sans-serif, Microsoft JhengHei;
        }

        header {
            background-image: url(./img/background/3.jpg);
            padding-top: 30px;
        }

        #tbar {
            display:block;
            background: #F0F0F0;
            width: 92.5%;
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 30px 0;
        }

        .containerB {
            display: flex;
            width: 90%;
            margin: 0 auto;
            justify-content: space-between;
        }

        #edit {
            width: 100px;
            height: 35px;
            border: 1px solid #ccc;
            background-color: white;
            margin-right: 50px;
        }

        button {
            cursor: pointer;
            font-family: sans-serif, Microsoft JhengHei;
            font-size: 15px;
            width: 100px;
            height: 35px;
        }

        .buttonL {
            display: flex;
        }

        #copy {
            background-color: grey;
            border: none;
            color: white;
        }

        #delete {
            background-color: grey;
            border: none;
            color: white;
            margin-left: 50px;
        }

        @media only screen and (max-width: 992px) {}

        @media only screen and (max-width: 640px) {
            #edit {
                width: 60px;
                margin-right: 10px;
                border: none;
            }

            .buttonR button {
                width: 60px;
            }

            #delete {
                margin-left: 10px;
            }
        }
        #admin_panel iron-icon{
            float:right;
        }
        #admin_panel iron-icon:hover{
            color:orange;
        }
    </style>
    <vaadin-dialog></vaadin-dialog>
        <div id="admin_panel" style="display:none;">
            <iron-icon icon="close" on-click="_deleteproduct"></iron-icon>
        </div>
    `;
    }
}

// Register the element with the browser.
customElements.define('change-things-panel', dzElm);