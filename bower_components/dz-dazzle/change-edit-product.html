<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-text-field/vaadin-email-field.html">
<link rel="import" href="../vaadin-text-field/vaadin-password-field.html">
<link rel="import" href="../vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../vaadin-text-field/vaadin-number-field.html">
<link rel="import" href="../vaadin-select/vaadin-select.html">
<link rel="import" href="../paper-tags-input/paper-tags-input.html">
<link rel="import" href="../vaadin-button/vaadin-button.html">

<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">

<link rel="import" href="../change/change-dropzone-file.html">



<link rel="stylesheet" href="">
<link href="../dz-menu/css/style.html" rel="import" />


<dom-module id="change-edit-product">

    <template>
        <style include="icon-styles"></style>
        <style>
            hr {
                max-width: 100px;
                margin-left: 0;
                margin-bottom: 10px;
            }

            .change-new-product-container {
                display: grid;
                grid-template-columns: 50% 45%;
                margin-bottom: 100px;
                margin-left: 50px;
            }

            #tbar {
                display: flex;
                justify-content: space-between;
                margin-top: 80px;
                margin-left: 49px;
            }

            .custom-select select {
                width: 120px;
                padding: 3px;

            }

            #first {
                padding: 5px;
                margin-right: 25px;
            }

            .checkbox {
                margin-top: 22px;
            }

            :host([theme~="custom"][checked]) [part="checkbox"] {
                background-color: green;

            }

            #firstlabel {
                margin-right: 25px;
            }

            .buttons{
                margin-right: 73px;
            }

            .buttons button {
                padding: 3px;
                margin-top: 20px;
            }

            #upload {
                border-radius: 0;
                padding: 7px;
                float: right;
            }

            #save {
                background-color: #FF6B66;
                padding: 10px;
                margin-right: 25px;
            }

            #post {
                background-color: #ff8262;
                padding: 10px;
            }

            .left-pics {
                width: 90%;
                height: 450px;
                background-color: white;
                margin-top: 30px;
                margin-left: 10px;
                border-style: solid;
                border-color: grey;
            }

            .right-product {
                width: 100;
                height: 1050px;
                background-color: white;
                margin-top: 30px;
                margin-left: 30px;
            }

            .bigPic {
                height: 96%;
                background-image: url(http://change.dazzle.website/Website%20Design/product%20page/img/product%20preview/001.jpg);
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center center;
                margin-top: 1.5%;
                margin-bottom: 2%;
            }

            .consmall {
                display: grid;
                grid-template-columns: 22% 22% 22% 22%;
                grid-column-gap: 4%;
                margin-top: 40px;
                height: 100px;
            }

            #div1,
            #div2,
            #div3,
            #div4 {
                height: 96%;
                background-image: url(http://change.dazzle.website/img/item/1.jpg);
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center center;
                border-style: solid;
                border-color: grey;
                margin-top: 2px;

            }

            .fullWidth {
                width: 100%;
                margin-bottom: 10px;
                display: flex;
            }

            input[type=text] {
                width: 300%;
                padding: 10px 21px;
                margin-left: 15px;
                display: inline-block;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }

            #pname {
                margin-top: 4px;
                width: 241%;
            }

            #price {
                width: 63%;
            }

            #pdes {
                margin-left: 0px;
                width: 100%;
                padding-bottom: 25%;
            }

            #trans {
                width: 100%;
                margin-left: 0px;
                margin-bottom: 50px;
                padding-bottom: 25%;
            }

            #head {
                background-image: url(http://change.dazzle.website/img/symbol/s5.png );
                background-size: contain;
                background-repeat: no-repeat;
                width: 40px;
                height: 40px;
                background-size: cover;
                grid-column-start: 1;
                grid-column-end: 2;
                grid-row-start: 1;
                grid-row-end: 3;
                margin-right: 10px;
            }

            #cs1 {
                width: 60px;
                height: 38px;
                padding: 5px;
                font-size: 13px;
            }

            #cs1 option {
                font-size: 13px;
            }

            .checked {
                color: orange;
            }

            .userinfo {
                display: flex;
                justify-content: space-between;
                margin-top: 20px;
            }

            .hkd {
                margin-top: 30px;
                margin-bottom: 20px;
            }

            .loca {
                margin: 20px 0 20px 0;
            }

            .del {
                margin-bottom: 20px;
            }

            #r1 {
                display: flex;
            }

            #edit {
                width: 90px;
                height: 35px;
                margin-right: 5px;
            }

            #location {
                width: 30px;
                height: 30px;
                background-image: url(http://change.dazzle.website/img/icon/location.png);
                background-size: cover;
                display: inline-block;
                margin-top: 15px;
            }

            #delivery {
                width: 30px;
                height: 30px;
                background-image: url(http://change.dazzle.website/img/icon/delivery.png);
                background-size: cover;
                display: inline-block;
                margin-top: 15px;
            }


            .bigsize {
                font-size: 25px;
                background-image: url(http://change.dazzle.website/img/);
                margin-top: 70px;
            }

            .tag {
                display: inline-block;
                margin-top: 10px;
            }

            .u {
                float:right;
            }

        </style>
        <style>
            /* 父元素，因为~符号只能匹配下面的兄弟节点，所以使用弹性盒的倒序改变五角星的排列方式 */
            .box {
                width: 266px;
                height: 27px;
                margin: 0 auto;
                display: flex;
                flex-direction: row-reverse;
                justify-content: space-between;
            }

            /* 隐藏单选 */
            input {
                display: none;
            }

            /* 五角星默认样式 */
            input[type="radio"]+label>svg>path {
                d: path("M27.500,1.501 L36.069,16.899 L53.497,20.217 L41.365,33.051 L43.567,50.499 L27.500,43.032 L11.433,50.499 L13.635,33.051 L1.503,20.217 L18.931,16.899 L27.500,1.501 ");
                stroke-width: 1px;
                fill: none;
                stroke: #333;
            }

            /* 移入，点击选中的元素和下面的元素变为实心 */
            input[type="radio"]+label:hover>svg>path,
            input[type="radio"]+label:hover~input[type="radio"]+label>svg>path,
            input[type="radio"]:checked+label>svg>path,
            input[type="radio"]:checked~input[type="radio"]+label>svg>path {
                stroke-width: 0px;
                fill: #f00;
            }
        </style>

        <header>
            <div id="tbar">
                <div style="display: flex;">
                    <div style="margin-top: 11px; margin-left: 12px;">
                        <vaadin-select id="vs1" placeholder="選擇分類"></vaadin-select>
                    </div>
                    <div class="checkbox">
                        <!--check box, public-->
                        <vaadin-checkbox-group label="Label" theme="vertical" id="firstlabel"
                            style="margin-left: 50px;">
                            <vaadin-checkbox theme="custom" value="1" id="public">是否公開(専頁用)</vaadin-checkbox>
                        </vaadin-checkbox-group>
                        <!--check box, free-->
                        <vaadin-checkbox-group label="Label" theme="vertical">
                            <vaadin-checkbox theme="custom" value="1" id="free">是否免費</vaadin-checkbox>
                        </vaadin-checkbox-group>
                    </div>
                </div>

                <div class="buttons">
                    <button id="save" on-click="_saveData">儲存草稿</button>
                    <button id="post">發佈上架</button>
                </div>
            </div>
        </header>

        <div class="change-new-product-container">
            <div class="left-pics">
                <!-- 这里放图片 -->
                <div class="bigPic"></div>
                <div style="height: 100px;">
                    
                    <!-- GG get Array Pic from Database -->
                    <div class="consmall">
                        <div>
                            <div id="div1"></div>
                        </div>
                        <div>
                            <div id="div2"></div>
                        </div>
                        <div>
                            <div id="div3"></div>
                        </div>
                        <div>
                            <div id="div4"></div>
                        </div>
                    </div>
                    <div class="buttons u">
                        <button id="upload" on-click="_uploadFile">上載圖片</button>
                    </div>
                    <vaadin-dialog></vaadin-dialog>
                </div>
            </div>

            <div class="right-product">
                <!-- 这里放右边的产品资料 -->
                <div class="fullWidth">
                    <div class="custom-select">
                        <!-- <select id="cs1">
                            <option value="0">全新</option>
                            <option value="1">二手</option>
                        </select> -->
                        <vaadin-select id="vs4" placeholder="全新" style="width: 90px;"></vaadin-select>
                    </div>

                    <div>
                        <!--input box-->
                        <div class="inputbox">
                            <input type="text" id="pname" name="firstname" placeholder="輸入商品標題...">
                        </div>
                    </div>
                </div>
                <div class="userinfo">
                    <div id="r1">
                        <div id="head"></div>
                        <div>
                            <div id="username">yyyds</div>
                            <div id="ratings">
                                <span class="fa fa-star checked"></span>
                                <span class="fa fa-star checked"></span>
                                <span class="fa fa-star checked"></span>
                                <span class="fa fa-star"></span>
                                <span class="fa fa-star"></span>
                            </div>
                        </div>
                    </div>


                </div>
                <div class="hkd" style="display: flex;">
                    <div class="dollar" id="aaa"><b style="font-size: 30px; color: black;">HKD</b></div>
                    <!--input box-->
                    <div class="inputbox">
                        <input type="text" id="price" name="priceHKD" placeholder="輸入商品價錢...">
                    </div>
                </div>
                <hr>


                <div class="loca" style="display: flex;">
                    <div id="location"></div>
                    <!--selecting box-->
                    <!-- <div class="custom-select">
                            <select id="district" style="margin-left: 10px;">
                                <option value="0">選擇地區</option>
                                <option value="1">A</option>
                                <option value="2">B</option>
                                <option value="3">C</option>
                                <option value="4">D</option>
                                <option value="5">E</option>
                            </select> -->
                    <div style="margin-top: 11px; margin-left: 12px;">
                        <vaadin-select id="vs2" placeholder="選擇地區"></vaadin-select>
                    </div>
                </div>



                <div class="del" style="display: flex;">
                    <div id="delivery"></div>
                    <!--selecting box-->
                    <!-- <div class="custom-select">
                        <select id="method" style="margin-left: 10px;">
                            <option value="0">選擇發送方法</option>
                            <option value="1">A</option>
                            <option value="2">B</option>
                            <option value="3">C</option>
                            <option value="4">D</option>
                            <option value="5">E</option>
                        </select> -->
                    <div style="margin-top: 11px; margin-left: 12px;">
                        <vaadin-select id="vs3" placeholder="選擇發送方法"></vaadin-select>
                    </div>
                </div>

                <hr>



                <div class="">
                    <div style="margin-top: 20px; margin-bottom: 30px;"><span style="font-size: 20px;">產品描述:</span>
                    </div>
                    <!--typing box-->
                    <div class="inputbox">
                        <input type="text" id="pdes" name="productdescription" placeholder="輸入商品描述...">
                    </div>
                </div>

                <div style="display: flex; margin-top: 45px;">
                    <div class="tag">
                        <div><span style="font-size: 20px;"> 標籤： </span></div>
                    </div>

                    <!--input box-->
                    <!-- <div class="inputbox">
                        <input type="text" id="tagdes" name="tagdescription" placeholder="輸入標籤...">
                    </div> -->

                    <!--Henry version-->
                    <vaadin-text-field id="inputTags" on-keydown="_addTags"></vaadin-text-field>
                    <paper-tags-input width="100%" id="myTags"></paper-tags-input>

                </div>
                <hr>

                <div>
                    <div style="margin-top: 20px; margin-bottom: 30px;"><span class="bigsize">運輸：</span></div>
                    <!--input box-->
                    <div class="inputbox">
                        <input type="text" id="trans" name="transportation" placeholder="輸入物流資料...">
                    </div>

                </div>
                <br>
            </div>

        </div>
    </template>

</dom-module>

<script>


    //function for database
    (function () {
        Polymer({
            is: 'change-edit-product',
            properties: {
                "id": {
                    "type": String
                },

                "valueArray": {
                    "type": Array
                }
            },
            created: function () {


            },


            //Henery added//
            _addTags(e) {
                let myTags = this.shadowRoot.querySelector('#myTags');
                let val = this.shadowRoot.querySelector('#inputTags').value;
                console.log('Key Down', e);

                if (e.code === "Enter") {
                    myTags._addTag(val);
                    this.shadowRoot.querySelector('#inputTags').value = "";
                }
                //console.log("arrayResult:", myTags.tags);
            },

            ready: function () {

                this.valueArray = [""];
                let that = this;
                let shadow = this.shadowRoot;
                customElements.whenDefined('vaadin-select').then(function () {
                    const choice = [
                        { id: '車與地產', name: '車與地產' },
                        { id: '潮流生活', name: '潮流生活' },
                        { id: '家居生活', name: '家居生活' },
                        { id: '興趣與遊戲', name: '興趣與遊戲' },
                        { id: '工作與服務', name: '工作與服務' },
                        { id: '其他服務', name: '其他服務' }
                    ];
                    const district = [
                        { id: '中西區', name: '中西區' },
                        { id: '灣仔區', name: '灣仔區' },
                        { id: '東區', name: '東區' },
                        { id: '南區', name: '南區' },
                        { id: '油尖旺區', name: '油尖旺區' },
                        { id: '深水埗', name: '深水埗區' },
                        { id: '九龍城區', name: '九龍城區' },
                        { id: '黃大仙區', name: '黃大仙區' },
                        { id: '觀塘區', name: '觀塘區' },
                        { id: '葵青區', name: '葵青區' },
                        { id: '荃灣區', name: '荃灣區' },
                        { id: '屯門區', name: '屯門區' },
                        { id: '元朗區', name: '元朗區' },
                        { id: '離島區', name: '離島區' },
                        { id: '北區', name: '北區' },
                        { id: '大埔區', name: '大埔區' },
                        { id: '沙田區', name: '沙田區' },
                        { id: '西貢區', name: '西貢區' }
                    ];

                    const delmthod = [
                        { id: '順豐', name: '順豐' },
                        { id: '面對面交易', name: '面對面交易' },
                    ]

                    const status = [
                        { id: '全新', name: '全新' },
                        { id: '二手', name: '二手' },
                    ]

                    shadow.querySelector('#vs1').renderer = function (root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        choice.forEach(function (item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.id);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };

                    shadow.querySelector('#vs2').renderer = function (root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        district.forEach(function (item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.id);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };

                    shadow.querySelector('#vs3').renderer = function (root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        delmthod.forEach(function (item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.id);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };

                    shadow.querySelector('#vs4').renderer = function (root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        status.forEach(function (item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.id);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };
                });



                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";

                let param2 = {
                    "action": "getData",
                    "index": "change",
                    "type": "_user",
                    "id": "2"
                };

                console.log("JSON sent", param2);
                Polymer.postData(Url, param2).then(res => {

                    console.log("Result", res);
                    if (res.code > 0) {
                        let a = res.resolve['head'];
                        console.log("Head:", a);
                        shadow.querySelector('#head').style.backgroundImage = 'url(' + a + ')';
                        let c = res.resolve['username'];
                        console.log("Username", c);
                        shadow.querySelector('#username').innerHTML = c;
                    }
                });
            },
            _saveData: function () {
                let user = store.get("change-user") || null;
                if (user != null) {
                    console.log(user);
                    let that = this;
                    let shadow = this.shadowRoot;
                    //Get value from select box categories
                    var myselect = shadow.querySelector("#vs1");
                    var categories = myselect.value;
                    console.log("Category:", categories);
                    let public = shadow.querySelector('#public').checked;
                    console.log("Public:", public);
                    let free = shadow.querySelector('#free').checked;
                    console.log("Free:", free);
                    let pname = shadow.querySelector('#pname').value;
                    console.log("Productname:", pname);
                    let price = shadow.querySelector('#price').value;
                    console.log("Price:", price);
                    //Get value from select box district
                    var myselect = shadow.querySelector("#vs2");
                    var district = myselect.value;
                    console.log("District:", district);
                    //Get value from select box district
                    var myselect = shadow.querySelector("#vs3");
                    var method = myselect.value;
                    console.log("Method:", method);
                    let pdes = shadow.querySelector('#pdes').value;
                    console.log("Productdescription:", pdes);
                    //.tags is refering to the arrayValue
                    let tags = shadow.querySelector('#myTags').tags;
                    console.log("Tags:", tags);
                    let deldes = shadow.querySelector('#trans').value;
                    console.log("DeliveryDescription:", deldes);

                    //Get value from select box NewOld
                    var myselect = shadow.querySelector("#vs4");
                    var newOld = myselect.value;
                    console.log("New/Old:", newOld);
                    if (newOld == "二手") {

                        var no = Boolean(0);
                        console.log('Used', no);
                    } else {

                        var no = Boolean(1);
                    }
                    let p = {
                        "action": "searchData",
                        "index": "change",
                        "type": "product",
                        "body": {
                            "query": {
                                "match_all": {}
                            },
                        }
                    }
                    let x = 0;
                    let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";

                    Polymer.postData(Url, p).then(res => {
                        if (res.code > 0) {
                            x = res.resolve.length;
                        }
                    })
                    console.log("USer", user['id']);
                    console.log("X", x);

                    let params = {
                        "action": "addData",
                        "index": "change",
                        "type": "product",
                        "id": ++x,

                        "body": {
                            "categories": categories,
                            "isPublic": public,
                            "isFree": free,
                            "productname": pname,
                            "price": price,
                            "district": district,
                            "deliveryMethod": method,
                            "description": pdes,
                            "tags": tags,
                            "deliveryDesc": deldes,
                            "isNew": no,
                            "ownerId": user['id']
                        }
                    };
                    console.log("JSON", params);
                    Polymer.postData(Url, params).then(res => {
                        console.log("Result", res);
                        if (res.code > 0) {
                            alert("success!");
                        } else {
                            alert("Failed");
                        }
                    })
                }
                else {
                    alert("Please login first");
                }


            },

            _uploadFile: function () {
                console.log('upload');
                let shadow = this.shadowRoot;
                let that = this;
                let dialog = shadow.querySelector('vaadin-dialog');
                Polymer.popup(dialog, "change", "dropzone-file", "60%", "50%");
                // console.log('saved', bucket)
            }
        });
    })();
</script>