<link rel="import" href="../polymer/polymer-element.html">
<!-- <link rel="import" href="../dz-dazzle/dz-admin.html"> -->
<!-- <link rel="import" href="../dz-dazzle/dz-wrapper-head.html">
<link rel="import" href="../dz-dazzle/dz-wrapper-js.html"> -->

<!-- <link rel="import" href="../vaadin-dialog/vaadin-dialog.html"> -->
<!-- <link rel="import" href="dz-loader.html?id=sdsdfsdffsdf"> -->


<dom-module id="dz-wrapper">

</dom-module>

<script>
class dzWrapper extends Polymer.Element {
	static get is() {
          return 'dz-wrapper';
	}

	constructor() {
        super();
        this.uid = Polymer.uid;
        this.tid = Polymer.tid;
        this.thisPage = Polymer.thisPage;
    }

    getPath(nature,type){
        let url =
            "https://d25k6mzsu7mq5l.cloudfront.net/user-data/" + Polymer.uid + "/";
        
        console.log(url +
            "template/" +
            Polymer.tid +
            "/" +
            nature +
            "/" +
            type +
            "?id=" +
            new Date().getTime());

        let str = url +
            "template/" +
            Polymer.tid +
            "/" +
            nature +
            "/" +
            type +
            "?id=" +
            new Date().getTime();

        return str;
    }
    ready(){
        super.ready();
       

       

    }

    pageLoader(){
        console.log('DZ WRapper',Polymer.editMode);
        let bHead,mHead,bCss,mCss,bBodyJs,mBodyJs,html,elm,bodyClass;
        let basePath = "template/" + Polymer.tid + "/" + Polymer.thisPage ;
        let masterPath = "template/" + Polymer.tid + "/_master";

        console.log(Polymer.thisPage,this.getPath(Polymer.thisPage,'head'));
            this.innerHTML = '';
            if (document.querySelector('dz-wrapper-js'))
                document.querySelector('dz-wrapper-js').innerHTML = '';
            Promise.all([

                // Polymer.getUserDataContent(masterPath+'/css'),
                // Polymer.getUserDataContent(masterPath+'/css'),
                Polymer.getUserDataContent(basePath+'/body_js'),
                Polymer.getUserDataContent(masterPath+'/body_js'),
                Polymer.getUserDataContent(basePath+'/html'),
                Polymer.getUserDataContent(basePath+'/body_class'),     
                Polymer.getUserDataContent(basePath+'/head'),
                Polymer.getUserDataContent(masterPath+'/head'),
            ]).then(res=>{
                // bHead = res[0] || '';
                // mHead = res[1] || '';
                // bCss = res[2] || '';
                // mCss = res[3] || '';
                bBodyJs = res[0] || '';
                mBodyJs = res[1] || '';
                html = res[2]|| '';
                bodyClass = res[3] || '';
                bHead = res[4] ||'';
                mHead = res[5] || '';
                 let dzHead=window.document.createElement('dz-wrapper-head');
                dzHead.innerHTML = mHead+bHead;
                
                // elm = document.createRange().createContextualFragment(mHead+bHead);
                // console.log('Add Elm',mHead+bHead);
                // dzHead.appendChild(elm);
                document.head.appendChild(dzHead);

                this.innerHTML = html;
                // let dzWrapper = document.createElement('dz-wrapper');
                // dzWrapper.innerHTML = html;
                // document.body.appendChild(dzWrapper);
                document.body.setAttribute('class',bodyClass);

                if (Polymer.editMode==='admin'){
                    let dzAdmin = document.createElement('dz-admin');
                    document.body.appendChild(dzAdmin);

                    this.querySelectorAll('*').forEach(item=>{
                        new defaultPackage(item);
                    });
                    this.shadowHtml = this.innerHTML;
                    Polymer.shadowDOM = this.cloneNode(true);
                    document.addEventListener('save',e=>{
                        this.save();
                    });
                }


                let dzBody=document.createElement('dz-wrapper-js');
                elm = document.createRange().createContextualFragment(mBodyJs+bBodyJs);
                // dzHead.appendChild(elm);
                dzBody.appendChild(elm);
                document.body.appendChild(dzBody);               

            });

        }




    

    save=function(){
        let html;
        let dummy = Polymer.shadowDOM.cloneNode(true);
        dummy.querySelectorAll('[dzid]').forEach(item=>{
            item.removeAttribute('dzid');
        });
        html = dummy.innerHTML;
        
        let type = "html";
        let basePath =
            "template/" +
            this.tid +
            "/" +
            this.thisPage +
            "/" +
            type;
        console.log('Save',basePath,html);
        Polymer.fileManager.saveUserData(basePath, html);        
    }

    restore=function(){
        // document.querySelector('dz-wrapper-js').remove();
        // this.querySelectorAll('div').forEach(item=>{
        //     item.restoreAttr();
        // });
        console.log('History',Polymer.changeList);
        
        // console.log('Before',this.shadowDOM);

            // this.querySelectorAll('*').forEach(item=>{

            // });

        // Polymer.changeList.forEach(item=>{
        //     let elm = item['element'];
        //     let dzId = elm.getAttribute('dzid');
        //     let newElm = this.shadowDOM.querySelector('[dzid="'+dzId+'"]');
        //     for (var k in item['attribute']){
        //         newElm.setAttribute(k,item['attribute'][k]);
        //     }
        //     for (var k in item['property']){
        //         newElm[k] = item['property'][k];
        //     }
        // });
        
        
        console.log('After',this);  

    }
    
    loadBodyClass = function() {
        let type = "body_class";
        let url =
            "https://d25k6mzsu7mq5l.cloudfront.net/user-data/" + Polymer.uid + "/";
        let basePath =
            url +
            "template/" +
            this.tid +
            "/" +
            this.thisPage +
            "/" +
            type +
            "?id=" +
            new Date().getTime();

        let masterPath =
            url +
            "template/" +
            this.tid +
            "/_master" +
            "/" +
            type +
            "?id=" +
            new Date().getTime();

        let defaultPath =
            url +
            "template/" +
            this.tid +
            "/_default/" +
            type +
            "?id=" +
            new Date().getTime();

        return new Promise(function(resolve, reject) {
            Polymer.getContent(basePath).then(
                (bodyClass) => {
                    resolve(bodyClass);
                },
                (err) => {
                    Polymer.getContent(defaultPath).then(
                        (bodyClass) => {
                            resolve(bodyClass);
                        });
                }
            );
        });
    }

  

}

customElements.define('dz-wrapper', dzWrapper);

</script>
