
<!-- <link rel="import" href="change-like2.html"> -->
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="change-things.html">



<dom-module id="change-in-item">
    <template>
        <style>
            * {
                font-family: sans-serif, 微軟正黑體;
            }

            .container {
                width: 100%;
                margin: 0 auto;
                display: table;
            }
            .svg {
                background-image: url('/img/loading.svg');
                position: relative;
                background-size: 30px;
                background-position: center center;
                background-repeat: no-repeat;
                width: 100%;

            }
            

            #status {
                width: 15px;
                height: 15px;
                background-color: rgb(241, 151, 55);
                border-radius: 100%;
                margin: 4px;
            }

            .things-grid {
                display: grid;
                grid-row-gap: 15px;
                padding: 0px 10px 20px 10px;
                grid-column-gap: 50px;
                grid-row-gap: 40px;
                grid-template-columns: repeat(4, 1fr);
                background-color: white;
                -webkit-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                -moz-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
            }


            #morebutton:hover {
                cursor: pointer;
                color: gray;
                /* text-decoration: underline; */
            }

            #morebutton {
                /* align-items: center;
                border: 1px;
                width: 200px;
                height: 50px;
                font-size: 25px;
                display: block; */
            }

            .botbutton {
                display: block;
                text-align: center;
                margin: 0;
                background-color: white;
                grid-template-columns: repeat(3, 1fr);
                grid-column-gap: 75px;
                padding: 0px 50px 20px 50px;
                -webkit-box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
                -moz-box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
                box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
            }

            @media (max-width: 1292px) {
                .things-grid-middle-mobile {
                    display: grid;
                    height: 100%;
                    grid-row-gap: 15px;
                    grid-column-gap: 30px;
                    grid-row-gap: 40px;
                    grid-template-columns: repeat(3, 1fr);
                    background-color: white;
                    -webkit-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                    -moz-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                    box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                }
            }

            /* @media (max-width: 940px) {
                .things-grid-small-mobile {
                    display: grid;
                    height: 100%;
                    grid-row-gap: 15px;
                    grid-column-gap: 30px;
                    grid-row-gap: 40px;
                    grid-template-columns: repeat(3, 1fr);
                    background-color: white;
                    -webkit-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                    -moz-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                    box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                }

                .botbutton {
                    display: block;
                    padding-bottom: 10px;
                    margin: 0;
                }
            } */

            @media only screen and (max-width: 768px) {
                .things-grid-small-mobile {
                    display: grid;
                    height: 100%;
                    grid-row-gap: 15px;
                    padding-bottom: 50px;
                    grid-column-gap: 15px;
                    grid-row-gap: 40px;
                    grid-template-columns: repeat(2, 1fr);
                    background-color: white;
                    -webkit-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                    -moz-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                    box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                }

                .botbutton {
                    margin-bottom: 50px;
                }
                .svg {
                    background-image: url('/img/loading.svg');
                    position: relative;
                    background-size: 30px;
                    background-position: center center;
                    background-repeat: no-repeat;
                    width: 100%;

                }

            }
        </style>



        <div class="container">
            <div id="change-user" style="display: flex; margin: 10px;"></div>
            <div class="test" style="background-color: white;">
                <div class="things-grid things-grid-small-mobile things-grid-middle-mobile" id="blank"></div>
            </div>
            <div class="botbutton">
                <div style="display:inline-flex;">
                    <vaadin-button id="morebutton" on-click="displaymore" style="cursor: pointer;">更多</vaadin-button>
                </div>
            </div>
        </div>




    </template>

</dom-module>

<script>
    (function() {



        Polymer({
            is: 'change-in-item',
            properties: {
                "data": {
                    "type": Object
                },

                "allquery": {
                    "type": Array

                },
                "countitem": {
                    "type": Number
                },
                "storeviewcate": {
                    "type": Array
                },

                "res": {
                    "type": Array
                },
                "res2": {
                    "type": Array
                },
                "query": {
                    "type": Array
                }







            },

            created: function() {
                this.countitem = 0;
            },
            ready: function() {
                // this.search();
                document.querySelector('#changeitemall').style.display = "none";
            },

            // search:function(cats,tags,district,priceStart,priceEnd){
            search(cats, tags, district, isNew, priceStart, priceEnd, isFree, fanpage) {

                let that = this;
                let shadow = this.shadowRoot;
                shadow.querySelector('.botbutton').style.display = 'block';
                shadow.querySelector('#blank').innerHTML = '<img src="https://www.gettv.hk/img/loading.svg">';
            //     .svg {
            //     background-image: url('/img/loading.svg');
            //     position: relative;
            //     background-size: 30px;
            //     background-position: center center;
            //     background-repeat: no-repeat;
            //     width: 100%;

            // }
                let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                //////cate Id
                // let tagsQuery = ['平價','沒有'];
                if (isFree == undefined || isFree == null || isFree == false) {
                    var isfree2 = false;
                } else {
                    var isfree2 = true;
                }
                let Query = [{
                    "match": {
                        "isFree": isfree2
                    }
                }];

                ///fanpage
                if (fanpage) {
                    Query.push({
                        'term': {
                            'ownerId': fanpage
                        }
                    })
                }


                ///isfree

                ////search the categoriews
                let cateid = [];
                if (cats != undefined || cats != null) {
                    if (cats.length > 0) {
                        cats.forEach(item => {
                            cateid.push({
                                'term': {
                                    'categories': item
                                }
                            });
                        });
                    };
                };
                //////search the isNew
                if (isNew != undefined || isNew != null) {


                    if (isNew.length == 1) {
                        if (isNew == '全新') {
                            var isNewstat = true;
                        } else {
                            var isNewstat = false;
                        }
                        Query.push({
                            'term': {
                                'isNew': isNewstat
                            }
                        })
                    } else {
                        isnewid = [];
                    };
                };

                /////search the tags
                if (tags != undefined || tags != null) {
                    if (tags.length > 0) {
                        tags.forEach(item => {
                            Query.push({
                                'match': {
                                    'tags': item
                                }
                            });
                        });
                    };
                };

                /////search the district
                if (district != undefined || district != null) {
                    if (district.length > 0) {
                        district.forEach(item => {
                            Query.push({
                                'term': {
                                    'district': district
                                }
                            });
                        });
                    };
                };

                /////search the price range
                var fromprice = priceStart;
                var toprice = priceEnd;

                //// the cate query
                let paramcate = {
                    "action": "searchData",
                    "index": "change",
                    "type": "product",
                    "_source": "price",
                    "body": {
                        "sort": [{
                            "createTime": {
                                "order": "desc"
                            }
                        }],
                        "query": {
                            "bool": {
                                "should": cateid
                            }
                        }
                    }
                };
                let parammust = {
                    "action": "searchData",
                    "index": "change",
                    "type": "product",
                    "_source": "price",
                    "body": {
                        "sort": [{
                            "createTime": {
                                "order": "desc"
                            }
                        }],
                        "query": {
                            "bool": {
                                "must": Query,
                                "must_not": {
                                    'match': {
                                        "postStatus": false
                                    }
                                }
                            }
                        }
                    }
                };
                console.log("search price ", fromprice, toprice);

                console.log(JSON.stringify(paramcate), "wwwwwwwwww", JSON.stringify(parammust));
                Polymer.postData(url, paramcate).then(res => {
                    if (res.code > 0) {
                        let shouldid = [];
                        let cates = res.resolve;
                        cates.forEach(cate => {
                            shouldid.push(cate);
                        });

                        Polymer.postData(url, parammust).then(res => {
                            if (res.code > 0) {

                                let mustid = [];
                                let others = res.resolve;
                                others.forEach(other => {
                                    mustid.push(other);
                                });


                                let theans = [];
                                for (x = 0; x < shouldid.length; x++) {
                                    for (y = 0; y < mustid.length; y++) {
                                        if (shouldid[x]['_id'] == mustid[y]['_id']) {
                                            theans.push(shouldid[x]);
                                        }
                                    }
                                };
                                this.res = theans;
                                console.log("now all ans", theans);
                                if (toprice > 1 && isfree2 == false) {
                                    var price1 = [];
                                    var price2 = [];
                                    var theans2 = [];
                                    theans.forEach(item => {
                                        if (item['price'] >= fromprice) {
                                            price1.push(item['_id']);
                                        }
                                        if (item['price'] <= toprice) {
                                            price2.push(item['_id'])
                                        }
                                    });
                                    // console.log("price1n2", price1, price2, "from and to", fromprice, toprice);
                                    for (x = 0; x < price1.length; x++) {
                                        for (y = 0; y < price2.length; y++) {
                                            if (price1[x] == price2[y]) {
                                                theans2.push(price1[x])
                                            }
                                        }
                                    };
                                    this.res2 = theans2;
                                    this.res = [];
                                    let check8 = 8;
                                    if (theans2.length <= 8) {
                                        check8 = theans2.length;
                                        shadow.querySelector('#morebutton').style.display = 'none';
                                    } else {
                                        shadow.querySelector('#morebutton').style.display = 'block';
                                    }
                                    shadow.querySelector('#blank').innerHTML = "";

                                    if (theans2.length == 0) {
                                        shadow.querySelector('#blank').innerHTML = "查無貨品";
                                    } else {
                                        for (i = 0; i < check8; i++) {
                                            let addi = document.createElement('change-things');
                                            addi.setAttribute('id', theans2[i]);
                                            shadow.querySelector('#blank').appendChild(addi);
                                        }
                                    }
                                    // console.log("theans1", theans, "theans2", theans2);
                                    this.countitem += 8;


                                } else {
                                    this.res2 = theans
                                    let check8 = 8;
                                    if (theans.length <= 8) {
                                        check8 = theans.length;
                                        shadow.querySelector('#morebutton').style.display = 'none';
                                    } else {
                                        shadow.querySelector('#morebutton').style.display = 'block';
                                    }
                                    shadow.querySelector('#blank').innerHTML = "";
                                    for (i = 0; i < check8; i++) {
                                        let addi = document.createElement('change-things');
                                        addi.setAttribute('id', theans[i]['_id']);
                                        shadow.querySelector('#blank').appendChild(addi);
                                    }
                                    this.countitem += 8;
                                }
                                let shop = document.querySelector('change-shop');
                                let list = shop.shadowRoot.querySelector('change-slidelist');
                                list.shadowRoot.querySelector('#renew').innerHTML = '<change-range></change-range>';
                                let range_cookie = {
                                    "query": theans,
                                    "from": fromprice,
                                    "to": toprice
                                };
                                store.set('change-range', range_cookie);
                                list.shadowRoot.querySelector('change-range').new();

                            }
                        })


                    } else {
                        console.log('error')
                    }
                })

            },

            displaymore: function() {
                let that = this;
                let shadow = this.shadowRoot;
                let prods = this.res2;
                if (this.res.length > 0) {
                    prods = this.res;

                }
                if (this.res.length > 0) {
                    var storeId = [];
                    let check8 = 8;
                    if (prods.length - this.countitem < 8) {
                        check8 = prods.length - this.countitem;
                        if (prods.length - this.countitem <= 8) {
                            shadow.querySelector('.botbutton').style.display = 'none';
                        }
                    }
                    for (var i = this.countitem; i < this.countitem + check8; i++) {
                        storeId.push(prods[i]['_id'])
                    };
                    storeId.forEach(id => {
                        let addi = document.createElement('change-things');
                        addi.setAttribute('id', id)
                        shadow.querySelector(".things-grid").appendChild(addi);
                    })

                    this.countitem += 8;
                } else {

                    var storeId = [];
                    let check8 = 8;
                    if (prods.length - this.countitem < 8) {
                        check8 = prods.length - this.countitem;
                        shadow.querySelector('.botbutton').style.display = 'none';

                    }
                    for (var i = this.countitem; i < this.countitem + check8; i++) {
                        storeId.push(prods[i])
                    };
                    storeId.forEach(id => {
                        let addi = document.createElement('change-things');
                        addi.setAttribute('id', id)
                        shadow.querySelector(".things-grid").appendChild(addi);
                    })

                    this.countitem += 8;

                }

            },




            _showMyGoods: function() {
                let shadow = this.shadowRoot;
                shadow.querySelector('#blank').innerHTML = "";
                let that = this;
                if (!this.query) {
                    shadow.querySelector('#blank').innerHTML = "No products";
                } else {
                    let goodsUrl = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                    let params = {
                        "action": "searchData",
                        "index": "change",
                        "type": "product",
                        "_source": "_id",
                        "body": {
                            "sort": [{
                                "createTime": {
                                    "order": "desc"
                                }
                            }],
                            "query": {
                                "bool": {
                                    "must": this.query
                                }
                            }
                        }
                    };
                    Polymer.postData(goodsUrl, params).then(res => {
                        console.log("My Product", res);


                        if (res.code > 0) {

                            ////display change-in-item
                            this.myProducts = res.resolve;
                            let wrapper = that.shadowRoot.querySelector('.things-grid');
                            wrapper.innerHTML = '';
                            let x = that.myProducts.length;
                            if (!x) {
                                // console.log("Check inside if");
                                shadow.querySelector('#blank').innerHTML = "沒有貨品";
                            } else {
                                this.res = res.resolve;
                                let check8 = 8;
                                if (res.resolve.length < check8) {
                                    check8 = res.resolve.length;
                                }
                                for (i = 0; i < check8; i++) {
                                    let productItem = document.createElement('change-things');
                                    productItem.setAttribute("id", res.resolve[i]['_id']);

                                    wrapper.appendChild(productItem);
                                }
                                this.countitem = 8;
                            }

                            ///display no reply
                            if (this.getAttribute('id') == "mp") {
                                res.resolve.forEach(item => {
                                    let counti = 0;
                                    if (item.orderId > 0) {
                                        counti++
                                    };
                                    shadow.querySelector('#change-user').innerHTML = '待回覆(' + counti + ')<div id="status"></div>';
                                })
                            }


                        } else {
                            shadow.querySelector('#np').innerHTML = "No products";
                            alert('服務器故障 Server error');
                        }


                    });
                }


            },

            displayitem(x) {
                let shadow = this.shadowRoot;
                shadow.querySelector('#blank').innerHTML = "";
                let that = this;
                let wrapper = that.shadowRoot.querySelector('.things-grid');

                if (x.length == 0 || x.length == undefined || x.length == null) {
                    wrapper.innerHTML = "沒有貨品";
                } else {
                    this.res = 0;
                    this.res2 = x;
                    let check8 = 8;
                    if (x.length < check8) {
                        check8 = x.length
                    }
                    for (i = 0; i < check8; i++) {
                        let productItem = document.createElement('change-things');
                        productItem.setAttribute("id", x[i]);

                        wrapper.appendChild(productItem);
                    }
                    this.countitem = 8;
                }


            },



        });



    })();
</script>