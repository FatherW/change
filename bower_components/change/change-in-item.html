<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="change-like2.html">
<link rel="import" href="change-things.html">



<dom-module id="change-in-item">
    <template>
        <style>
            * {
                font-family: sans-serif, 微軟正黑體;
            }

            .things-grid {
                display: grid;
                width: 97%;
                height: 100%;
                grid-row-gap: 15px;
                padding: 50px;
                grid-column-gap: 50px;
                grid-row-gap: 40px;
                grid-template-columns: repeat(4, 1fr);
                background-color: white;
                -webkit-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                -moz-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
            }


            #morebutton:hover {
                cursor: pointer;
                color: gray;
                /* text-decoration: underline; */
            }

            #morebutton {
                align-items: center;
                border: 1px;
                width: 200px;
                height: 50px;
                font-size: 25px;
                display: block;
            }

            .botbutton {
                text-align: center;
                display: grid;
                width: 97%;
                background-color: white;
                grid-template-columns: repeat(3, 1fr);
                grid-column-gap: 75px;
                padding: 0px 50px 0px 50px;
                margin-bottom: 46px;
                -webkit-box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
                -moz-box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
                box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
            }




            @media (max-width: 1292px) {
                .things-grid-middle-mobile {
                    display: grid;
                    width: 95%;
                    height: 100%;
                    grid-row-gap: 15px;
                    padding-bottom: 50px;
                    grid-column-gap: 25px;
                    grid-row-gap: 40px;
                    grid-template-columns: repeat(3, 1fr);
                    background-color: white;
                }

                change-things {
                    width: 80%;
                    height: 80%
                }
            }

            @media (max-width: 940px) {
                .things-grid-small-mobile {
                    display: grid;
                    width: 100%;
                    height: 100%;
                    grid-row-gap: 15px;
                    padding-bottom: 50px;
                    grid-column-gap: 30px;
                    grid-row-gap: 40px;
                    grid-template-columns: repeat(2, 1fr);
                    background-color: white;
                }
            }

            @media (max-width: 740px) {
                .things-grid-small-mobile {
                    display: grid;
                    width: 100%;
                    height: 100%;
                    grid-row-gap: 15px;
                    padding-bottom: 50px;
                    grid-column-gap: 30px;
                    grid-row-gap: 40px;
                    grid-template-columns: repeat(1, 1fr);
                    background-color: white;
                }

                .things-grid {
                    display: grid;
                    width: 95%;
                    /* padding-left: 15px; */
                    height: 100%;
                    grid-row-gap: 15px;
                    padding: 1px;
                    padding-left: 15px;
                    grid-column-gap: 0px;
                    grid-row-gap: 10px;
                    grid-template-columns: repeat(2, 1fr);
                    background-color: white;
                    -webkit-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                    -moz-box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                    box-shadow: 0px -4px 8px 0px rgba(50, 49, 56, 0.2);
                }

                .botbutton {
                    text-align: center;
                    display: block;
                    width: 71%;
                    margin-right: 0%;
                    background-color: white;
                    /* grid-template-columns: repeat(3, 1fr); */
                    /* grid-column-gap: 75px; */
                    /* padding: 0px 50px 0px 50px; */
                    margin-bottom: 46px;
                    -webkit-box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
                    -moz-box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
                    box-shadow: 0px 4px 8px -1px rgba(50, 49, 56, 0.2);
                }
            }
        </style>



        <!-- <div class="initemtitle" id="viewingcat">你正在瀏覽的分類  </div> -->
        <!-- <div class="things-grid" id="blank"></div>
<div class="botbutton"><button id="morebutton" on-click="_showmore">//更多//</button>
</div> -->
<div class="things-grid" id="blank"></div>
<div class="blank"></div>
<div class="botbutton">
    <div style="display:inline-flex;">
        <vaadin-button id="morebutton" on-click="displaymore">更多</vaadin-button>
    </div>
</div>



    </template>

</dom-module>

<script>
    (function() {



        Polymer({
            is: 'change-in-item',
            properties: {
                "data": {
                    "type": Object
                },

                "allquery": {
                    "type": Array

                },
                "countitem": {
                    "type": Number
                },
                "storeviewcate": {
                    "type": Array
                },

                "res": {
                    "type": Array
                },
                "res2": {
                    "type": Array
                }







            },

            created: function() {
                this.countitem = 0;
            },
            ready: function() {
                this.search();
            },

            // search:function(cats,tags,district,priceStart,priceEnd){
            search(cats, tags, district, isNew, priceStart, priceEnd, isFree) {

                let that = this;
                let shadow = this.shadowRoot;
                let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                //////cate Id
                // let tagsQuery = ['平價','沒有'];
                if (isFree == undefined || isFree == null || isFree == false) {
                    var isfree2 = false;
                } else {
                    var isfree2 = true;
                }
                let Query = [{
                    "match": {
                        "isFree": isfree2
                    }
                }];
                ////search the categoriews
                let cateid = [];
                if (cats != undefined || cats != null) {
                    if (cats.length > 0) {
                        cats.forEach(item => {
                            cateid.push({
                                'term': {
                                    'categories': item
                                }
                            });
                        });
                    };
                };
                //////search the isNew
                if (isNew != undefined || isNew != null) {


                    if (isNew.length == 1) {
                        if (isNew == '全新') {
                            var isNewstat = true;
                        } else {
                            var isNewstat = false;
                        }
                        Query.push({
                            'term': {
                                'isNew': isNewstat
                            }
                        })
                    } else {
                        isnewid = [];
                    };
                };

                /////search the tags
                if (tags != undefined || tags != null) {
                    if (tags.length > 0) {
                        tags.forEach(item => {
                            Query.push({
                                'term': {
                                    'tags': item
                                }
                            });
                        });
                    };
                };

                /////search the district
                if (district != undefined || district != null) {
                    if (district > 0) {
                        Query.push({
                            'term': {
                                'district': district
                            }
                        })
                    };
                };

                /////search the price range
                if (priceEnd == undefined || priceEnd == null) {
                    var fromprice = 0;
                    var toprice = document.querySelector('change-shop').initprice;
                } else {
                    var fromprice = priceStart;
                    var toprice = priceEnd;
                };
                var rangeparam = {
                    "action": "searchData",
                    "index": "change",
                    "type": "product",
                    "_source": "_id",
                    "body": {
                        "sort": [{
                            "createTime": {
                                "order": "desc"
                            }
                        }],
                        "query": {
                            "bool": {
                                "should": {
                                    "range": {
                                        "price": {
                                            "gte": fromprice,
                                            "lte": toprice,
                                            "boost": 1.0
                                        }

                                    }
                                }
                            }
                        }
                    }
                };




                //// the cate query
                let paramcate = {
                    "action": "searchData",
                    "index": "change",
                    "type": "product",
                    "_source": "price",
                    "body": {
                        "sort": [{
                            "createTime": {
                                "order": "desc"
                            }
                        }],
                        "query": {
                            "bool": {
                                "should": cateid
                            }
                        }
                    }
                };
                let parammust = {
                    "action": "searchData",
                    "index": "change",
                    "type": "product",
                    "_source": "price",
                    "body": {
                        "sort": [{
                            "createTime": {
                                "order": "desc"
                            }
                        }],
                        "query": {
                            "bool": {
                                "must": Query,
                                "must_not": {
                                    'match': {
                                        "postStatus": false
                                    }
                                }
                            }
                        }
                    }
                };
                Polymer.postData(url, paramcate).then(res => {
                    if (res.code > 0) {
                        let shouldid = [];
                        let cates = res.resolve;
                        cates.forEach(cate => {
                            shouldid.push(cate);
                        });

                        Polymer.postData(url, parammust).then(res => {
                            if (res.code > 0) {

                                let mustid = [];
                                let others = res.resolve;
                                others.forEach(other => {
                                    mustid.push(other);
                                });


                                let theans = [];
                                for (x = 0; x < shouldid.length; x++) {
                                    for (y = 0; y < mustid.length; y++) {
                                        if (shouldid[x]['_id'] == mustid[y]['_id']) {
                                            theans.push(shouldid[x]);
                                        }
                                    }
                                };
                                this.res = theans;
                                let shop = document.querySelector('change-shop');
                                let list = shop.shadowRoot.querySelector('change-slidelist');
                                list.shadowRoot.querySelector('#renew').innerHTML = '<change-range></change-range>';
                                list.shadowRoot.querySelector('change-range').query = theans;
                                list.shadowRoot.querySelector('change-range').data1 = fromprice;
                                list.shadowRoot.querySelector('change-range').data2 = toprice;
                                list.shadowRoot.querySelector('change-range').new();


                                if (toprice > 1 && isfree2 == false) {
                                    var price1 = [];
                                    var price2 = [];
                                    var theans2 = [];
                                    theans.forEach(item => {
                                        if (item['price'] > fromprice) {
                                            price1.push(item['_id']);
                                        }
                                        if (item['price'] < toprice) {
                                            price2.push(item['_id'])
                                        }
                                    });
                                    // console.log("price1n2", price1, price2, "from and to", fromprice, toprice);
                                    for (x = 0; x < price1.length; x++) {
                                        for (y = 0; y < price2.length; y++) {
                                            if (price1[x] == price2[y]) {
                                                theans2.push(price1[x])
                                            }
                                        }
                                    };
                                    this.res2 = theans2;
                                    this.res = [];
                                    let check8 = 8;
                                    if (theans2.length < 8) {
                                        check8 = theans2.length;
                                        shadow.querySelector('#morebutton').style.display = 'none';
                                    } else {
                                        shadow.querySelector('#morebutton').style.display = 'block';
                                    }
                                    shadow.querySelector('#blank').innerHTML = "";
                                    for (i = 0; i < check8; i++) {
                                        let addi = document.createElement('change-things');
                                        addi.setAttribute('id', theans2[i]);
                                        shadow.querySelector('#blank').appendChild(addi);
                                    }
                                    // console.log("theans1", theans, "theans2", theans2);
                                    this.countitem += 8;



                                    // Polymer.postData(url, rangeparam).then(res => {
                                    //     if (res.code > 0) {
                                    //         var theans2 = [];
                                    //         for (q = 0; q < res.resolve.length; q++) {
                                    //             for (v = 0; v < theans.length; v++) {
                                    //                 if (res.resolve[q]['_id'] == theans[v]['_id']) {
                                    //                     theans2.push(res.resolve[q]['_id'])
                                    //                 }
                                    //             }
                                    //         }

                                    //         this.res2 = theans2
                                    //         this.res = [];
                                    //         let check8 = 8;
                                    //         if (theans2.length < 8) {
                                    //             check8 = theans2.length;
                                    //             shadow.querySelector('#morebutton').style.display = 'none';
                                    //         } else {
                                    //             shadow.querySelector('#morebutton').style.display = 'block';
                                    //         }
                                    //         shadow.querySelector('#blank').innerHTML = "";
                                    //         for (i = 0; i < check8; i++) {
                                    //             let addi = document.createElement('change-things');
                                    //             addi.setAttribute('id', theans2[i]);
                                    //             shadow.querySelector('#blank').appendChild(addi);
                                    //         }
                                    //         this.countitem += 8;


                                    //     } else {
                                    //         console.log('error23')
                                    //     }
                                    // })
                                } else {
                                    this.res2 = theans
                                    let check8 = 8;
                                    if (theans.length < 8) {
                                        check8 = theans2.length;
                                        shadow.querySelector('#morebutton').style.display = 'none';
                                    } else {
                                        shadow.querySelector('#morebutton').style.display = 'block';
                                    }
                                    shadow.querySelector('#blank').innerHTML = "";
                                    for (i = 0; i < check8; i++) {
                                        let addi = document.createElement('change-things');
                                        addi.setAttribute('id', theans[i]['_id']);
                                        shadow.querySelector('#blank').appendChild(addi);
                                    }
                                    this.countitem += 8;
                                }

                            }
                        })


                    } else {
                        console.log('error')
                    }
                })

            },

            displaymore: function() {
                let that = this;
                let shadow = this.shadowRoot;
                let prods = this.res2;
                if (this.res > 0) {
                    prods = this.res;

                }
                if (this.res.length > 0) {
                    var storeId = [];
                    let check8 = 8;
                    if (prods.length - this.countitem < 8) {
                        check8 = prods.length - this.countitem;
                    }
                    for (var i = this.countitem; i < this.countitem + check8; i++) {
                        storeId.push(prods[i]['_id'])
                    };
                    storeId.forEach(id => {
                        let addi = document.createElement('change-things');
                        addi.setAttribute('id', id)
                        shadow.querySelector(".things-grid").appendChild(addi);
                    })

                    this.countitem += 8;
                } else {

                    var storeId = [];
                    let check8 = 8;
                    if (prods.length - this.countitem < 8) {
                        check8 = prods.length - this.countitem;
                    }
                    for (var i = this.countitem; i < this.countitem + check8; i++) {
                        storeId.push(prods[i])
                    };
                    storeId.forEach(id => {
                        let addi = document.createElement('change-things');
                        addi.setAttribute('id', id)
                        shadow.querySelector(".things-grid").appendChild(addi);
                    })

                    this.countitem += 8;

                }

            },








        });



    })();
</script>