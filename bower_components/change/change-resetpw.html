<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/polymer/polymer.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-text-field/vaadin-email-field.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-select/vaadin-select.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="change-login.html">
<dom-module id="change-resetpw">


    <template>

        <style>
            * {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            body {
                overflow: hidden;
            }

            #content {
                width: 40%;
                margin: 0 auto;
                margin-top: 100px;
            }

            h1 {
                margin-top: 20px;
                margin-bottom: 20px;
            }

            a {
                color: blue;
            }

            button.login-register {
                height: 40px;
                width: 100%;
                background-color: #F06C6C;
                font-size: 130%;
                color: white;
                border-radius: 3px;
                border: none;
            }
        </style>
        <div id="content">
            <div>
                <!-- label="密碼"  -->
                新密碼: &nbsp<vaadin-password-field id="pass1" class="padding-none" name="pass"
                    error-message="Please enter a valid password" required clear-button-visible></vaadin-password-field>
            </div>
            <div>
                <!-- label="確認密碼" -->
                確認密碼:<vaadin-password-field id="pass2" class="padding-none" name="confirmPass"
                    error-message="Passwords do not match" required clear-button-visible></vaadin-password-field>
            </div>
            <div>
                <button on-click="_register" class=" login-register">更新密碼</button>
            </div>

        </div>
    </template>

</dom-module>

<script>
    (function () {
        Polymer({
            is: 'change-resetpw',
            properties: {

            },
            created: function () {
                console.log("Created here:");
            },
            //for adding link to the user name connecting wth the databse
            ready: function () {
                console.log("READY HERE:");
            },
            _register() {
                let shadow = this.shadowRoot;
                this.tokManager = new DataPackage('token');

                let loc = location.search;
                let token = "";
                for (i = 7; i < loc.length; i++) {
                    token += loc[i]
                }
                console.log("loc:", token);

                this.tokManager.loadData(token).then(res => {
                    this.verifyTok(res); //tok res
                });
            },

            verifyTok: function (x) {
                //x = tok res
                let res = x;
                console.log("res:", res);

                let now = Date.now();
                // console.log("now:", now);

                if (res['type'] == "forgetpw") {
                    if (now < res['expireDate']) {
                        console.log("this token is still valid!");
                        this.continueResetpw(res['userId']);
                    } else {
                        alert("This token is expired!");
                    }
                } else {
                    alert("this token is not used to verify reset pw!");
                }

            },

            continueResetpw: function (uid) {
                let shadow = this.shadowRoot;
                let pass = shadow.querySelector('#pass1').value;
                let cpass = shadow.querySelector('#pass2').value;


                if (pass == "") {
                    alert("請輸入密碼");
                } else {
                    if (pass != cpass) {
                        alert('密碼不一樣 請重新輸入');
                    } else {
                        this.reset(cpass,uid);
                    }
                }
            },

            reset(password, uid) {
                //change.dazzle.website/forget-password.html?token=24093129016
                let loc = location.search;
                let url =
                    "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                let token = "";
                for (i = 7; i < loc.length; i++) {
                    token += loc[i];
                }
                let pram = {
                    "action": "changeresetpassword",
                    "uid": uid,
                    "password": password
                };
                Polymer.postData(url, pram).then(res => {
                    console.log("res", res);
                    if (res.code > 0) {
                        alert("密碼已被成功更改");
                        location.replace("https://www.gettv.hk");
                    }
                })
            },



        });
    })();
</script>