<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="change-login.html">
<link rel="import" href="change-register.html">

<dom-module id="change-user-panel">

    <template>
        <style>
            *{
                font-family: sans-serif,Microsoft JhengHei;

            }
            .hide {
                display: none;
            }

            button {
                background: none;
                border: none;
                height: 75px;
                color: #7F7F7F;
                cursor: pointer;
            }
            
           
            img{
                height: 40px;
                width: 40px;
                border-radius: 9999999999999px;
            }
            
            #before{
                display: inline-flex;
            }
            .logining{
                display: inline-flex;
            }

        </style>

        <div id="before" class="logining" part="login">
            <button id="register" on-click="_register">/ 註冊</button>
            <button id="login" on-click="_login">/ 登入</button>
        </div>
        <vaadin-dialog id="register"></vaadin-dialog>
        <vaadin-dialog id="registerpop"></vaadin-dialog>

    </template>


</dom-module>

<script>
    (function() {
        Polymer({
            is: 'change-user-panel',
            properties: {},
            created: function() {

            },
            _login: function() {
                let shadow = this.shadowRoot;
                let that = this;
                let user = store.get('change-user');
                if (user == null) {
                    let dialog = shadow.querySelector('vaadin-dialog');
                    Polymer.popup(dialog, "change", "change-login", "350px", "350px");
                }
            },

            _register: function() {
                let shadow = this.shadowRoot;
                let that = this;
                let user = store.get('change-user');
                if (user == null) {
                    let dialog = shadow.querySelector('vaadin-dialog#register');
                    Polymer.popup(dialog, "change", "change-register", "360px", "600px");
                } else {
                    store.set('change-user', null);
                    location.replace("./");
                }
            },
            logingoogle() {
                window.signOut();
                console.log("insede logingoogle");
                let that = this;
                let link = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let platform = store.get('change-platform');
                let email = platform['email'];
                let name = platform['name'];
                let param = {
                    "action": "searchData",
                    "index": "change",
                    "type": "_user",
                    "body": {
                        "query": {
                            "match": {
                                "email": email
                            }
                        }
                    }
                };
                Polymer.postData(link, param).then(res => {
                    if (res.code > 0) {
                        let all = res.resolve;
                        console.log(res);
                        if (all.length == 0) {
                            ////jump to resigter
                            console.log("shoud go to regis");
                            let platformcookie = {
                                "platform": "Google",
                                "name": name,
                                "email": email
                            };
                            store.set("change-platform", platformcookie);
                            let dialog = that.shadowRoot.querySelector('#registerpop');
                            Polymer.popup(dialog, "change", "change-register", "45s%", "90%");
                        } else {
                            if (all[0].platform == "Google") {
                                store.set('change-user', all[0]);
                                location.reload();
                            } else {
                                alert("此帳戶的郵箱已在" + all[0].platform + "註冊，請重新登入");
                            }
                        }
                    } else {
                        console.log("打錯param");
                    }
                })

            },
            ready: function() {
                let user = store.get('change-user') || null;
                if (user != null) {
                    this.shadowRoot.querySelector('#register').innerHTML = ' / 登出';
                    if (user['head'] == "") {
                        user['head'] = "http://change.dazzle.website/img/head.svg";
                    }
                    this.shadowRoot.querySelector('#login').innerHTML = '<a href="/user.html?' + user['_id'] + '"><img src="' + user['head'] + '"></a>';
                }
                let s = this.shadowRoot;
                document.addEventListener('close-myself', e => {
                    s.querySelector('vaadin-dialog#register').opened = false;
                    let dialog = s.querySelector('vaadin-dialog#register');
                    Polymer.popup(dialog, "change", '<change-login><div class="g-signin2" data-onsuccess="onSignIn"></div></change-login>', "40%", "90%");
                });
                console.log("hhhhhhhhh", document.querySelector('.googleloginname').innerHTML);
                document.querySelector('.googleloginname').addEventListener('click', e => {
                    console.log("running inside addevent");
                    this.logingoogle();
                })
            }

        });
    })();
</script>