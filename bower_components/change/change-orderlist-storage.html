<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="change-order-list.html">


<dom-module id="change-orderlist-storage">
    <template>
        <style>
            .orderContainter {
                height: auto;
                background-image: url(http://change.dazzle.website/img/background/3.jpg);
                padding-bottom: 50px;
                margin: 0 auto;
                display: none;
            }

            .order {
                width: 94%;
                margin: 0 auto;
                font-size: 20px;
                color: black;
                padding-bottom: 50px;
            }

            .text {
                padding-top: 45px;
                padding-bottom: 45px;
            }

            * {
                font-family: sans-serif, Microsoft JhengHei;

            }

            .bg {
                background-color: white;
                width: 92.5%;
                margin: 0 auto;
                border: 1px #ccc solid;
            }

            @media (max-width: 758px) {
                .orderContainter {
                    padding-bottom: 120px;
                }
            }
        </style>
        <div class="orderContainter">
            <div class="bg">
                <div class="order">
                    <div class="text"><b>處理訂單:</b></div>
                    <div id="ol"></div>
                </div>
                <!-- <div id="ol"></div> -->
            </div>
        </div>


        </div>
    </template>
</dom-module>

<script>
    (function () {
        Polymer({
            is: 'change-orderlist-storage',
            properties: {
                "id": {
                    "type": String
                },
                "removeid": {
                    "type": String
                }
            },
            created: function () {

            },



            ready: function () {
                console.log("inside orderlist-storage.html");
                // html + ?xxxxxxxxxxxxxxxxx
                let that = this;
                let shadow = this.shadowRoot;
                let loc = location.search;
                let pid = "";
                let uid = "";

                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                };
                for (i = posit + 1; i < loc.length; i++) {
                    uid += loc[i];
                }
                let user = store.get('change-user') || null;
                if (user['_id'] == uid) {
                    shadow.querySelector('.orderContainter').style.display = 'block';
                }

                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let params = {
                    "action": "searchData",
                    "index": "change",
                    "type": "order",
                    "body": {
                        "sort": [{
                            "submitTime": {
                                "order": "desc"
                            }
                        }],
                        "query": {
                            "bool": {
                                "must": [{
                                    "match": {
                                        "productId": pid
                                    }
                                },
                                {
                                    "match": {
                                        "status": "已提交訂單"
                                    }
                                }]
                            }
                        }
                    }
                };
                console.log("the param of order ,", JSON.stringify(params));
                Polymer.postData(Url, params).then(res => {
                    console.log("RP", res);
                    if (res.code > 0) {
                        let a = [];
                        for (i = 0; i < res.resolve.length; i++) {
                            a.push(res.resolve[i]['id']);
                        }
                        var b = "";
                        //stack the pending oder from <change-order-list>
                        for (i = 0; i < res.resolve.length; i++) {
                            b += '<change-order-list id="' + a[i] + '"></change-order-list>';
                        }
                        console.log("the thing should be display : ", b)
                        shadow.querySelector('#ol').innerHTML = b;
                    } else {
                        console.log("error in orderlist-storage");
                    }
                })

            },

        });
    })();
</script>