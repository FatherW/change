<link href="../polymer/polymer.html" rel="import">
<link href="../dz-menu/css/style.html" rel="import" />
<link rel="import" href="../vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../vaadin-select/vaadin-select.html">
<link rel="import" href="../vaadin-button/vaadin-button.html">
<link rel="import" href="../vaadin-text-field/vaadin-email-field.html">
<link rel="import" href="../vaadin-text-field/vaadin-number-field.html">
<link rel="import" href="change-icon.html">
<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">


<dom-module id="change-page-info">
    <template>
        <style>
            *,
            p,
            h5 {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            a {
                text-decoration: none;

            }

            #info {
                padding: 8px;
                margin-left: 100px;
            }

            #left {
                width: 80%;
                float: left;
            }

            .inf {
                line-height: 2.5;
                color: grey;
            }

            .infotext {
                color: black;

            }

            #right {
                /* width: 75%; */
                display: inline-flex;
                align-content: flex-end;
            }

            .grid-container {
                display: grid;
                grid-template-columns: 2.5fr 1fr;
                background-color: white;
                width: 94%;
                margin: 0 auto;
            }

            h5 {
                font-size: 1em;
                color: black;
            }

            #container {
                float: left;
                background-color: #FFFBF2;
                width: 100%;
                padding-top: 30px;
                padding-bottom: 30px;
                margin-bottom: 10px;
            }

            .buttons {
                margin-block-start: 1.67em;
                margin-block-end: 1.67em;
                margin-right: 100px;
                display: flex;
            }

            #info2 {
                background: white;
                width: 94%;
                margin: 0 auto;
                display: none;
            }

            .inf2 {
                line-height: 2.5;
                color: grey;
                margin-left: 100px;
            }

            @media (max-width: 640px) {
                .grid-container {
                    display: block;
                    height: auto;
                    width: 100%;
                    margin: 0px;
                    padding: 0px;
                    padding-bottom: 20px;
                }

                #container {
                    padding-top: 0;
                    padding-bottom: 0;
                    margin-bottom: 0;
                }

                #info {
                    margin-left: 0;
                }

                .buttons {
                    display: block;
                    margin-block-start: 0em;
                    margin-block-end: 0em;
                    margin-left: 20px;
                }
            }
        </style>
        <div id="container">
            <div class="grid-container">
                <div id="left">
                    <div id="info">
                        <h5>專頁資料</h5>
                        <p class="inf">名稱: <span class="infotext" id="name"></span></p>
                        <p class="inf">地區: <span class="infotext" id="area"></span></p>
                        <p class="inf">電郵: <span class="infotext" id="email"></span></p>
                        <p class="inf hide">標籤 : <span id="contact"></span></p>
                    </div>
                </div>
                <div id="right" style="display: none;">
                    <div class="buttons">
                        <vaadin-button id="vs1" style="margin-right: 10px;" on-click="setadmin">指派專頁管理員
                        </vaadin-button>
                        <vaadin-button id="vb" on-click="toggle">編輯</vaadin-button>
                    </div>
                </div>
            </div>
        </div>
        <div id="info2">
            <h5 style="margin-left: 100px;">指派專頁管理員資料</h5>
            <p class="inf2">電郵: <span class="infotext" id="adminEmail">
                    <vaadin-text-field id='Aemail'></vaadin-text-field>
                </span></p>

            <div style="display: inline-flex; margin-left: 100px;">
                <vaadin-button id="vb" class="handIn" on-click="handin">提交</vaadin-button>
                <vaadin-button id="vb" on-click="cancel" style="margin-left: 20px;">取消</vaadin-button>
            </div>
        </div>
    </template>
</dom-module>
<script>
    (function () {
        Polymer({
            is: 'change-page-info',
            properties: {
                "status": {
                    "type": Boolean
                }

            },
            created: function () {

            },
            ready: function () {
                let shadow = this.shadowRoot;
                shadow.querySelector('.hide').style.display = "none";
                //DETERMINE WHETHER CURRENT USER IS ADMIN OR NOT//
                let usercookies = store.get('change-user') || null;
                console.log("current user info", usercookies);

                if (usercookies !== null) {
                    let userID = usercookies['id'];
                    console.log("cookie", userID);
                    let link = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                    let param = {
                        "action": "searchData",
                        "index": "change",
                        "type": "_user",
                        "body": {
                            "query": {
                                "match": {
                                    "id": userID
                                }
                            }
                        }
                    };
                    Polymer.postData(link, param).then(res => {
                        if (res.code > 0) {
                            // console.log("CHECK",res.code);
                            let adminStatus = res.resolve[0].isAdmin;
                            if (Boolean(adminStatus) == true) {
                                console.log("This user is ADMIN!");
                                console.log("status", adminStatus);
                                shadow.querySelector("#right").style.display = "block";

                            } else {
                                console.log("This user is NOT ADMIN!");
                            }
                        } else {
                            console.log("CANNOT SEARCH USER!");
                        }
                    });

                }

                //
                this.status = false;
                let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";

                let id = document.querySelector('fanpage').getAttribute('id');

                if (id != "") {

                    let params = {
                        "action": "getData",
                        "index": "change",
                        "type": "pages",
                        "id": id
                    };
                    Polymer.postData(url, params).then(res => {

                        if (res.code > 0) {
                            let all = res.resolve;
                            shadow.querySelector('#name').innerText = all['name'];
                            shadow.querySelector('#area').innerText = all['district'];
                            shadow.querySelector('#email').innerText = all['email'];
                            shadow.querySelector('#contact').innerText = all['tags'];
                            document.querySelector('change-shop').pagetag(all['tags']);
                            // let storeadmin = all['adminId'];
                            // let write = "";
                            // for (a = 0; a < storeadmin.length; a++) {
                            //     write += '<change-icon id="' + storeadmin[a] + '"></change-icon>'
                            // }
                            // shadow.querySelector('#shouldhide').innerHTML = write;



                        }
                    })
                } else {

                }
            },


            execute: function () {
                console.log("Entered");
                let shadow = this.shadowRoot;
                customElements.whenDefined('vaadin-select').then(function () {
                    const district = [{
                        id: '中西區',
                        name: '中西區'
                    }, {
                        id: '灣仔區',
                        name: '灣仔區'
                    }, {
                        id: '東區',
                        name: '東區'
                    }, {
                        id: '南區',
                        name: '南區'
                    }, {
                        id: '油尖旺區',
                        name: '油尖旺區'
                    }, {
                        id: '深水埗',
                        name: '深水埗區'
                    }, {
                        id: '九龍城區',
                        name: '九龍城區'
                    }, {
                        id: '黃大仙區',
                        name: '黃大仙區'
                    }, {
                        id: '觀塘區',
                        name: '觀塘區'
                    }, {
                        id: '葵青區',
                        name: '葵青區'
                    }, {
                        id: '荃灣區',
                        name: '荃灣區'
                    }, {
                        id: '屯門區',
                        name: '屯門區'
                    }, {
                        id: '元朗區',
                        name: '元朗區'
                    }, {
                        id: '離島區',
                        name: '離島區'
                    }, {
                        id: '北區',
                        name: '北區'
                    }, {
                        id: '大埔區',
                        name: '大埔區'
                    }, {
                        id: '沙田區',
                        name: '沙田區'
                    }, {
                        id: '西貢區',
                        name: '西貢區'
                    }];
                    shadow.querySelector('vaadin-select').renderer = function (root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        district.forEach(function (item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.id);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };
                });
            },

            setadmin: function () {
                let shadow = this.shadowRoot;
                // if (this.status == false) {
                //     this.status = true;
                //     shadow.querySelector('#shouldhide').style.display = 'block';
                //     console.log()
                // } else {
                //     this.status = false;
                //     shadow.querySelector('#shouldhide').style.display = 'none';
                // }

                this.shadowRoot.querySelector('#info2').style.display = "block";
            },

            handin() {
                // console.log("handin is working!");
                let shadow = this.shadowRoot;
                let setAdminEmail = shadow.querySelector('#Aemail').value;
                console.log("adminEmail:", setAdminEmail);

                let link = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let params = {
                    "action": "searchData",
                    "index": "change",
                    "type": "_user",
                    "body": {
                        "query": {
                            "match": {
                                "email": setAdminEmail
                            }
                        }
                    }
                };
                Polymer.postData(link, params).then(res => {
                    if (res.code > 0) {
                        if (res.resolve.length !== 0) {
                            // console.log("User to be Admin:", res.resolve[0].id);
                            let adminId = res.resolve[0].id;
                            // let a = [adminId];
                            let fanpageId = document.querySelector('fanpage').id;
                            // console.log("fanpage:", fanpageId);

                            // adminIdArray += ad

                            //***GET ADMIN ARRAY***//
                            let params1 = {
                                "action": "getData",
                                "index": "change",
                                "type": "pages",
                                "id": fanpageId
                            };
                            Polymer.postData(link, params1).then(res => {
                                if (res.code > 0) {
                                    let adminIdArray = res.resolve.adminId;
                                    console.log("adminIdArray before:", adminIdArray);
                                    adminIdArray.push(adminId);
                                    console.log("adminIdArray after:", adminIdArray);

                                    //***UPDATE ADMIN ARRAY***//
                                    let params2 = {
                                        "action": "addData",
                                        "index": "change",
                                        "type": "pages",
                                        "id": fanpageId,
                                        "body": {
                                            "adminId": adminIdArray
                                        }
                                    };
                                    Polymer.postData(link, params2).then(res => {
                                        if (res.code > 0) {
                                            alert("Added input user as Fanpage Admin");
                                        } else {
                                            alert("Err:cannot add input user as Fanpage Admin");
                                        }
                                    });

                                } else {
                                    alert("Err: no such Fanpage!")
                                }
                            });

                        } else {
                            alert("No such user!");
                        }
                    }
                });
            },

            cancel() {
                this.shadowRoot.querySelector('#info2').style.display = "none";

            },

            toggle: function () {
                let loc = "?1";

                let id = "";
                for (var i = 1; i < loc.length; i++) {
                    id += loc[i];
                }

                let shadow = this.shadowRoot;
                let text = shadow.querySelector('#vb');
                if (text.innerHTML == "編輯") {
                    console.log("222222222222");
                    let name = shadow.querySelector('#name').innerText;
                    let area = shadow.querySelector('#area').innerText;
                    shadow.querySelector('#name').innerHTML = "<vaadin-text-field id='name1' value='" + name + "'></vaadin-text-field>";
                    shadow.querySelector('#area').innerHTML = "<vaadin-select id='area1' value='" + area + "' label=''></vaadin-select>";
                    this.execute();
                    text.innerHTML = "提交";
                } else {
                    console.log("233333333333");

                    let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                    let name = shadow.querySelector('#name1').value;
                    let area = shadow.querySelector('#area1').value;
                    let params = {
                        "action": "addData",
                        "index": "change",
                        "type": "pages",
                        "id": id,
                        "body": {
                            "website": website,
                            "district": area
                        }
                    };
                    Polymer.postData(url, params).then(res => {
                        console.log(res);
                        console.log(params);
                        if (res.code > 0) {
                            shadow.querySelector('#name').innerHTML = name;
                            shadow.querySelector('#area').innerHTML = area;
                            text.innerHTML = "編輯";
                            user['area'] = area;
                            user['username'] = name;
                            store.set("change-user", user);
                        }
                    })


                }

            },
        });
    })();
</script>