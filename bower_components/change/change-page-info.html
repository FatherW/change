<link href="../polymer/polymer.html" rel="import">
<link href="../dz-menu/css/style.html" rel="import" />
<link rel="import" href="../vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../vaadin-select/vaadin-select.html">
<link rel="import" href="../vaadin-button/vaadin-button.html">
<link rel="import" href="../vaadin-text-field/vaadin-email-field.html">
<link rel="import" href="../vaadin-text-field/vaadin-number-field.html">
<link rel="import" href="change-icon.html">
<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">


<dom-module id="change-page-info">
    <template>
        <style>
            *,
            p,
            h5 {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            a {
                text-decoration: none;

            }

            #info {
                padding: 8px;
                margin-left: 100px;
            }

            #left {
                width: 80%;
                float: left;
            }

            .inf {
                line-height: 2.5;
                color: grey;
            }

            .infotext {
                color: black;

            }

            #right {
                /* width: 75%; */
                display: inline-flex;
                align-content: flex-end;
            }

            .grid-container {
                display: grid;
                grid-template-columns: 2.5fr 1fr;
                background-color: white;
                width: 100%;
                margin: 0 auto;
            }

            h5 {
                font-size: 1em;
                color: black;
            }

            #container {
                float: left;
                width: 100%;
                padding-top: 30px;
                padding-bottom: 30px;
                margin-bottom: 10px;
            }

            .buttons {
                margin-block-start: 1.67em;
                margin-block-end: 1.67em;
                margin-right: 100px;
                display: flex;
            }

            #info2 {
                background: white;
                width: 94%;
                margin: 0 auto;
                display: none;
            }

            .inf2 {
                line-height: 2.5;
                color: grey;
                margin-left: 100px;
            }

            @media (max-width: 640px) {
                .grid-container {
                    display: block;
                    height: auto;
                    width: 100%;
                    margin: 0px;
                    padding: 0px;
                    padding-bottom: 20px;
                }

                #container {
                    padding-top: 0;
                    padding-bottom: 0;
                    margin-bottom: 0;
                }

                #info {
                    margin-left: 0;
                }

                .buttons {
                    display: block;
                    margin-block-start: 0em;
                    margin-block-end: 0em;
                    margin-left: 20px;
                }
            }
        </style>
        <div id="container">
            <div class="grid-container">
                <div id="left">
                    <div id="info">
                        <h5>專頁資料</h5>
                        <p class="inf">專頁id: <span class="infotext">{{page.id}}</span></p>
                        <p class="inf">名稱: <span class="infotext" id="name">{{page.pagename}}</span></p>
                        <p class="inf">地區: <span class="infotext" id="area">{{page.district}}</span></p>
                        <p class="inf">電郵: <span class="infotext" id="email">{{page.email}}</span></p>
                        <p class="inf">網址: <span class="infotext" id="website">{{page.website}}</span></p>
                        {{errmsg}}
                    </div>
                </div>
                <div id="right" style="display: none;">
                    <div class="buttons">
                        <vaadin-button on-click="website">{{siteEdit}}</vaadin-button>

                        <vaadin-button id="vs1" style="margin:5px 10px;" on-click="setadmin">{{getadminId}}
                        </vaadin-button>
                        <vaadin-button id="vb" on-click="toggle">{{editText}}</vaadin-button>
                    
                    </div>
                    <div id="info2">
                        <h5 style="margin-left: 100px;">指派專頁管理員資料</h5>
                        <p class="inf2">電郵: <span class="infotext" id="adminEmail">
                                <vaadin-text-field id='getuserId'></vaadin-text-field>
                            </span></p>
                        <div style="display: inline-flex; margin-left: 100px;">
                            <vaadin-button class="handIn" on-click="searchadmin">搜尋</vaadin-button>
                            <vaadin-button id="adminAdd" on-click="addAdmin" style="margin-left: 20px;display: none;">確認</vaadin-button>
                        </div>
                        <div style="margin-left:100px">{{errmsg2}}</div>
                    </div>
                </div>
            </div>
        </div>
        
    </template>
</dom-module>
<script>
    (function() {
        Polymer({
            is: 'change-page-info',
            properties: {
                "status": {
                    "type": Boolean
                },
                "id": {
                    "type": String
                },
                "page": {
                    "type": Array
                },
                "setadminState": {
                    "type": Boolean
                }
            },
            created: function() {
                let user = store.get('change-user') || null;
                if (user == null) {

                } else if (user.isAdmin) {

                    user["userBucket"] = "change.dazzle.website";
                    this.fileManager = new AwsPackage(user);
                    this.pageManager = new DataPackage('pages');
                    this.userManager = new DataPackage('_user');
                    this.setadminState = false;
                }
            },
            ready: function() {
                this.editText = "編輯";
                this.siteEdit = "更改網址";
                this.getadminId = '指派專頁管理員';
                let shadow = this.shadowRoot;
                let searchadmin = shadow.querySelector('#getuserId');
                searchadmin.addEventListener('keydown', e => {
                    if (e.code == "Enter") this.searchadmin();
                });


            },
            ////run成個page
            run() {
                let shadow = this.shadowRoot;
                let user = store.get('change-user') || null;
                if (user) {
                    if (Boolean(user.isAdmin) == true) {
                        shadow.querySelector("#right").style.display = "block";
                    }
                }
                let url = '/json/page-' + this.id + '.json?id=' + new Date().getTime();
                Polymer.getContent(url).then(res => {
                        this.page = JSON.parse(res);
                    })
                    ////gen adminId
                let root = shadow.querySelector('#info2');
                let adminId = this.page['adminId'];
                adminId.forEach(item => {
                    let icon = document.createElement('change-icon');
                    icon.setAttribute('id', item);
                    root.appendChild(icon);
                })

            },
            /////gen vaadin select
            execute: function() {
                let shadow = this.shadowRoot;
                customElements.whenDefined('vaadin-select').then(function() {
                    const district = [{
                        id: '中西區',
                        name: '中西區'
                    }, {
                        id: '灣仔區',
                        name: '灣仔區'
                    }, {
                        id: '東區',
                        name: '東區'
                    }, {
                        id: '南區',
                        name: '南區'
                    }, {
                        id: '油尖旺區',
                        name: '油尖旺區'
                    }, {
                        id: '深水埗',
                        name: '深水埗區'
                    }, {
                        id: '九龍城區',
                        name: '九龍城區'
                    }, {
                        id: '黃大仙區',
                        name: '黃大仙區'
                    }, {
                        id: '觀塘區',
                        name: '觀塘區'
                    }, {
                        id: '葵青區',
                        name: '葵青區'
                    }, {
                        id: '荃灣區',
                        name: '荃灣區'
                    }, {
                        id: '屯門區',
                        name: '屯門區'
                    }, {
                        id: '元朗區',
                        name: '元朗區'
                    }, {
                        id: '離島區',
                        name: '離島區'
                    }, {
                        id: '北區',
                        name: '北區'
                    }, {
                        id: '大埔區',
                        name: '大埔區'
                    }, {
                        id: '沙田區',
                        name: '沙田區'
                    }, {
                        id: '西貢區',
                        name: '西貢區'
                    }];
                    shadow.querySelector('vaadin-select').renderer = function(root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        district.forEach(function(item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.id);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };
                });
            },
            ////顯示加入admin介面
            setadmin: function() {
                let that = this;
                let shadow = this.shadowRoot;
                this.getadminId = '指派專頁管理員';
                let state = this.setadminState;
                if (state == false) {
                    state = true;
                    shadow.querySelector('#info2').style.display = "block";
                } else {
                    state = false;
                    shadow.querySelector('#info2').style.display = "none";
                }
            },

            ////搜尋用戶是否存在
            searchadmin() {
                let shadow = this.shadowRoot;
                let id = shadow.querySelector('#getuserId').value;
                let url = "json/user-" + id + ".json";
                let button = shadow.querySelector('#adminAdd')
                this.fileManager.getFile(url).then(res => {
                    if (this.page['adminId'].indexOf(id) == -1) {
                        // console.log("could add", this.page['adminId'].indexOf(id), id, this.page['adminId']);
                        this.errmsg2 = "按確認以加入用戶(" + id + ")";
                        this.newAdmin = id;
                        button.style.display = "block";
                    }
                }, err => {
                    button.style.display = "none";
                    this.errmsg2 = "沒有此用戶";
                })
            },
            ///加入用戶
            addAdmin() {
                let url = 'https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController';
                let param = {
                    "action": "updateData",
                    "index": "change",
                    "type": "pages",
                    "id": this.id,
                    "body": {
                        "query": {
                            "script": {
                                "source": "ctx._source['adminId'].add('" + this.newAdmin + "')"
                            }
                        }
                    }
                };
                Polymer.postData(url, param).then(res => {
                    if (res.code > 0) {
                        this.errmsg2 = "成功加入" + this.newAdmin;
                    }
                })

            },
            cancel() {
                this.shadowRoot.querySelector('#info2').style.display = "none";

            },

            toggle: function() {
                let shadow = this.shadowRoot;
                let that = this;
                let text = this.editText;
                if (text == "編輯") {
                    shadow.querySelector('#name').innerHTML = "<vaadin-text-field id='pagename1' value=" + this.page['pagename'] + "></vaadin-text-field>";
                    shadow.querySelector('#area').innerHTML = "<vaadin-select id='area1' value=" + this.page['district'] + " label=''></vaadin-select>";
                    shadow.querySelector('#email').innerHTML = "<vaadin-text-field id='name1' value=" + this.page['email'] + "></vaadin-text-field>";
                    this.execute();
                    text = "提交";
                } else {
                    text = "編輯";
                    that.check();


                }

            },
            website() {
                console.log(this.siteEdit);
                let that = this;
                if (that.siteEdit == "更改網址") {
                    console.log("good");
                    that.shadowRoot.querySelector('#website').innerHTML = "<vaadin-text-field id='website1' value=" + this.page['website'] + "></vaadin-text-field>";
                    that.siteEdit = "確認更改";
                } else {
                    console.log("bad");
                    that.siteEdit = "更改網址";
                    that.websitechanges();
                }
            },
            websitechanges() {
                let that = this;
                let shadow = this.shadowRoot;
                let website = shadow.querySelector('#website1').value;
                if (website != this.page['website']) {
                    this.fileManager.getFile(website).then(res => {
                            alert('頁面已存在');
                        },
                        err => {
                            that.fanpageGen(website, that.page['id']);
                        })
                } else {
                    console.log("nth");
                }
            },
            fanpageGen(website, pageid) {
                let url = "/json/fanpage/fanPageTemplate.html?id=" + new Date().getTime();
                Polymer.getContent(url).then(html => {
                    let newFanpage = html.replace("[pageid]", pageid);
                    this.fileManager.saveHtml(website, newFanpage);
                    this.shadowRoot.querySelector('#info1').style.display = "none";
                    alert("成功新增專頁");
                })
            },
            check() {
                let url = 'https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController';
                let that = this;
                let shadow = this.shadowRoot;
                let pagename = shadow.querySelector('#pagename1').value
                let email = shadow.querySelector('#name1').value;
                let area = shadow.querySelector('#area1').value;

                let param = [{
                    "match": {
                        'pagename': pagename
                    }
                }, {
                    "match": {
                        'website': website
                    }

                }]

                let search = {
                    "action": "searchData",
                    "index": "change",
                    "type": "pages",
                    "body": {
                        "query": {
                            "bool": {
                                "should": param
                            }
                        }
                    }
                };
                Polymer.postData(url, search).then(res => {
                    let all = res.resolve;
                    if (all.length > 0) {
                        let errstore = [];
                        all.forEach(item => {
                            if (item['id'] == pageid.value) errstore.push('專頁ID');
                            if (item['pagename'] == pagename.value) errstore.push('專頁名稱')
                            if (item['website'] == website.value) errstore.push('專頁網址');

                        })
                        errstore.forEach(str => {
                            that.errmsg += str + "已存在，請更改"
                        })


                    } else {
                        /////great
                        that.renewPageData();
                    }
                })



            },
            renewPageData() {
                let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let pagename = shadow.querySelector('#pagename1').value
                let email = shadow.querySelector('#name1').value;
                let area = shadow.querySelector('#area1').value;
                let params = {
                    "action": "addData",
                    "index": "change",
                    "type": "pages",
                    "id": this.id,
                    "body": {
                        "pagename": pagename,
                        "email": email,
                        "district": area,
                    }
                };
                Polymer.postData(url, params).then(res => {
                    if (res.code > 0) {
                        shadow.querySelector('#name').innerHTML = pagename;
                        shadow.querySelector('#area').innerHTML = area;
                        shadow.querySelector('#email').innerHTML = email;
                        text = "編輯";
                    } else {
                        console.log("0421 , add data error")
                    }
                })

            },
        });
    })();
</script>