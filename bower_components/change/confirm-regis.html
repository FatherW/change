<link rel="import" href="../polymer/polymer.html">

<dom-module id="confirm-regis">


    <template>

        <style>
            * {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            body {
                overflow: hidden;
            }

            #content {
                width: 40%;
                margin: 0 auto;
            }

            h1 {
                margin-top: 20px;
                margin-bottom: 20px;
            }

            a {
                color: blue;
            }
        </style>
        <div id="content">
            <h1>註冊成功:</h1>
            <h3>恭喜！你已成功註冊帳戶，一起減廢，為環保出一分力。</h3>
            <br>
            <h3>以後只需透過電腦或手機瀏覽，即可上載物品平台，讓全港看見！</h3>
            <a href="http://change.dazzle.website/">change.dazzle.website</a>
            <br>
            <h3>Get TV 讓你生活Get 多啲</h3>

        </div>
    </template>

</dom-module>

<script>
    (function () {
        Polymer({
            is: 'confirm-regis',
            properties: {

            },
            created: function () {
                let loc = location.search;
                // let loc = "?token=1594953468686178216261";
                let token = "";
                for (i = 7; i < loc.length; i++) {
                    token += loc[i]
                }
                let link = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let param = {
                    "action": "searchData",
                    "index": "change",
                    "type": "_user",
                    "body": {
                        "query": {
                            "match": {
                                "token": token
                            }
                        }
                    }
                };
                Polymer.postData(link, param).then(res => {
                    if (res.code > 0) {
                        if (res.resolve) {
                            let user = res.resolve[0];
                            if (user.token = token) {
                                store.set('change-user', user);

                            }
                        };

                        let userid = res.resolve[0]['_id'];
                        let paramtake = {
                            "action": "addData",
                            "index": "change",
                            "type": "_user",
                            "id": userid,
                            "body": {
                                "token": ""
                            }
                        };
                        Polymer.postData(link, paramtake).then(res => {
                            if (res.code > 0) {
                                console.log("add success");
                                // location.reload();
                            }
                        });

                        let user = store.get('change-user') || null;
                        if (user['_id'] == userid) {
                            console.log("success user id token", user);
                            console.log("success user id", userid);

                        } else {
                            console.log("fail user id token", user);
                            console.log("fail user id", userid);
                        };
                        let header = document.querySelector('change-header');
                        let tophead = header.shadowRoot.querySelector('change-header-top');
                        let userpanel = tophead.shadowRoot.querySelector('change-user-panel');
                        let shadow = userpanel.shadowRoot;

                        shadow.querySelector('#register').innerHTML = ' / 登出';
                        shadow.querySelector('#login').innerHTML = '<a href="/user.html?' + user['_id'] + '"><img src="' + user['head'] + '"></a>';
                        // document.querySelector('change-header').shadowRoot.querySelector('header').shadowRoot.querySelector('change-header-top').shadowRoot.querySelector('change-user-panel')
                    }
                })


            },
            //for adding link to the user name connecting wth the databse
            ready: function () {


            },



        });
    })();
</script>