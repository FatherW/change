<link rel="import" href="../polymer/polymer.html">

<dom-module id="confirm-regis">


    <template>

        <style>
            * {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            body {
                overflow: hidden;
            }

            #content {
                width: 40%;
                margin: 0 auto;
            }

            h1 {
                margin-top: 20px;
                margin-bottom: 20px;
            }

            a {
                color: blue;
            }
        </style>
        <div id="content">
            <h1>註冊成功:</h1>
            <h3>恭喜！你已成功註冊帳戶，一起減廢，為環保出一分力。</h3>
            <br>
            <h3>以後只需透過電腦或手機瀏覽，即可上載物品平台，讓全港看見！</h3>
            <a href="http://www.gettv.hk/">www.gettv.hk</a>
            <br>
            <h3>Get TV 讓你生活Get 多啲</h3>

        </div>
    </template>

</dom-module>

<script>
    (function() {
        Polymer({
            is: 'confirm-regis',
            properties: {

            },
            created: function() {
                let loc = location.search;
                // let loc = "?token=1594953468686178216261";
                let token = "";
                for (i = 7; i < loc.length; i++) {
                    token += loc[i]
                }
                this.fileManager = new AwsPackage(verifiedUser);

                let link = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let param = {
                    "action": "searchData",
                    "index": "change",
                    "type": "_user",
                    "body": {
                        "query": {
                            "match": {
                                "token": token
                            }
                        }
                    }
                };
                Polymer.postData(link, param).then(res => {
                    if (res.code > 0) {
                        if (res.resolve) {
                            // let user = res.resolve[0];
                            // if (user.token = token) {
                            //     store.set('change-user', user);

                            // }

                            let userid = res.resolve[0]['_id'];
                            let userEmail = res.resolve[0]['email'];
                            let userPW = res.resolve[0]['password'];

                            let paramtake = {
                                "action": "addData",
                                "index": "change",
                                "type": "_user",
                                "id": userid,
                                "body": {
                                    "token": ""
                                }
                            };
                            Polymer.postData(link, paramtake).then(res => {
                                if (res.code > 0) {
                                    console.log("add success");
                                    // location.reload();

                                    //**********AUTO LOGIN****************//
                                    let loginUrl = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                                    let params = {
                                        "action": "login",
                                        "login": userEmail,
                                        "password": userPW
                                    };
                                    Polymer.postData(loginUrl, params).then(res => {
                                        if (res.code > 0) {
                                            // console.log("ccc", res.resolve);
                                            alert("AUTO LOGIN SUCCESS!");
                                            if (res.resolve) {
                                                let user = res.resolve;
                                                console.log("user res.resolve", user);
                                                if (user.token == "" || user.token == null || user.token == undefined) {
                                                    store.set('change-user', user);
                                                    this._saveJson();
                                                }
                                            } else {
                                                console.log("ERR: no res.resolve!")
                                            }
                                        } else {
                                            alert("ERR: AUTO LOGIN Fail!");
                                        }
                                    });

                                }
                            });
                        };


                    }
                })


            },
            //for adding link to the user name connecting wth the databse
            ready: function() {
                console.log("READY HERE:");


            },


            _saveJson: function() {
                let that = this;
                let shadow = this.shadowRoot;
                let verifiedUser = store.get('change-user') || null;

                let uid = verifiedUser.id;
                let head = verifiedUser.head;

                let url = "/json/user-" + uid + ".json?id=" + new Date().getTime();
                Polymer.getContent(url).then(str => {
                    json = JSON.parse(str);
                    this.fileManager.saveFile('json/user-' + uid + '.json', JSON.stringify(json));
                });

            }
        });
    })();
</script>