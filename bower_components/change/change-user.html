<link href="../polymer/polymer.html" rel="import">
<link href="../dz-menu/css/style.html" rel="import" />
<link rel="import" href="../vaadin-tabs/vaadin-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../change/change-list.html">
<link rel="import" href="bower_components/change/change-addprod-butt.html">
<dom-module id="change-user">
    <template>
        <style include="icon-styles"></style>
        <style>
            #prods {
                margin-left: 8%;
                margin-right: 2%;
                margin-top: 2%;
                padding-top: 1%;
                padding-left: 2%;
                padding-right: 2%;
                padding-bottom: 2%;
                width:80%;
                background-color: white;
                display:inline-block;
                float: left;
            }
            #add{
                display: inline-block;
                width: 6%;
                position: relative;
                padding-top: 14%;
            }
            #container{
                float: left;
                background-color: #FFFBF2;
                width: 100%;
                padding-bottom: 30px;
            }
        </style>
        <div id="container">
            <div id="prods">
                <vaadin-tabs selected="{{page}}">
                    <vaadin-tab>我的貨物</vaadin-tab>
                    <vaadin-tab>我的選購清單</vaadin-tab>
                    <vaadin-tab>過去交易</vaadin-tab>
                </vaadin-tabs>
                <iron-pages selected="[[page]]">
                    <page id="page1">
                        <change-list id="mp">該用戶還沒有任何產品喔</change-list>
                    </page>
                    <page id= "page2">
                        <change-list id="fav">該用戶暫時沒有選購清單</change-list>
                    </page>
                    <page id="page3">
                        <change-list id="purch">該用戶從來沒有交易過</change-list>
                    </page>
                </iron-pages>
            </div>
            <div id="add">
                <change-addprod-butt></change-addprod-butt>
            </div>
        </div>
    </template>
</dom-module>
<script>
    (function() {
        Polymer({
            is: 'change-user',
            properties: {

            },
            created: function() {

            },
            ready: function() {
                let loc = location.search;
                console.log("Path", loc);
                console.log("Length", loc.length);
                let id = "";
                for (var i = 1; i < loc.length; i++) {
                    console.log("Working");
                    id += loc[i];
                }
                console.log("Problem", id);
                if (id != "") {
                    let shadow = this.shadowRoot;
                    params = {
                        "match": {
                            "ownerId": id
                        }
                    }
                    console.log("Params for Mine", params);
                    shadow.querySelector('#mp').query = params;
                    shadow.querySelector('#mp')._showMyGoods();
                    params = {
                        "match": {
                            "buyerId": id
                        }
                    }
                    shadow.querySelector('#purch').query = params;
                    let query = "";
                    let p = {
                        "action": "searchData",
                        "index": "change",
                        "type": "_user",
                        "body": {
                            "query": {
                                "match": {
                                    "_id": id
                                }
                            }
                        }
                    };
                    let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                    let x = 0;
                    let all;
                    Polymer.postData(url, p).then(res => {
                        if (res.code > 0) {
                        	let send = res.resolve[0];
                        	shadow.querySelector('#mp').user = send;
                        	shadow.querySelector('#fav').user = send;
                        	shadow.querySelector('#purch').user = send;
                            all = res.resolve[0]['likeProducts'];
                            x = all;
                        }
                    })

                    for (var i = 0; i < x; i++) {
                        query += '{"match": { "id": ' + all[i] + ' } }';
                        if (i != (x - 1)) {
                            query += ',';
                        }
                    }
                    if (query != "") {
                        params = '{"bool": {"should": [' + query + ']}}';
                        shadow.querySelector('#fav').query = params;
                        shadow.querySelector('#fav')._showMyGoods();
                    }
                    shadow.querySelector('#purch')._showMyGoods();
                } else {
                    let user = store.get('change-user') || null;
                    if (user != null) {
                        let shadow = this.shadowRoot;
                        params = {
                            "match": {
                                "ownerId": user['_id']
                            }
                        }
                        console.log("Params for Mine", params);
                        shadow.querySelector('#mp').query = params;
                        shadow.querySelector('#mp')._showMyGoods();
                        params = {
                            "match": {
                                "buyerId": user['_id']
                            }
                        }
                        shadow.querySelector('#purch').query = params;
                        let query = "";
                        let x = user['likeProducts'].length;
                        for (var i = 0; i < x; i++) {
                            query += '{"match": { "id": ' + user['likeProducts'][i] + ' } }';
                            if (i != (x - 1)) {
                                query += ',';
                            }
                        }
                        if (query != "") {
                            params = '{"bool": {"should": [' + query + ']}}';
                            shadow.querySelector('#fav').query = params;
                            shadow.querySelector('#fav')._showMyGoods();
                        }
                        shadow.querySelector('#purch')._showMyGoods();
                    }
                }
                this._checkEmpty();
            },

            _checkEmpty: function() {
                let shadow = this.shadowRoot;
                console.log("Check Empty is running received");
                shadow.querySelector('#fav')._showMyGoods();
            }
        });
    })();
</script>