<link href="../polymer/polymer.html" rel="import">
<link href="../dz-menu/css/style.html" rel="import" />
<dom-module id="change-like">
    <template>
        <style>
            #toggle-heart{
                position: absolute;
                left: -100vw;}
         
            [for = toggle-heart] {
               
               
            }

            .like-img{
                width:20px;
                height:20px;
                background-size: contain;                
                background-repeat: no-repeat;
                background-size: contain;
                cursor: pointer;
                border:none;
                background-color: transparent;
                color: transparent;
                margin-top:10px;
                margin-right:10px;
            }

            [id = "toggle-heart"]:checked + label{
               background-color: red;
            }
        </style>
        <style include="icon-styles"></style>
        <div id="container">
            <input on-click="checklogin" id="toggle-heart" type="checkbox" />            
            <label for="toggle-heart">
                <img src="http://change.dazzle.website/img/symbol/like-outlined-110d8c524ae4580258130ea6f75ef84c.png" class="like-img">
                <span id="likes">0</span> 
            </label>
            
        </div>
    </template>
</dom-module>
<script>
    (function() {
        Polymer({
            is: 'change-like',
            properties: {
                like: {
                    "type": Number
                },
                id: {
                    "type": Number
                },
                status: {
                    "type": Boolean
                },
                "liked": {
                    "type": Array
                }
            },

            ready: function() {
                this.id = this.getAttribute('id');
                let that = this;
                let shadow = this.shadowRoot;

                let user = store.get('change-user') || null;

                let URL = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let param = {
                    "action": "getData",
                    "index": "change",
                    "type": "product",
                    "id": this.id
                };
                if (user != null) {
                    var paramuser = {
                        "action": "getData",
                        "index": "change",
                        "type": "_user",
                        "id": user['_id']
                    };
                };

                Polymer.postData(URL, param).then(res => {
                    if (res.code > 0) {
                        shadow.querySelector('#likes').innerHTML = res.resolve['like'];
                        this.like = res.resolve['like'];
                        Polymer.postData(URL, paramuser).then(res => {
                            if (res.code > 0) {
                                this.liked = res.resolve['likeProduct'];
                                let countlikeproduct = res.resolve['likeProduct'].length;
                                var counti2 = 0;
                                checked2 = false;
                                for (i = 0; i < countlikeproduct; i++) {
                                    if (res.resolve['likeProduct'][i] == this.id) {
                                        checked2 = true;
                                        console.log("found!!");
                                    } else {
                                        counti2++;

                                    }
                                }

                                if (checked2 == false) {} else {
                                    this.status = true;

                                }
                                shadow.querySelector('#toggle-heart').checked = this.status;
                                console.log("the statuts:", this.shadowRoot.querySelector('#toggle-heart').checked, this.id);


                            }
                        });

                    } else {
                        console.log('error in change-like')
                    }
                });


            },

            checklogin: function() {
                let user = store.get('change-user') || null;
                if (user != null) {
                    this.addCount();

                } else {
                    alert("請先登入");
                    this.shadowRoot.querySelector('#toggle-heart').checked = false;
                }
            },



            addCount: function() {
                let that = this;
                let shadow = this.shadowRoot;
                let user = store.get('change-user') || null;

                let URL = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";


                let param = {
                    "action": "updateData",
                    "index": "change",
                    "type": "product",
                    "id": this.id,
                    "body": {
                        "query": {
                            "script": {
                                "source": "ctx._source['like']+=1"
                            }
                        }
                    }
                };

                let param2 = {
                    "action": "updateData",
                    "index": "change",
                    "type": "product",
                    "id": this.id,
                    "body": {
                        "query": {
                            "script": {
                                "source": "ctx._source['like']-=1"
                            }
                        }
                    }
                };


                if (shadow.querySelector('#toggle-heart').checked != true) {
                    shadow.querySelector('#likes').innerHTML = parseInt(shadow.querySelector('#likes').innerHTML) - 1;
                    Polymer.postData(URL, param2).then(res => {
                        if (res.code > 0) {
                            let storelikedproduct = this.liked;
                            let templikeproduct = [];
                            for (i = 0; i < storelikedproduct.length; i++) {
                                templikeproduct.push(storelikedproduct[i])
                            }
                            let storeposit = 0;

                            for (i = 0; i < storelikedproduct.length; i++) {
                                if (storelikedproduct[i] == this.id) {

                                    storeposit = i
                                }
                            }
                            templikeproduct.splice(storeposit, 1);
                            let paramchange = {
                                "action": "addData",
                                "index": "change",
                                "type": "_user",
                                "id": user['_id'],
                                "body": {
                                    "likeProduct": templikeproduct
                                }
                            };

                            Polymer.postData(URL, paramchange).then(res => {
                                if (res.code > 0) {
                                    user['likeProduct'] = templikeproduct;
                                    store.set('change-user', user);
                                    this.liked = templikeproduct;
                                } else {
                                    console.log("error in delete favorite")
                                }
                            });
                            console.log("reduced")
                        } else {
                            alert("fail to reduce")
                        }
                    });



                } else {
                    shadow.querySelector('#likes').innerHTML = parseInt(shadow.querySelector('#likes').innerHTML) + 1;

                    Polymer.postData(URL, param).then(res => {
                        if (res.code > 0) {

                            let paramchange2 = {
                                "action": "updateData",
                                "index": "change",
                                "type": "_user",
                                "id": user['_id'],
                                "body": {
                                    "query": {
                                        "script": {
                                            "source": "ctx._source['likeProduct'].add('" + this.id + "')"
                                        }
                                    }
                                }
                            };

                            console.log('the praram like is: ', paramchange2);
                            Polymer.postData(URL, paramchange2).then(res => {
                                if (res.code > 0) {

                                    this.liked.push(this.id);
                                } else {
                                    console.log("error in add favorite")
                                }
                            });
                            console.log("increase")
                        } else {
                            console.log("fail to increase");
                        }
                    });



                }




            },
        });
    })();
</script>