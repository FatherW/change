<link href="../polymer/polymer.html" rel="import">
<link href="../dz-menu/css/style.html" rel="import" />
<dom-module id="change-like">
    <template>
        <style>
            #toggle-heart{
                position: absolute;
                left: -100vw;}
         
            [for = toggle-heart] {
               
               
            }

            .like-img{
                width:20px;
                height:20px;
                background-size: contain;                
                background-repeat: no-repeat;
                background-size: contain;
                cursor: pointer;
                border:none;
                background-color: transparent;
                color: transparent;
                margin-top:10px;
                margin-right:10px;
            }

            [id = "toggle-heart"]:checked + label{
               background-color: red;
            }
        </style>
        <style include="icon-styles"></style>
        <div id="container">
            <input on-click="checklogin" id="toggle-heart" type="checkbox" />            
            <label for="toggle-heart">
                <img src="http://change.dazzle.website/img/symbol/like-outlined-110d8c524ae4580258130ea6f75ef84c.png" class="like-img">
                <span id="likes">0</span> 
            </label>
            
        </div>
    </template>
</dom-module>
<script>
    (function() {
        Polymer({
            is: 'change-like',
            properties: {
                like: {
                    "type": Number
                },
                id: {
                    "type": Number
                },
                status: {
                    "type": Boolean
                }
            },

            ready: function() {
                this._changecontent();

            },

            _changecontent: function() {
                this.id = this.getAttribute('id');
                let that = this;
                let shadow = this.shadowRoot;

                let user = store.get('change-user') || null;
                if (user != null) {
                    let countlikeproduct = user['likeProduct'].length;
                    var counti2 = 0;
                    checked2 = false;
                    console.log("the cookie store in user is,", user);
                    for (i = 0; i < countlikeproduct; i++) {
                        console.log("the user liked product is : ", user['likeProduct'][i], "and id now is,", this.id);
                        if (user['likeProduct'][i] == parseInt(this.id)) {
                            checked2 = true;
                            console.log("found!!")
                        } else {
                            counti2++;

                        }
                    }

                    if (checked2 == false) {
                        this.status = false;

                    } else {
                        this.status = true;

                    }
                    shadow.querySelector('#toggle-heart').checked = this.status;


                }






                let URL = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";



                let param = {
                    "action": "getData",
                    "index": "change",
                    "type": "product",
                    "id": this.id
                };



                Polymer.postData(URL, param).then(res => {
                    if (res.code > 0) {
                        shadow.querySelector('#likes').innerHTML = res.resolve['like'];
                        this.like = res.resolve['like'];

                    } else {
                        console.log('error in change-like')
                    }
                });





            },

            checklogin: function() {
                let user = store.get('change-user') || null;
                if (user != null) {
                    this.addCount();

                } else {
                    alert("請先登入");
                    this.shadowRoot.querySelector('#toggle-heart').checked = false;
                }
            },



            addCount: function() {
                this.id = this.getAttribute('id');
                let that = this;
                let shadow = this.shadowRoot;
                let URL = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let user = store.get('change-user') || null;


                let param = {
                    "action": "updateData",
                    "index": "change",
                    "type": "product",
                    "id": this.id,
                    "body": {
                        "query": {
                            "script": {
                                "source": "ctx._source['like']+=1"
                            }
                        }
                    }
                };

                let param2 = {
                    "action": "updateData",
                    "index": "change",
                    "type": "product",
                    "id": this.id,
                    "body": {
                        "query": {
                            "script": {
                                "source": "ctx._source['like']-=1"
                            }
                        }
                    }
                };

                if (this.status == shadow.querySelector('#toggle-heart').checked) {

                } else {
                    if (this.status == true) {

                        Polymer.postData(URL, param2).then(res => {
                            if (res.code > 0) {
                                console.log("reduced")
                            } else {
                                alert("fail to reduce")
                            }
                        });

                        let storelikedproduct = user['likeProduct'];
                        let templikeproduct = [];
                        for (i = 0; i < storelikedproduct.length; i++) {
                            templikeproduct.push(storelikedproduct[i])
                        }
                        let storeposit = 0;

                        for (i = 0; i < storelikedproduct.length; i++) {
                            if (storelikedproduct[i] == this.id) {

                                storeposit = i
                            }
                        }
                        templikeproduct.splice(storeposit, 1);
                        console.log(":the liked product is:", templikeproduct);
                        let paramchange = {
                            "action": "addData",
                            "index": "change",
                            "type": "_user",
                            "id": user['_id'],
                            "body": {
                                "likeProduct": templikeproduct
                            }
                        };

                        Polymer.postData(URL, paramchange).then(res => {
                            if (res.code > 0) {
                                user['likeProduct'] = templikeproduct;
                                store.set('change-user', user);
                                this._changecontent();
                            } else {
                                console.log("error in delete favorite")
                            }
                        });
                        this._changecontent();

                    } else {

                        Polymer.postData(URL, param).then(res => {
                            if (res.code > 0) {
                                console.log("increase")
                            } else {
                                console.log("fail to increase");
                            }
                        });

                        let storelikedproduct = user['likeProduct'];
                        let templikeproduct = [];
                        for (i = 0; i < storelikedproduct.length; i++) {
                            templikeproduct.push(storelikedproduct[i])
                        }

                        templikeproduct.push(parseInt(this.id));
                        let paramchange = {
                            "action": "addData",
                            "index": "change",
                            "type": "_user",
                            "id": user['_id'],
                            "body": {
                                "likeProduct": templikeproduct
                            }
                        };
                        console.log('the praram like is: ', paramchange);
                        Polymer.postData(URL, paramchange).then(res => {
                            if (res.code > 0) {
                                user['likeProduct'] = templikeproduct;
                                store.set('change-user', user);
                                this._changecontent();
                            } else {
                                console.log("error in add favorite")
                            }
                        });



                    }
                }



            },
        });
    })();
</script>