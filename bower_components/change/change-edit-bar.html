<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-button/vaadin-button.html">
<link rel="import" href="../vaadin-select/vaadin-select.html">
<link rel="import" href="../vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="change-status.html">

<dom-module id="change-edit-bar">
    <template>
        <style>
            * {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            header {
                background-image: url(http://change.dazzle.website/img/background/3.jpg);
                padding-top: 30px;
            }

            #tbar {
                display: none;
                justify-content: space-between;
                padding-top: 15px;
                padding-bottom: 25px;
                background: #F0F0F0;
                width: 92.5%;
                margin: 0 auto;
                border: 1px solid #ccc;
            }

            #edit {
                width: 100px;
                height: 35px;
                border: 1px solid #ccc;
                background-color: white;
                margin-right: 50px;
            }

            button {
                cursor: pointer;
                font-family: sans-serif, Microsoft JhengHei;
                font-size: 15px;
            }

            .left {
                margin-top: 11px;
                margin-left: 100px;
                display: inline-flex;
            }

            .right {
                margin-top: 11px;
                margin-right: 100px;
                display: inline-flex;
            }

            .buttons button {
                width: 100px;
                height: 35px;
                font-family: sans-serif, Microsoft JhengHei;
            }

            #copy {
                background-color: grey;
                margin-right: 25px;
                border: none;
                color: white;
            }

            #delete {
                background-color: grey;
                margin-right: 25px;
                border: none;
                color: white;
            }

            /* #save {
                background-color: #FF6B66;
                border: none;
                color: white;
            } */

            @media only screen and (max-width: 992px) {
            }

            @media only screen and (max-width: 640px) {
                #edit{
                    width: 60px;
                    margin-right: 10px;
                }

                .buttons button {
                    width: 60px;
                }

                .left{
                    margin-left: 10px;
                }

                .right {
                    margin-right: 0;
                }

                #copy {
                    margin-left: 25px;
                    margin-right: 10px;
                }
            }
        </style>
        <header>
            <div id="tbar">
                <div class="button left">
                    <a id="edi" href="#"><button id="edit">編輯</button></a>
                    <change-status></change-status>
                </div>

                <div class="buttons right">
                    <button id="copy" on-click="_copy">複製</button>
                    <button id="delete" on-click="_delete">刪除</button>
                    <!-- <button id="save">儲存</button> -->
                </div>
            </div>
        </header>
    </template>
</dom-module>

<script>
    //function for database
    (function() {
        Polymer({
            is: 'change-edit-bar',
            properties: {
                "id": {
                    "type": String
                },

                "valueArray": {
                    "type": Array
                }
            },

            ready: function() {
                let shadow = this.shadowRoot;
                let that = this;
                let loc = location.search;
                let pid = "";
                let uid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                }
                for (c = posit + 1; c < loc.length; c++) {
                    uid += loc[c];
                }
                console.log("Edit Bar ID", pid);
                this.id = pid;
                let user = store.get('change-user') || null;
                //Check whether login or not (not login -> hide)

                if (user['_id'] == uid || user['_id'] == 1) {
                    shadow.querySelector('#tbar').style.display = "flex";
                    this.shadowRoot.querySelector('#edi').href = "add-product.html?p" + this.id + "u" + uid;
                }

            },



            created: function() {


            },

            _delete: function() {
                console.log("DELETE FUNCTION IS WORKING")
                    // GET THE ITEM ID FROM THE URL
                let loc = location.search;
                let pid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                }
                //STORED PRODUCT ID
                console.log("ID", pid);

                //GET USER ID
                let user = store.get("change-user") || null;
                let tempid = user['_id'];

                //CALL DELETE FUNCTION AS IN POSTMAN
                let that = this;
                let shadow = this.shadowRoot;
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let params = {
                    "action": "deleteData",
                    "index": "change",
                    "type": "product",
                    "id": pid
                }

                //SEND THE ABOVE MESSAGE TO POSTMAN
                Polymer.postData(Url, params).then(res => {
                    console.log("check:", res.code);
                    if (res.code > 0) {
                        alert("STATUS: DELETE SUCCESSFUL");
                        location.replace("./user.html?" + user['_id']);
                    } else {
                        alert("STATUS: DELETE UNSUCCESSFUL");
                    }
                })

            },

            _copy: function() {
                console.log("COPY FUNCTION IS WORKING");

                //GENERATE UNIQUE TIME AS PRODUCT ID
                let a = Date.now();
                console.log("Timestamp", a);

                // GET THE ITEM ID FROM THE URL
                let loc = location.search;
                let pid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                }
                //STORED PRODUCT ID
                console.log("ID", pid);

                //CALL GETDATA FUNCTION AS IN POSTMAN
                let that = this;
                let shadow = this.shadowRoot;
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let params = {
                        "action": "getData",
                        "index": "change",
                        "type": "product",
                        "id": pid
                    }
                    //SEND THE ABOVE MESSAGE TO POSTMAN
                Polymer.postData(Url, params).then(res => {
                    if (res.code > 0) {
                        alert("STATUS: COPY SUCCESSFUL");
                        console.log("RES.RESOLVE", res.resolve);
                        // store.set("change-res", res.resolve);


                        // //PUT COPIED DATA BACK TO ADD PRODUCT PAGE
                        // shadow.querySelector('#vs1').value = res.resolve['categories'];
                        // // shadow.querySelector('#public').checked = res.resolve['isPublic'];
                        // shadow.querySelector('#free').checked = res.resolve['isFree'];
                        // shadow.querySelector('#vs4').value = res.resolve['isNew'];
                        // shadow.querySelector('#pname').value = res.resolve['productname'];
                        // shadow.querySelector('#price').value = res.resolve['price'];
                        // console.log("Matters", res.resolve[0]['price']);
                        // if (res.resolve[0]['price'] != "0") {

                        //     shadow.querySelector('#free').checked = false;
                        // }
                        // shadow.querySelector('#vs2').value = res.resolve['district'];
                        // shadow.querySelector('#vs3').value = res.resolve['deliveryMethod'];
                        // shadow.querySelector('#pdes').value = res.resolve['description'];
                        // shadow.querySelector('#myTags').tags = res.resolve['tags'];
                        // shadow.querySelector('#trans').value = res.resolve['deliveryDesc'];
                        // let lenpic = res.resolve[0]['pics'].length;
                        // for (i3 = 0; i3 < lenpic; i3++) {
                        //     shadow.querySelector('#div' + i3).style.backgroundImage = 'url(' + res.resolve[0]["pics"][i3] + ')'
                        // };
                        // //***USE SAVEDATA IN ADD PRODUCT***//

                        let user = store.get("change-user") || null;
                        let temptime = user['_id'];
                        let tempid = user['goodsNum'].toString() + Math.floor(Math.random() * 10);
                        if (location.search.length < 3) {
                            var thenewid = "" + temptime.toString() + tempid;
                        } else {
                            var thenewid = this.id;

                        }

                        let json = {
                            "action": "addData",
                            "index": "change",
                            "type": "product",
                            "id": thenewid,
                            "body": {
                                "id": thenewid,
                                "categories": res.resolve.categories,
                                "createTime": temptime,
                                "deliveryDesc": res.resolve.deliveryDesc,
                                "deliveryMethod": res.resolve.deliveryMethod,
                                "description": res.resolve.description,
                                "district": res.resolve.district,
                                "isFree": res.resolve.isFree,
                                "isNew": res.resolve.isNew,
                                "like": 0,
                                "ownerId": res.resolve.ownerId,
                                "pics": res.resolve.pics,
                                "price": res.resolve.price,
                                "productname": res.resolve.productname,
                                "tags": res.resolve.tags,
                                "sellerMsg": res.resolve.sellerMsg
                            }
                        };
                        //SEND THE ABOVE MESSAGE TO POSTMAN
                        Polymer.postData(Url, json).then(res => {
                            if (res.code > 0) {
                                console.log("POST TO POSTMAN SUCCESS!");
                                location.replace("./add-product.html?p" + thenewid + "u" + user['_id']);
                            } else {
                                console.log("POST TO POSTMAN  FAILED!")
                            }
                        });
                    } else {
                        alert("STATUS: COPY UNSUCCESSFUL");
                    }
                })

            }
        });
    })();
</script>