<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/polymer/polymer.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-select/vaadin-select.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="change-status.html">

<dom-module id="change-edit-bar">
    <template>
        <style>
            * {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            header {
                background-image: url(./img/background/3.jpg);
                padding-top: 30px;
            }

            #tbar {
                display: none;
                background: #F0F0F0;
                width: 92.5%;
                margin: 0 auto;
                border: 1px solid #ccc;
                padding: 30px 0;
            }

            .containerB {
                display: flex;
                width: 90%;
                margin: 0 auto;
                justify-content: space-between;
            }

            #edit {
                width: 100px;
                height: 35px;
                border: 1px solid #ccc;
                background-color: white;
                margin-right: 50px;
            }

            button {
                cursor: pointer;
                font-family: sans-serif, Microsoft JhengHei;
                font-size: 15px;
                width: 100px;
                height: 35px;
            }

            .buttonL {
                display: flex;
            }

            #copy {
                background-color: grey;
                border: none;
                color: white;
            }

            #delete {
                background-color: grey;
                border: none;
                color: white;
                margin-left: 50px;
            }

            @media only screen and (max-width: 992px) {}

            @media only screen and (max-width: 640px) {
                #edit {
                    width: 60px;
                    margin-right: 10px;
                    border: none;
                }

                .buttonR button {
                    width: 60px;
                }

                #delete {
                    margin-left: 10px;
                }
            }
        </style>
        <header>
            <div id="tbar">
                <div class="containerB">
                    <div class="buttonL">
                        <a id="edi" href="#"><button id="edit">編輯</button></a>
                        <change-status></change-status>
                    </div>

                    <div class="buttonR">
                        <button id="copy" on-click="_copy">複製</button>
                        <button id="delete" on-click="_delete">刪除</button>
                    </div>
                </div>
            </div>
        </header>
    </template>
</dom-module>

<script>
    //function for database
    (function() {
        Polymer({
            is: 'change-edit-bar',
            properties: {
                "id": {
                    "type": String
                },

                "valueArray": {
                    "type": Array
                }
            },

            ready: function() {
                let shadow = this.shadowRoot;
                let that = this;
                let loc = location.search;
                let pid = "";
                let uid = "";
                let posit = 0;
                for (i = 2; i < loc.length; i++) {
                    pid+=loc[i]
                };
            
                let user = store.get('change-user') || null;

                Polymer.getContent('/json/product-' + pid + '.json?id=' + new Date().getTime()).then(res=>{
                    res= JSON.parse(res);
                    if(res.ownerId == user['id'] || user.isAdmin == true){
                        shadow.querySelector('#tbar').style.display = "block";
                        this.shadowRoot.querySelector('#edi').href = "add-product.html?p" + this.id +
                            "u" + uid;
                    }
                })
                console.log("Edit Bar ID", pid);
                this.id = pid;
                //Check whether login or not (not login -> hide)
           

            },



            created: function() {

                this.user = store.get('change-user') || null;
                if (this.user) {
                    this.fileManager = new AwsPackage(this.user);
                    this.dataManager = new DataPackage('_user');
                    this.prodManager = new DataPackage('product');

                }

            },

            _delete: function() {
                console.log("DELETE FUNCTION IS WORKING")
                    // GET THE ITEM ID FROM THE URL
                let loc = location.search;
                let pid = "";
                let posit = 0;
                for (i = 2; i < loc.length; i++) {
                    pid+=loc[i]
                };
                
                //STORED PRODUCT ID
                console.log("ID", pid);

                //GET USER ID
                let user = store.get("change-user") || null;
                let tempid = user['_id'];

                //CALL DELETE FUNCTION AS IN POSTMAN
                let that = this;
                let shadow = this.shadowRoot;
                let Url =
                    "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let params = {
                    "action": "deleteData",
                    "index": "change",
                    "type": "product",
                    "id": pid
                }

                //SEND THE ABOVE MESSAGE TO POSTMAN
                Polymer.postData(Url, params).then(res => {
                    console.log("check:", res.code);
                    if (res.code > 0) {
                        //alert("STATUS: DELETE SUCCESSFUL");
                        location.replace("./user.html?" + user['_id']);
                    } else {
                        alert("STATUS: DELETE UNSUCCESSFUL");
                    }
                })

            },

            _copy: function() {

                //GENERATE UNIQUE TIME AS PRODUCT ID
                let a = Date.now();
                console.log("Timestamp", a);

                // GET THE ITEM ID FROM THE URL
                let loc = location.search;
                let pid = "";
                let posit = 0;
                for (i = 2; i < loc.length; i++) {
                    pid+=loc[i]
                };
                //STORED PRODUCT ID
                console.log("ID", pid);

                //CALL GETDATA FUNCTION AS IN POSTMAN
                let that = this;
                let shadow = this.shadowRoot;
                let url = "/json/product-" + pid + ".json?id=" + new Date().getTime();
                Polymer.getContent(url).then(res => {
                    res = JSON.parse(res);
                    console.log("copy json:", res)
                    var savej = res;
                    let user = store.get("change-user") || null;
                    let temptime = user['_id'];
                    let tempid = user['goodsNum'].toString() + Math.floor(Math.random() * 10);
                    var thenewid = "" + temptime.toString() + tempid;


                    let params = {
                        "action": "addproduct",
                        "categories": res.categories,
                        "sellerMsg": res.sellerMsg,
                        "productname": res.productname,
                        "price": parseInt(res.price),
                        "district": res.district,
                        "deliveryMethod": res.deliveryMethod,
                        "descrip": res.description,
                        "tag": res.tags,
                        "deliveryDesc": res.deliveryDesc,
                        "isNew": Boolean(res.isNew),
                        "ownerId": res.ownerId,
                        "pics": res.pics
                    };


                    let link =
                        "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";

                    //SEND THE ABOVE MESSAGE TO POSTMAN
                    Polymer.postData(link, params).then(res => {
                        console.log("CCC", params);
                        console.log("BBB", res.resolve);
                        if (res.code > 0) {
                            var theid = res.resolve.id;
                            var userid = res.resolve.ownerId;
                            console.log("POST TO POSTMAN SUCCESS!");
                            // alert("POST TO POSTMAN SUCCESS!");
                            this.savejson(savej, theid, userid);

                        } else {
                            console.log("POST TO POSTMAN  FAILED!")
                        }
                    });
                });


            },

            savejson: function(x, y, z) {
                let that = this;
                let user = store.get('change-user') || null;
                this.fileManager = new AwsPackage(user);

                // console.log("omg1:", x);
                // console.log("omg2:", y);
                // console.log("omg3:", z);

                this.fileManager.saveFile('json/product-' + y + '.json', JSON.stringify(x)).then(res => {
                    location.replace("./add-product.html?p" + y + "u" + z);
                    // console.log("save copy JSON success!");
                });

            }
        });
    })();
</script>