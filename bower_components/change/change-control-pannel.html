<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-text-field/vaadin-number-field.html">
<link rel="import" href="../vaadin-select/vaadin-select.html">
<link rel="import" href="../vaadin-button/vaadin-button.html">
<dom-module id="change-control-pannel">

    <template>

        <style>
            * {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            .container {
                /* background-image: url(./img/background/3.jpg); */

            }

            #controlbar {
                padding-top: 15px;
                padding-bottom: 25px;
                background: white;
                width: 84%;
                margin: 0 auto;
                margin-top: 25px;
            }

            .cp {
                text-align: center;
            }

            .miscount {
                text-align: center;
                margin: 35px 0 50px 0;
            }

            button {
                cursor: pointer;
                font-family: sans-serif, Microsoft JhengHei;
                font-size: 15px;
                width: 17%;
                border-radius: 3px;
            }

            .buttons {
                margin: 0 auto;
                text-align: center;
            }

            .buttons button {
                height: 50px;
                font-family: sans-serif, Microsoft JhengHei;
                margin-right: 30px;
                border: 1px solid #ccc;
                color: white;

                width: 150px;
            }

            #add {
                background-color: #ff9500;
            }

            #dq {
                background-color: #d9534f;
            }

            #recover {
                background-color: #71b758;
            }


            /* :host([part="input-field"]) {
                background-color: #7cd3da;
            } */

            /*******Fanpage Button*******/
            #manage {
                background-color: #7cd3da;
            }

            .dropbtn {
                background-color: #7cd3da;
                color: white;
                padding: 16px;
                font-size: 16px;
                border: none;
                cursor: pointer;
            }

            .dropdown {
                position: relative;
                display: inline-block;
            }

            .dropdown-content {
                display: none;
                position: absolute;
                background-color: #f9f9f9;
                min-width: 160px;
                box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
                z-index: 1;
            }

            .dropdown-content a {
                color: black;
                padding: 12px 16px;
                text-decoration: none;
                display: block;
            }

            .dropdown-content a:hover {
                background-color: #f1f1f1
            }

            .dropdown:hover .dropdown-content {
                display: block;
            }

            .dropdown:hover .dropbtn {
                background-color: #7cd3da;
            }


            /********manipulate vaadin-number-field buttons*********/
            /* vaadin-number-field::part(decrease-button)  {
                color: red;
            } */

            .save {
                width: 50px;
            }

            #info {
                width: 84%;
                margin: 0 auto;
            }

            .handIn {
                margin-right: 30px;
            }

            #info {
                display: none;
            }

            @media only screen and (max-width: 992px) {}

            @media only screen and (max-width: 640px) {
                #controlbar {
                    display: none;
                    width: 100%;
                }

                .buttons button {
                    margin-right: 10px;
                }

                button {
                    width: 20%;
                }
            }
        </style>

        <div class="container">

            <div id="controlbar" style="display: none;">
                <div class="cp">
                    <span>!管理面板!</span>
                </div>
                <div class="miscount">
                    <span>用戶犯錯次數:</span>
                    <vaadin-number-field value="0" min="0" has-controls id="mistake"></vaadin-number-field>
                    <button class="save" on-click="_save">儲存</button>
                </div>

                <div class="buttons">
                    <button id="add" on-click="_addFanPage">新增專頁</button>
                    <button id="dq" on-click="_disqualify">取消資格</button>
                    <button id="recover" on-click="_recovery">回復資格</button>
                    <button id="manage" on-click="_manageFanPage">管理專頁</button>

                    <!-- <vaadin-select id="manage" placeholder="管理專頁"></vaadin-select> -->
                    <!-- <div class="dropdown">
                        <button class="dropbtn" id="manage" on-click="_manageFanPage">管理專頁</button>
                        <div class="dropdown-content">
                            <a href="#">Link 1</a>
                            <a href="#">Link 2</a>
                            <a href="#">Link 3</a>
                        </div>
                    </div> -->
                    <!-- <vaadin-button id="manage" on-click="_manageFanPage">管理專頁</vaadin-button> -->
                </div>

                <div id="info">
                    <h5>專頁資料</h5>
                    <p class="inf">名稱: <span class="infotext" id="name">
                            <vaadin-text-field id='name1'></vaadin-text-field>
                        </span></p>
                    <p class="inf">地區: <span class="infotext" id="area">
                            <vaadin-select id='area1' label=''></vaadin-select>
                        </span></p>
                    <p class="inf">電郵: <span class="infotext" id="email2">
                            <vaadin-email-field id='email'>
                                </vaadin-text-field>
                        </span></p>
                    <p class="inf">標籤: <span id="contact">
                            <vaadin-text-field id='tag'></vaadin-text-field>
                        </span></p>
                    <p class="inf">網址: <span class="infotext" id="website">
                            <vaadin-text-field id='website2'></vaadin-text-field>
                        </span></p>
                    <div style="display: inline-flex;">
                        <vaadin-button id="vb" class="handIn" on-click="handin">提交</vaadin-button>
                        <vaadin-button id="vb" on-click="cancel">取消</vaadin-button>
                    </div>
                </div>
            </div>
        </div>
    </template>

</dom-module>

<script>
    (function() {
        Polymer({
            is: 'change-control-pannel',
            properties: {},


            created: function() {
                let user = store.get('change-user') || null;
                if (user.isAdmin) {
                    user["userBucket"] = "change.dazzle.website";
                    this.fileManager = new AwsPackage(user);
                    console.log('USERRRR', user);
                    console.log('是管理员账户');
                } else {
                    console.log('不是管理员账户');
                }
            },

            ready: function() {
                let shadow = this.shadowRoot;
                let that = this;

                let usercookies = store.get('change-user');
                let userID = usercookies['id'];

                // console.log("cookie", userID);
                let link = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let param = {
                    "action": "searchData",
                    "index": "change",
                    "type": "_user",
                    "body": {
                        "query": {
                            "match": {
                                "id": userID
                            }
                        }
                    }
                };
                Polymer.postData(link, param).then(res => {
                    if (res.code > 0) {
                        // console.log("CHECK",res.code);
                        let adminStatus = res.resolve[0].isAdmin;
                        if (Boolean(adminStatus) == true) {
                            console.log("This user is ADMIN!");
                            console.log("status", adminStatus);
                            shadow.querySelector("#controlbar").style.display = "block";

                        } else {
                            console.log("This user is NOT ADMIN!");
                        }
                    } else {
                        console.log("CANNOT SEARCH USER!");
                    }
                });

                //********Get back mistakes ocunt*********//
                let loc = location.search;
                let uid = "";
                for (i = 1; i < loc.length; i++) {
                    uid += loc[i];
                }
                // console.log("current uid", uid);
                let paramMistakes = {
                    "action": "getData",
                    "index": "change",
                    "type": "_user",
                    "id": uid
                };
                Polymer.postData(link, paramMistakes).then(res => {
                    if (res.code > 0) {
                        let mistake = res.resolve.mistake;
                        // console.log("BBB", mistake);
                        shadow.querySelector('#mistake').value = mistake;

                        //***SET PANNEL TO PINK BACKGROUND IF USER IS DISQUALIFIED***//
                        if (res.resolve.token == 1) {
                            shadow.querySelector('#controlbar').style.background = "pink";
                        }

                    } else {
                        alert("Err: Get user mistakes count!");
                    }
                });


                //***CSS fanpagebutton//
                // let selectbox = shadow.querySelector('#manage');
                // let selcetTextField = selectbox.shadowRoot.querySelector('vaadin-select-text-field');
                // let vaadinTextFieldContainer = selcetTextField.shadowRoot.querySelector('.vaadin-text-field-container');
                // let inputField = vaadinTextFieldContainer.shadowRoot.querySelector('.target');
                // console.log("CCC", vaadinTextFieldContainer);

                //SET AREA, DERLIVER METHOD, PRODUCT STATUS//
                this.valueArray = [""];
                customElements.whenDefined('vaadin-select').then(function() {
                    const district = [{
                        name: '中西區'
                    }, {
                        name: '灣仔區'
                    }, {
                        name: '東區'
                    }, {
                        name: '南區'
                    }, {
                        name: '油尖旺區'
                    }, {
                        name: '深水埗區'
                    }, {
                        name: '九龍城區'
                    }, {
                        name: '黃大仙區'
                    }, {
                        name: '觀塘區'
                    }, {
                        name: '葵青區'
                    }, {
                        name: '荃灣區'
                    }, {
                        name: '屯門區'
                    }, {
                        name: '元朗區'
                    }, {
                        name: '離島區'
                    }, {
                        name: '北區'
                    }, {
                        name: '大埔區'
                    }, {
                        name: '沙田區'
                    }, {
                        name: '西貢區'
                    }];

                    //AREA//
                    shadow.querySelector('#area1').renderer = function(root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        district.forEach(function(item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.name);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };
                });

                // //GET FANPAGE//
                // let parampage = {
                //     "action": "searchData",
                //     "index": "change",
                //     "type": "pages",
                //     "_source": "website",
                //     "body": {
                //         "query": {
                //             "match": {
                //                 "ownerId": 74

                //             }
                //         }
                //     }
                // };
                // Polymer.postData(link, parampage).then(res => {
                //     // console.log("BBB", usertokenId);
                //     // console.log("CCC working",res.resolve);
                //     let pagename = [];
                //     if (res.code > 0) {
                //         res.resolve.forEach(item => {
                //             pagename.push({
                //                 website: item['website']
                //             })
                //         })
                //         if (pagename.length == 0) {
                //             pagename.push({
                //                 name: "你沒有專頁噢"
                //             })
                //         }
                //         console.log("CCC working",pagename[0]);
                //         var fanpageN = ""
                //         let dropdown = shadow.querySelector('.dropdown-content');
                //         console.log('CCC', dropdown);
                //         let a = document.createElement('a');
                //         a.setAttribute('href', res.resolve.website);
                //         for (i = 0; i < parampage.length; i++) {
                //             fanpageN += pagename[i].toString();
                //             console.log('CCC', fanpageN);
                //         }


                //     }
                // })
            },

            handin() {
                ///////////////////////////////////////////
                ///////////////新增專頁寫在這裡///////////////
                ///////////////////////////////////////////
                let shadow = this.shadowRoot;
                let pagename = shadow.querySelector('#name1').value;
                console.log(pagename);
                let src = "_page-template";
                this.fileManager.copyFolder(src, pagename);
                let user = store.get('change-user');
                console.log("ccc", user['_id']);
                let link = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                let param = {
                    "action": "addFanPage",
                    "ownerId": user['_id'],
                    "name": pagename,
                    "website": shadow.querySelector('#website2').value,
                    "district": shadow.querySelector('#area1').value,
                    "email": shadow.querySelector('#email').value,
                    "tags": shadow.querySelector('#tag').value
                };
                console.log("yyyyyyyy", JSON.stringify(param));
                Polymer.postData(link, param).then(res => {
                    console.log("gggggggggg", res);
                    if (res.code > 0) {
                        console.log("完成");
                        shadow.querySelector('#info').style.display = "none";

                    }
                    alert(res.text);
                });

            },

            _addFanPage: function() {
                this.shadowRoot.querySelector('#info').style.display = "block";
            },

            cancel() {
                this.shadowRoot.querySelector('#info').style.display = "none";

            },

            _disqualify: function() {
                console.log("disqualify is working!")
                loc = location.search;
                let uid = "";
                for (i = 1; i < loc.length; i++) {
                    uid += loc[i];
                }
                // console.log("uid", uid);
                let params = {
                    "action": "addData",
                    "index": "change",
                    "type": "_user",
                    "id": uid,
                    "body": {
                        "token": "1"
                    }
                };
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                Polymer.postData(Url, params).then(res => {
                    if (res.code > 0) {
                        alert("取消了該用戶資格");

                        //PASS TO LAMBDA TO GENERATE EMAIL
                        let LambdaParams = {
                            "action": "cancelByUid",
                            "uid": uid
                        };
                        let link = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                        Polymer.postData(link, LambdaParams).then(res => {
                            console.log("PASS TO LAMBDA SUCCESS!");
                        });
                    }
                })
            },

            _recovery: function() {
                console.log("recovery is working!")
                loc = location.search;
                let uid = "";
                for (i = 1; i < loc.length; i++) {
                    uid += loc[i];
                }
                // console.log("uid", uid);
                let params = {
                    "action": "addData",
                    "index": "change",
                    "type": "_user",
                    "id": uid,
                    "body": {
                        "token": ""
                    }
                };
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                Polymer.postData(Url, params).then(res => {
                    if (res.code > 0) {
                        alert("回復了該用戶資格");

                        //PASS TO LAMBDA TO GENERATE EMAIL
                        let LambdaParams = {
                            "action": "recoverByUid",
                            "uid": uid
                        };
                        let link = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                        Polymer.postData(link, LambdaParams).then(res => {
                            console.log("PASS TO LAMBDA SUCCESS!");
                        });
                    }
                })
            },

            _manageFanPage: function() {
                console.log("manageFanPage is working!")
            },

            _save: function() {
                console.log("updated mistakes count!")

                let shadow = this.shadowRoot;
                let that = this;

                let count = shadow.querySelector('#mistake').value;
                console.log("Mistakes count:", count);

                let loc = location.search;
                let uid = "";
                for (i = 1; i < loc.length; i++) {
                    uid += loc[i];
                }
                // console.log("current uid", uid);

                params = {
                    "action": "addData",
                    "index": "change",
                    "type": "_user",
                    "id": uid,
                    "body": {
                        "mistake": count
                    }
                };
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                Polymer.postData(Url, params).then(res => {
                    alert("用戶犯錯次數已更新!");
                });
            }
        });
    })();
</script>