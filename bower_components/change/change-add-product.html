
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-select/vaadin-select.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/paper-tags-input/paper-tags-input.html">
<link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/vaadin-menu-bar/vaadin-menu-bar.html">
<!-- <link rel="import" href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/dz-file-management/dz-sub-img-stock.html"> -->
<link rel="stylesheet" href="">
<link href="https://d25k6mzsu7mq5l.cloudfront.net/bower_components/dz-menu/css/style.html" rel="import" />


<dom-module id="change-add-product">
    <template>
        <style include="icon-styles"></style>
        <style>
            *,
            p,
            span {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            /* SUBCAT */
            .container {
                display: flex;
                margin-top: 13px;
            }

            span {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            .result,
            span {
                margin: 9px 2px 0px 2px;

            }

            vaadin-menu-bar::part(container) {
                color: #ccc;
            }

            vaadin-menu-bar::part(menu-bar-button) {
                width: 150px;
            }

            /* SUBCAT */

            hr {
                max-width: 100px;
                margin-left: 0;
                margin-bottom: 10px;
            }

            ul {
                display: flex;
                margin-bottom: 0px;
            }

            li {
                list-style: none;
            }

            #gand {
                border-radius: 9999999999px;
            }

            .top-banner {
                margin-right: 1%;
                background: #FFE9BF;
                background-repeat: no-repeat;
                background-size: contain;
                height: 100%;
            }

            #banner3 {
                width: 100%;
                height: auto;
                display: block;
            }

            .change-new-product-container {
                display: grid;
                grid-template-columns: 1fr 0.8fr;
                height: auto;
                margin: 0 auto;
                background: white;
                width: 92.5%;
                border: solid 1px #ccc;
            }

            header {
                background-image: url("https://www.gettv.hk/img/background/3.jpg");
                padding-top: 30px;
            }

            #tbar {
                display: flex;
                justify-content: space-between;
                border: 1px solid #ccc;
                padding-top: 15px;
                padding-bottom: 20px;
                background: #F0F0F0;
                margin: 0 auto;
                width: 92.5%;
            }

            .custom-select select {
                width: 120px;
                padding: 3px;

            }

            #first {
                padding: 5px;
                margin-right: 25px;
            }

            :host([theme~="custom"][checked]) [part="checkbox"] {
                background-color: green;

            }

            #firstlabel {
                margin-right: 25px;
                margin-top: 22px;
                margin-left: 50px;
            }

            #secondlabel {
                margin-top: 22px;
                margin-left: 25px;
            }

            button {
                cursor: pointer;
            }

            .first {
                margin-right: 30px;
            }

            .buttons button {
                padding: 3px;
                margin-top: 20px;
            }

            #upload {
                border-radius: 0;
                padding: 8px;
                float: right;
                margin-top: 30px;
                min-block-size: fit-content;
                border: 1px solid #ccc;
                width: 22%;
                height: 40px;
                background-color: white;
            }

            .u {
                margin-right: 0;
            }

            #save {
                background-color: #FF6B66;
                padding: 10px 20px;
                margin-right: 25px;
                border: none;
                color: white;
            }

            #post {
                background-color: #ff8262;
                padding: 10px 20px;
                border: none;
                color: white;
            }

            .outer {
                margin: 0;
                width: 100%;
                background-image: url("https://www.gettv.hk/img/background/3.jpg");
                padding-bottom: 50px;
            }

            .left-pics {
                border-right: none;
                padding: 50px 10% 0 10%;
                height: auto;
                width: 80%;
            }

            .right-product {
                padding-top: 50px;
                height: auto;
                padding-bottom: 50px;
            }

            .bigPic,
            #div0 {
                height: 450px;
                background-image: url('https://www.gettv.hk/img/nopic.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center center;
                border: 1px solid #ccc;
            }


            .consmall {
                display: grid;
                grid-template-columns: 22% 22% 22% 22%;
                grid-column-gap: 4%;
                margin-top: 30px;
                height: 100px;
            }

            #div1,
            #div2,
            #div3,
            #div4 {
                height: 95%;
                background-image: url('https://www.gettv.hk/img/nopic.png');
                background-size: 100%;
                background-repeat: no-repeat;
                background-position: center center;
                border-style: solid;
                border: 1px solid #ccc;
                margin-top: 2px;

            }

            .fullWidth {
                width: 100%;
                margin-bottom: 10px;
                display: flex;
            }

            .sellerContact {
                margin-top: 40px;
                margin-bottom: 20px;
            }

            #sContact {
                resize: none;
                overflow: hidden;
                width: 99%;
                margin-top: 15px;
                border: 1px #ccc solid;
            }

            input[type=text],
            input[type=number] {
                padding: 10px 21px;
                margin-left: 15px;
                display: inline-block;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }

            input::-webkit-outer-spin-button,
            input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            #pname {
                margin-top: 4px;
                width: 80%;
            }

            #price {
                width: 63%;
            }

            #pdes {
                resize: none;
                overflow: hidden;
                width: 83.5%;
                border: 1px #ccc solid;
            }

            #trans {
                resize: none;
                overflow: hidden;
                width: 83.5%;
                border: 1px #ccc solid;
                margin-bottom: 30px;
            }

            #usericon {
                display: flex;
            }

            #a1 {
                display: inline-block;
                font-size: 15px;
            }

            #a2 {
                display: inline-block;
                font-size: 15px;
                margin-left: 5px;
            }

            #a1 img {
                width: 40px;
                height: 40px;
                border-radius: 9999999999999px;
            }

            #cs1 {
                width: 60px;
                height: 38px;
                padding: 5px;
                font-size: 13px;
            }

            #cs1 option {
                font-size: 13px;
            }

            .checked {
                color: orange;
            }

            .userinfo {
                display: flex;
                justify-content: space-between;
                margin-top: 20px;
            }

            .hkd {
                margin-top: 30px;
                margin-bottom: 20px;
            }

            .loca {
                margin: 20px 0 20px 0;
            }

            .del {
                margin-bottom: 20px;
            }

            #edit {
                width: 90px;
                height: 35px;
                border: 1px solid #ccc;
                background-color: white;
            }

            #location {
                width: 30px;
                height: 30px;
                background-image: url('https://www.gettv.hk/img/icon/location.png');
                background-size: cover;
                display: inline-block;
                margin-top: 15px;
            }

            #delivery {
                width: 30px;
                height: 30px;
                background-image: url('https://www.gettv.hk/img/icon/delivery.png');
                background-size: cover;
                display: inline-block;
                margin-top: 15px;
            }


            .bigsize {
                font-size: 25px;
                background-image: url(./img/);
                margin-top: 70px;
            }

            .tag {
                display: inline-block;
                margin-top: 10px;
            }

            .clearfix {
                display: flex;
            }

            .fanpage {
                margin-top: 11px;
                margin-left: 25px;
            }

            .tbar {
                display: flex;
                margin-left: 25px;
            }

            .outer {
                margin: 0;
                width: 100%;
                background-image: url("https://www.gettv.hk/img/background/3.jpg");
                padding-bottom: 50px;
            }

            @media only screen and (max-width: 768px) {
                .change-new-product-container {
                    display: grid;
                    grid-template-columns: 100%;
                    margin-bottom: 100px;

                }

                #save {
                    border-radius: 3px;
                    background-color: #FF6B66;
                    padding: 0px 0px;
                    margin-right: 0px;
                    border: none;
                    color: white;
                    width: 77px;
                    height: 35px;
                }

                .fanpage {
                    margin-top: 5px;
                    margin-left: 2px;
                }

                #secondlabel {
                    margin-top: 22px;
                    margin-left: 0px;
                }

                .left-pics {
                    border-right: none;
                    padding: 5px 10px 0 10px;
                    height: auto;
                    width: auto;
                }

                .tbar {
                    display: block;
                    margin-left: 10px;
                }

                .right-product {
                    padding-top: 50px;
                    height: auto;
                    padding-left: 13px;
                    padding-bottom: 50px;
                }

                .bigPic {
                    height: 300px;
                }
            }
        </style>
        <img id="banner3" src="./img/WX20200513-110548@2x.png">
        <!-- <div class="top-banner">
           
        </div> -->

        <header>
            <div id="tbar">
                <div class="tbar">

                    <div class="container">
                        <vaadin-menu-bar class="cat"></vaadin-menu-bar>
                        <p class="result"> : </p>
                        <span>{{prod.categories}}</span>
                    </div>

                    <div class="fanpage">
                        <vaadin-select id="fanPage" placeholder="専頁" value={{prod.fanpage}}></vaadin-select>
                    </div>

                    <vaadin-checkbox-group label="Label" theme="vertical" id="secondlabel">
                        <vaadin-checkbox theme="custom" value="1" id="free" checked={{prod.isFree}}>是否免費區
                        </vaadin-checkbox>
                    </vaadin-checkbox-group>

                </div>

                <div class="buttons first">
                    <button id="save" on-click="_saveData">發佈上架</button>
                </div>
            </div>
        </header>

        <div class="outer">
            <div class="change-new-product-container">
                <div class="left-pics">
                    <!-- 5pics -->
                    <div id="div0" class="bigPic productImg" data-id="0" on-click="_uploadFile">
                        <!-- <img src$="{{pics[0]}}" style="width:100%"/> -->

                    </div>
                    <div style="height: 100px;">

                        <!-- GG get Array Pic from Database -->
                        <div class="consmall">
                            <div id="div1" class="productImg" data-id="1" on-click="_uploadFile"></div>
                            <div id="div2" class="productImg" data-id="2" on-click="_uploadFile"></div>
                            <div id="div3" class="productImg" data-id="3" on-click="_uploadFile"></div>
                            <div id="div4" class="productImg" data-id="4" on-click="_uploadFile"></div>
                        </div>
                        <div class="buttons u">
                            <!-- <button id="upload" on-click="_uploadFile">上載圖片</button> -->
                        </div>
                        <vaadin-dialog></vaadin-dialog>
                    </div>

                    <div>
                        <div class="sellerContact">
                            <b style="font-size: 20px; color: black;">賣家聯絡資料:</b>
                        </div>
                        <!-- TEXT AREA-->
                        <div class="inputbox">
                            <textarea id="sContact" name="sellerContact" rows="15" placeholder="填寫你的聯絡資料等等"
                                value={{prod.sellerMsg}}></textarea>
                        </div>
                    </div>
                </div>

                <div class="right-product">
                    <!-- Right Product info -->
                    <div class="fullWidth">
                        <div class="custom-select">
                            <vaadin-select id="vs4" value="全新" style="width: 90px;"></vaadin-select>
                        </div>

                        <div style="width: 100%;">
                            <!--input box-->
                            <div class="inputbox">
                                <input type="text" id="pname" value={{prod.productname}} name="firstname"
                                    placeholder="輸入商品標題...">
                                <!-- maxlength="14" -->
                            </div>
                        </div>
                    </div>
                    <!-- <change-user-tag id$="{{owner._id}}"></change-user-tag> -->

                    <div class="userinfo">
                        <div id="usericon">
                            <div id="a1">
                                <img id="gand" src={{owner.head}}>
                                <!-- ./img/user_profile.png -->
                            </div>
                            <div id="a2">
                                <div class="name" id="owner">{{owner.username}}</div>
                            </div>
                        </div>
                    </div>

                    <div class="hkd" style="display: flex;">
                        <div class="dollar"><b style="font-size: 30px; color: black;">$</b></div>
                        <!--input box-->
                        <div class="inputbox">
                            <input type="number" id="price" name="priceHKD" placeholder="輸入商品價錢..."
                                value={{prodprice}}>
                        </div>
                    </div>
                    <hr>


                    <div class="loca" style="display: flex;">
                        <div id="location"></div>
                        <div style="margin-top: 11px; margin-left: 12px;">
                            <vaadin-select id="vs2" placeholder="選擇地區" value={{owner.area}}></vaadin-select>
                        </div>
                    </div>



                    <div class="del" style="display: flex;">
                        <div id="delivery"></div>
                        <div style="margin-top: 11px; margin-left: 12px;">
                            <vaadin-select id="vs3" placeholder="選擇發送方法" value={{prod.deliveryMethod}}></vaadin-select>
                        </div>
                    </div>

                    <hr>



                    <div class="">
                        <div style="margin-top: 20px; margin-bottom: 30px;"><span style="font-size: 20px;">產品描述:</span>
                        </div>
                        <!--typing box-->
                        <div class="inputbox">
                            <textarea id="pdes" value={{prod.description}} name="productdescription" rows="12"
                                placeholder="輸入商品描述..."></textarea>
                        </div>
                    </div>

                    <div style="display: flex; margin-top: 25px;">
                        <div class="tag">
                            <div><span style="font-size: 20px;"> 標籤： </span></div>
                        </div>

                        <!--Henry version-->
                        <vaadin-text-field id="inputTags" on-keydown="_addTags"></vaadin-text-field>
                        <paper-tags-input width="100%" id="myTags"></paper-tags-input>

                    </div>
                    <hr>

                    <div>
                        <div style="margin-top: 20px; margin-bottom: 30px;"><span class="bigsize">運輸：</span></div>
                        <!--input box-->
                        <div class="inputbox">
                            <textarea id="trans" value={{prod.deliveryDesc}} name="transportation" rows="6"
                                placeholder="輸入物流資料..."></textarea>
                        </div>

                    </div>
                    <br>
                </div>

            </div>
        </div>

    </template>

</dom-module>

<script>
    //function for database
    (function() {
        Polymer({
            is: 'change-add-product',
            properties: {
                "id": {
                    "type": String
                },

                "valueArray": {
                    "type": Array
                },

                "CATE": {
                    "type": String
                },

                next: {
                    "type": Number
                },

                "LIKE": {
                    "type": String
                },

                "OWNERID": {
                    "type": String
                },

                "CREATETIME": {
                    "type": String
                },

                "POSTSTATUS": {
                    "type": Boolean
                },

                "REPLYARRAY": {
                    "type": Array
                }

            },
            created: function() {
                let user = store.get('change-user') || null;
                if (!user){
                    alert("請先登入");
                    location.href = "/index.html";
                } else
                    this.fileManager = new AwsPackage(user);
                    
                this.user = user;
                let shadow = this.shadowRoot;
                this.bigPic = "http://change.dazzle.website.s3.amazonaws.com/files/1/1591944377549.jpeg";
                this.pics = [];
                this.pics[0] = this.bigPic;
                this.dataManager = new DataPackage('product');
                this.userManager = new DataPackage('_user');
                // this.fileManager = new AwsPackage(user);

                this.id = store.get('new-product-id') || null;
                

                this.product = store.get('new-product') || {"id": this.id};
                if (!this.id){
                    this.generateNewId();
                    this.product['ownerId'] = this.user['id'];
                    this.userManager.getDataByCache(this.product['ownerId']).then(res=>{
                        this.owner = res;
                    });
                }

                if (this.product['productname'])
                    this.reAlias();
    
                console.log('New ID',this.id,this.product);
                
                document.addEventListener('select-image', e => {
                    let Key = e.detail['Key'];
                    // this.pics.push(Key);
                    this.curElm.style.backgroundImage = 'url(' + Key + ')';
                    // console.log('Select Image', e, this.pics);
                    this.getAllPics();
                    this.closeDialog();
                });

                

                //CREATED ENDS HERE//
            },
            reAlias(){
                let alias = this.product['productname'];
                alias = alias.replace(/^\s+|\s+$/gm,'')
                alias = alias.replace(/ /gm,'-');
                alias = alias.replace(/\//gm,'-');

                this.dataManager.matchData({"productname":this.product['productname']}).then(res=>{
                    if (res.length>1)
                        this.product['alias'] = alias+res.length;
                    else
                        this.product['alias'] = alias;                    
                    
                    console.log('Change Alias');
                });
            },
            generateNewId(){
                let no = new Date().getTime() % 10000;
                let str; 
                this.fileManager.listFile('product/').then(res=>{
                    this.newId = String(no) + String(res.length +1);
                });
            },


            reNewPic(src) {
                let shadow = this.shadowRoot;
                let noImage = './img/1200px-No_image_3x4.svg.png';
                let i = 0;
                this.pics.forEach(item => {
                    shadow.querySelector('#div' + i).style.backgroundImage = 'url(' + this.pics[i] || noImage + ')';
                    i++;
                });

            },

            //Henery added//
            _addTags(e) {
                let myTags = this.shadowRoot.querySelector('#myTags');
                let val = this.shadowRoot.querySelector('#inputTags').value;
                // console.log('Key Down', e);

                if (e.code === "Enter") {
                    myTags._addTag(val);
                    this.shadowRoot.querySelector('#inputTags').value = "";
                }
                //console.log("arrayResult:", myTags.tags);
            },


            ready: function() {
                let user = store.get('change-user') || null;
                this.user = user;
                let that = this;
                let shadow = this.shadowRoot;
                let loc = location.search;
                let pid = this.id;
                let posit = 0;
                let uid = "";
                
                // for (i = 2; i < loc.length; i++) {
                //     pid += loc[i]
                // };
                // pid = document.head.querySelector('meta[name=product-id]').getAttribute('content') || null;
                

                if (pid) {
                    //edit mode

                        // res = JSON.parse(res);
                        res = this.product;
                        that.prod = res;
                        this.prodprice = res.price;
                        //SET PROPERTIES
                        this.CATE = res['categories'];
                        this.LIKE = res['like'];
                        this.CREATETIME = res['createTime'];
                        this.OWNERID = res['ownerId'];
                        this.POSTSTATUS = res['postStatus'];
                        this.REPLYARRAY = res['replyArray'];
                        this.ORDERLIST = res['orderlist'];

                        if (res['isNew'] == true) {
                            shadow.querySelector('#vs4').value = "全新";

                        } else {
                            shadow.querySelector('#vs4').value = "二手";

                        }
                        if (res['price'] != 0) {
                            shadow.querySelector('#free').checked = false;
                        }
                        if (typeof(res['tags']) == "string") {
                            shadow.querySelector('#myTags').tags = [res['tags']];

                        } else {
                            shadow.querySelector('#myTags').tags = res['tags'];

                        }
                        let lenpic = res['pics'].length;
                        for (i3 = 0; i3 < lenpic; i3++) {
                            shadow.querySelector('#div' + i3).style.backgroundImage = 'url(' + res["pics"][i3] + ')'
                        };
                        this.userManager.getDataByCache(this.product['ownerId']).then(res=>{
                            this.owner = res;
                        });
                    this.next = pid;
                } else {
                    //add mode
                    this.prodprice = '10';
                    this.owner = this.user;
                }

                // this.userManager.getDataByCache()

                that.vaadin_select();

                that.fanpage();
                that.submenu();

                //ENABLE & DISABLE PRICE
                shadow.querySelector('#free').addEventListener("click", (e) => {
                    if (shadow.querySelector('#free').checked == true) {
                        shadow.querySelector('#price').disabled = true;
                        shadow.querySelector('#price').value = 0;
                    } else if (shadow.querySelector('#free').checked == false) {
                        shadow.querySelector('#price').disabled = false;
                    }
                });

                // Add image selected function 
                shadow.querySelectorAll('.productImg').forEach(item=>{
                    item.selected = function(url,originUrl,smallUrl){
                        item.style.backgroundImage = 'url(' + url + ')';
                        Polymer.activeElement = null;
                        shadow.querySelector('vaadin-dialog').opened = false;
                    }
                });

                shadow.querySelector('#pname').addEventListener('blur',e=>{
                    let name = e.target.value;
                    console.log('Name',name);
                    that.product['productname'] = name;
                    that.reAlias();
                });

            },


            getAllPics() {
                let shadow = this.shadowRoot;
                this.pics = [];
                shadow.querySelectorAll('.productImg').forEach(item => {
                    let src = item.style.backgroundImage;
                    src = src.replace('url(', '').replace(')', '').replace(/\"/gi, "");
                    console.log('Src', src);
                    this.pics.push(src);
                });
            },

            _saveData: function() {


                let that = this;
                let shadow = this.shadowRoot;
                shadow.querySelector('#save').innerHTML = '上存中...';
                let user = store.get('change-user') || null;
                if (user != null || user['status'] == false) {
                    //*************GET INPUT PRODUCT VALUE*****************//
                    //Get value from select box categories
                    var categories = shadow.querySelector('span').textContent;
                    //Get value from select box fanpage


                    var fanpage = shadow.querySelector('#fanPage').value;
                    if (fanpage == "#$%!@&^(ntw" || fanpage == "") {
                        var ownerId = user['id'];
                    } else {
                        var ownerId = fanpage;
                    }
                    console.log(ownerId, "ggggggg");

                    //Get value from isFree button
                    let free = shadow.querySelector('#free').checked;
                    //Get Photos Array
                    this.getAllPics();
                    //Get value from seller message
                    let sellerContact = shadow.querySelector('#sContact').value;
                    //Get value from select box NewOld
                    var myselect = shadow.querySelector("#vs4");
                    var newOld = myselect.value;
                    if (newOld == "二手") {
                        var status = Boolean(0);
                    } else {
                        var status = Boolean(1);
                    }
                    //Get value from productName input box
                    let pname = shadow.querySelector('#pname').value;

                    //Get value from price input box
                    let price = shadow.querySelector('#price').value;

                    //Get value from select box district
                    var myselect = shadow.querySelector("#vs2");
                    var district = myselect.value;

                    //Get value from select box deliveryMethod
                    var myselect = shadow.querySelector("#vs3");
                    var method = myselect.value;

                    //Get value from productDescription input box
                    let pdes = shadow.querySelector('#pdes').value;

                    //Get value from input tags
                    //**tags is refering to the arrayValue**//
                    let tags = shadow.querySelector('#myTags').tags;
                    //Get value from deliveryDescription input box
                    let deldes = shadow.querySelector('#trans').value;
                    //*********GET INPUT PRODUCT VALUE ENDS HERE**************//
                    if (categories == " ") {
                        //now when categories is nth, it becomes "_", need to check this later!!
                        that.textchange("請選擇分類!");
                    } else {
                        if (pname == "") {
                            that.textchange("請輸入商品標題!");
                        } else {
                            if (tags.length == 0) {
                                that.textchange("請輸入標籤!");
                            } else {
                                let params = {
                                        "categories": categories,
                                        "sellerMsg": sellerContact,
                                        "productname": pname,
                                        "price": parseFloat(price),
                                        "district": district,
                                        "deliveryMethod": method,
                                        "descrip": pdes,
                                        "tag": tags,
                                        "deliveryDesc": deldes,
                                        "isNew": status,
                                        // "ownerId": ownerId,
                                        "pics": this.pics,
                                };
                                for (let k in params){
                                    this.product[k] = params[k];
                                }
                                this._save();


                                // let loc = location.search;
                                // if (loc == "") {
                                //     //******ADD PRODUCT MODE************//
                                //     let params = {
                                //         "action": "addproduct",
                                //         "categories": categories,
                                //         "sellerMsg": sellerContact,
                                //         "productname": pname,
                                //         "price": parseFloat(price),
                                //         "district": district,
                                //         "deliveryMethod": method,
                                //         "descrip": pdes,
                                //         "tag": tags,
                                //         "deliveryDesc": deldes,
                                //         "isNew": status,
                                //         "ownerId": ownerId,
                                //         "pics": this.pics,
                                //     };
                                //     // console.log("params:", params);
                                //     that.saveproduct(params);
                                // } else {
                                //     //*********EDIT PRODUCT MODE*************//
                                //     let json2ways = {
                                //         "id": this.id,
                                //         "categories": categories,
                                //         "sellerMsg": sellerContact,
                                //         "productname": pname,
                                //         "price": parseFloat(price),
                                //         "district": district,
                                //         "deliveryMethod": method,
                                //         "description": pdes,
                                //         "tags": tags,
                                //         "deliveryDesc": deldes,
                                //         "isFree": free,
                                //         "isNew": status,
                                //         "pics": this.pics,
                                //         "createTime": this.CREATETIME,
                                //         "like": this.LIKE,
                                //         "ownerId": this.OWNERID,
                                //         "postStatus": this.POSTSTATUS,
                                //         "replyArray": this.REPLYARRAY,
                                //         "orderlist": this.ORDERLIST
                                //     };
                                //     console.log("JSON2WAYS", json2ways);
                                //     that.editproduct(json2ways);
                                // }
                            }
                        }
                    }

                } else {
                    that.textchange("請先登入");
                }


            },

            _uploadFile: function(e) {
                let shadow = this.shadowRoot;
                let that = this;
                let elm = e.target;
                this.pics = [];
                let dialog = shadow.querySelector('vaadin-dialog');
                this.dialog = dialog;
                this.curElm = e.path[0];
                Polymer.activeElement = elm;
                Polymer.loadComponent('dz-file-management','dz-sub-img-stock');
                let dzPopup = document.createElement('dz-sub-img-stock');
                dzPopup.subUserId = this.user['id'];
                dzPopup.subUser = this.user;
                dzPopup.dialog = this.shadowRoot.querySelector('vaadin-dialog');
                Polymer.componentPopup(dzPopup,'90%','90%');

                // Polymer.popup(dialog, 'change', 'change-gallery', '90%', '90%');
                // console.log('saved', bucket)
            },

            closeDialog() {
                // let dialog = shadow.querySelector('vaadin-dialog');
                this.dialog.opened = false;
            },
            saveProductPage(){
                let that = this;
                    let html = document.createElement('html');
                    let head = document.createElement('head');
                    let body = document.createElement('body');

                    let meta = document.createElement('meta');
                    meta.setAttribute('name','product-id');
                    meta.setAttribute('content',this.id);
                    Polymer.getContent('/product.html').then(content=>{
                        parser = new DOMParser();
                        let doc = parser.parseFromString(content, "text/html");
                    
                        head.innerHTML = doc.head.innerHTML;
                        body.innerHTML = doc.body.innerHTML;
                        // body.innerHTML = 
                        console.log('HTML',head.innerHTML,body.innerHTML);

                        head.appendChild(meta);
                        html.appendChild(head);
                        html.appendChild(body);
                        console.log('Save Product',this.product);
                        // this.dataManager.saveData(this.id,this.product);
                        // this.fileManager.saveUserData('json/product-'+this.id+'.json',JSON.stringify(this.product));
                        this.fileManager.saveHtml('product/'+this.product['alias'],html.outerHTML);
                    });
            },
            _save(){
                // console.log('Product',this.product);
        

                this.dataManager.saveDataWithCache(this.product['id'],this.product).then(res=>{
                    this.addUserGoods(this.product['ownerId']);
                    this.saveProductPage();
                    console.log('Product',this.product);
                    alert('成功儲存');
                    location.href="/product/"+this.product['alias'];
                });
            },
            addUserGoods(uid){
                let userManager = new DataPackage("_user");
                let that = this;
                this.userManager.getDataByCache(uid).then(res=>{
                    res['goodsNum']++;
                    that.userManager.saveDataWithCache(uid,res);
                });
            },

            saveproduct(param) {
                let user = store.get('change-user') || null;
                let link = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                Polymer.postData(link, param).then(res => {
                    console.log("omgomgomg", res);
                    if (res.code < 0) {
                        console.log("omgomg", JSON.stringify(res.reject));
                    }
                    var newproductid = res.resolve.id;
                    console.log("omgomg1", newproductid);
                    console.log("omgomgomg", user);
                    if (res.code > 0) {
                        let paramup = {
                            "action": "updateData",
                            "index": "change",
                            "type": "_user",
                            "id": user['id'],
                            "body": {
                                "query": {
                                    "script": {
                                        "source": "ctx._source['goodsNum']+=1"
                                    }
                                }
                            }
                        };
                        console.log("omgomg2", paramup);
                        let link2 = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                        Polymer.postData(link2, paramup).then(res => {
                            console.log("omgomg3", res)
                            if (res.code > 0) {
                                this.dataManager.loadData(newproductid).then(res => {
                                    console.log("omgomg4", res);
                                    this.fileManager.saveFile('json/product-' + newproductid + '.json', JSON.stringify(res)).then(res => {
                                        location.replace("./edit-product.html?p" + newproductid);
                                    });

                                })
                            }
                        });
                    } else {
                        that.textchange(res.text);
                    }
                });
            },
            editproduct(param) {
                let user = store.get('change-user') || null;
                //********UPDATE DATABASE***********//
                let paramsDatabase = {
                    "action": "addData",
                    "index": "change",
                    "type": "product",
                    "id": this.id,
                    "body": param
                };
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                Polymer.postData(Url, paramsDatabase).then(res => {
                    if (res.code > 0) {
                        this.dataManager.loadData(this.id).then(res => {
                            this.fileManager.saveFile('json/product-' + this.id + '.json', JSON.stringify(res)).then(res => {
                                location.replace("./edit-product.html?p" + this.id );
                            });
                        })
                    }
                });
            },
            vaadin_select() {
                let shadow = this.shadowRoot;
                //SET AREA, DERLIVER METHOD, PRODUCT STATUS//
                this.valueArray = [""];
                customElements.whenDefined('vaadin-select').then(function() {
                    const district = [{
                        name: '中西區'
                    }, {
                        name: '灣仔區'
                    }, {
                        name: '東區'
                    }, {
                        name: '南區'
                    }, {
                        name: '油尖旺區'
                    }, {
                        name: '深水埗區'
                    }, {
                        name: '九龍城區'
                    }, {
                        name: '黃大仙區'
                    }, {
                        name: '觀塘區'
                    }, {
                        name: '葵青區'
                    }, {
                        name: '荃灣區'
                    }, {
                        name: '屯門區'
                    }, {
                        name: '元朗區'
                    }, {
                        name: '離島區'
                    }, {
                        name: '北區'
                    }, {
                        name: '大埔區'
                    }, {
                        name: '沙田區'
                    }, {
                        name: '西貢區'
                    }];

                    const delmthod = [{
                        name: '面交'
                    }, {
                        name: '運送'
                    }, {
                        name: '面交或運送'
                    }];

                    const status = [{
                        name: '全新'
                    }, {
                        name: '二手'
                    }];


                    //AREA//
                    shadow.querySelector('#vs2').renderer = function(root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        district.forEach(function(item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.name);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };

                    //DELIVER METHOD//
                    shadow.querySelector('#vs3').renderer = function(root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        delmthod.forEach(function(item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.name);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };

                    //PRODUCT STATUS//
                    shadow.querySelector('#vs4').renderer = function(root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        status.forEach(function(item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.name);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };
                });

            },


            fanpage() {
                let shadow = this.shadowRoot
                let that = this;
                let parampage = {
                    "action": "searchData",
                    "index": "change",
                    "type": "_user",
                    "_source": "pagename",
                    "body": {
                        "query": {
                            "match": {
                                "adminId": this.user['id']

                            }
                        }
                    }
                };
                let loginUrl = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                console.log("fanpage json", JSON.stringify(parampage));
                Polymer.postData(loginUrl, parampage).then(res => {
                    // console.log("BBB", usertokenId);
                    if (res.code > 0) {
                        console.log('all fanpage,res.resolv', res.resolve);
                        let pagename = [];
                        res.resolve.forEach(item => {
                            pagename.push({
                                id: item['_id'],
                                name: item['pagename']
                            })
                        });
                        if (res.resolve.length == 0) {
                            pagename.push({
                                name: "沒有專頁可以選擇",
                                id: "#$%!@&^(ntw"
                            });

                        }
                        customElements.whenDefined('vaadin-select').then(function() {
                            const propage = pagename;
                            shadow.querySelector('#fanPage').renderer = function(root) {
                                // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                                if (root.firstChild) {
                                    return;
                                }
                                // Create the <vaadin-list-box>
                                const listBox = document.createElement('vaadin-list-box');
                                propage.forEach(function(item) {
                                    const vaadinItem = document.createElement('vaadin-item');
                                    vaadinItem.textContent = item.name;
                                    listBox.appendChild(vaadinItem);
                                    vaadinItem.setAttribute('value', item.id);
                                });
                                // update the content
                                root.appendChild(listBox);
                            };
                        });

                    } else {
                        alert("u");
                    }
                })

            },
            submenu() {
                let shadow = this.shadowRoot;
                customElements.whenDefined('vaadin-menu-bar').then(function() {
                    const menu = shadow.querySelector('vaadin-menu-bar');
                    menu.addEventListener('item-selected', function(e) {
                        // this.prod.categories = e.detail.value.text;
                        // this.CATE = e.detail.value.text;
                        shadow.querySelector('span').textContent = e.detail.value.text;
                        this.CATE = e.detail.value.text;
                    });

                    let c = {};
                    let arr = [];
                    let g = [];
                    let childarr = [];
                    let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                    let params = {
                        "action": "searchData",
                        "index": "change",
                        "type": "categories",
                        "body": {
                            "sort": [{
                                "_id": {
                                    "order": "asc"
                                }
                            }],
                            "query": {
                                "match_all": {}
                            }
                        }
                    };
                    Polymer.postData(url, params).then(res => {
                        if (res.code > 0) {
                            let a = res.resolve;
                            let arrchild = [];


                            for (i = 0; i < a.length; i++) {
                                if (a[i].parent == 0) {
                                    let b = a[i].name;
                                    // generate childarr
                                    for (x = 0; x < a.length; x++) {
                                        if (a[i].id == a[x].parent) {
                                            let j = a[x].name;
                                            let k = {
                                                "text": j
                                            };
                                            childarr.push(k);
                                        }
                                    }
                                    let c = {
                                        "text": b,
                                        "children": childarr
                                    };
                                    arr.push(c);
                                    childarr = [];


                                    let id = a[i].id;


                                }

                            }
                            let h = {

                                text: 'Project',
                                children: [{
                                    text: 'Users',
                                    children: [{
                                        text: 'List'
                                    }, {
                                        text: 'Add'
                                    }]
                                }, {
                                    text: 'Billing',
                                    children: [{
                                        text: 'Invoices'
                                    }, {
                                        text: 'Balance Events'
                                    }]
                                }, ]
                            };

                            g.push(h);
                        }

                    });
                    let i = [];
                    let h = {
                        text: '請選擇分類',
                        children: arr
                    };

                    menu.items = [h];

                });

            },
            textchange(test) {
                this.shadowRoot.querySelector('#save').innerHTML = '發佈上架';
                alert(test);
            },


        });
    })();
</script>