<link rel="import" href="../polymer/polymer.html">

<dom-module id="change-webcom">


    <template>

        <style>
            * {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            body {
                overflow: hidden;
            }

            #deleteall {
                align-items: center;
                text-align: center;
                padding-left: 10%;
                padding-right: 10%;
                font-family: sans-serif;
                font-family: Microsoft JhengHei;
                overflow: hidden;
            }

            #_changeicon {
                width: 90px;
                border-radius: 100%;

            }

            #para {
                color: black;
                font-size: 1rem;
                padding: 15px;
                top: 63px;
                left: 8px;
                color: black;
            }

            #review {
                height: 100px;
                width: 100%;

            }

            #click-button {
                background-color: #4CAF50;
                border: none;
                color: white;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                cursor: pointer;
                padding-top: 3%;
                width: 100%;
                text-align: center;
                padding-bottom: 3%;

            }

            #a1 {
                float: left;
                padding: 3%;
            }

            #a2 {
                font-size: 15px;
                padding-top: 5%;
            }

            #time {
                font-size: 24px;
                color: black;
                font-weight: 550;
            }

            #usericon {
                height: 100px;
                margin-bottom: 12px;
                margin-top: 12px;
                border-radius: 6px;
                padding-top: 3px;
                padding-bottom: 3px;
                width: 100%;
            }

            #owner {
                font-size: 20px;
                font-weight: bold;
            }
        </style>
        <div id="deleteall">

            <div style="float: right;">
                <button id="back"
                    style="border: none; background-color: white; margin-top: 10px; font-size: 15px; cursor: pointer; position: absolute; margin-left: 20px;">X</button>
            </div>
            <div id="usericon">
                <div id="a1">
                    <img id="_changeicon" src="https://www.gettv.hk/img/user_profile.png">
                </div>
                <div id="a2">
                    <div class="name" id="owner">1234</div>
                    <div id="time">評分/人數:</div>
                </div>
            </div>
            <div id='para'>
                Loading....
            </div>
            <vaadin-text-area id="review" placeholder="留言給賣家"></vaadin-text-area>
            <button id="click-button" on-click="_postRequest">送出</button>
        </div>
    </template>

</dom-module>

<script>
    (function() {
        Polymer({
            is: 'change-webcom',
            properties: {

            },
            created: function() {

                this.user = store.get('change-user') || null;
                if (this.user) {
                    this.fileManager = new AwsPackage(this.user);
                    this.dataManager = new DataPackage('_user');
                    this.prodManager = new DataPackage('product');

                }


            },
            //for adding link to the user name connecting wth the databse
            ready: function() {
                let that = this;
                let loc = location.search;
                let pid = "";
                let uid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                }
                for (b = posit + 1; b < loc.length; b++) {
                    uid += loc[b];
                }

                let shadow = this.shadowRoot;
                let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let param = {
                    "action": "getData",
                    "index": "change",
                    "type": "_user",
                    "id": uid
                };

                Polymer.postData(url, param).then(res => {
                    if (res.code > 0) {
                        shadow.querySelector('#_changeicon').src = res.resolve['head'];
                        shadow.querySelector('#owner').innerHTML = res.resolve['username'];
                        shadow.querySelector('#time').innerHTML += res.resolve['score']; + '( ' + res.resolve['numberRate'] + ' )';
                    }
                })

                let param2 = {
                    "action": "getData",
                    "index": "change",
                    "type": "product",
                    "id": pid
                };
                Polymer.postData(url, param2).then(res => {
                    if (res.code > 0) {
                        shadow.querySelector('#para').innerHTML = res.resolve['description'];
                    }
                })

                shadow.querySelector('#review').addEventListener("keypress", function(e) {
                    var key = e.which || e.keyCode || 0;
                    if (key === 13) {
                        that._postRequest();
                    }

                });

                let cfmDialog = shadow.querySelector('#back');
                cfmDialog.addEventListener("click", (e) => {
                    console.log("close button is working");

                    // closing pop-up
                    var event = new CustomEvent('close-item-dialog', {});
                    document.dispatchEvent(event);

                });




            },

            sendmail(from,to,subject,html){
                let json ={
                        'from': from,
                        'to': to,
                        'subject':subject,
                        'html': html
                    }
                    let emailUrl = "https://9hhtm40jpe.execute-api.ap-northeast-1.amazonaws.com/sendemail/";

                    Polymer.postData(emailUrl, json).then(res => {
                    if (res.code > 0) {
                        alert('成功發送');
                    }
                })

            },
            _postRequest: function() {
                let shadow = this.shadowRoot;
                let loc = location.search;
                let pid = "";
                let sellerid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                };
                for (b = posit + 1; b < loc.length; b++) {
                    sellerid += loc[b];
                };
                let msg = shadow.querySelector('#review').value;
                let id = Date.now();
                let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";

                let buyer = store.get("change-user") || null;
                if (buyer == null) {
                    alert("請先登入");
                } else {
                    // this.fileManager = new Awspackage(buyer);

                    //******************************************************************************//
                    // Henry's Code
                    
                    // let to; // seller's Email
                    // let html;

                    // Polymer.getContent('/email-template/sendcontactemail.html').then(html=>{
                    //     html.replace("[[image]]",image);
                    //     html.replace("[[productname]]",productname);
                    //     // .......
                    //     this.sendmail('support@01power.net',to,'你有新的訊息',html);

                    // }); 
                    //******************************************************************************//







                    //POSTDATA TO CLOUD
                    console.log("BUYERID", buyer);
                    let buyerId = buyer['_id'];
                    let ab = buyerId;
                    let cd = pid.toString() + Math.floor((Math.random() * 10));
                    let orderId = "" + ab + cd.toString();
                    let emailurl = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                    let p = {
                        "action": "sendContactEmail",
                        "uid": sellerid,
                        "pid": pid,
                        "oid": orderId,
                        "contactinfo": msg
                    };

                    console.log("P", p);

                    Polymer.postData(emailurl, p).then(res => {
                        console.log("Please wait for seller response!");
                        location.reload();
                    });

                    //POSTDATA TO POSTMAN

                    let params = {
                        "action": "addorder",
                        "msg": msg,
                        "productId": pid,
                        "buyerId": buyerId
                    };
                    let paramproduct = {
                        "action": "updateData",
                        "index": "change",
                        "type": "product",
                        "id": pid,
                        "body": {
                            "query": {
                                "script": {
                                    "source": "ctx._source['replyArray'].add('" + orderId + "')"
                                }
                            }
                        }
                    };

                    let link = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                    Polymer.postData(link, params).then(res => {
                        if (res.code > 0) {
                            Polymer.postData(url, paramproduct).then(res => {
                                if (res.code > 0) {
                                    console.log("success add and update");
                                    this.prodManager.loadData(pid).then(res => {
                                        this.fileManager.saveFile('json/product-' + pid + '.json', JSON.stringify(res.resolve));
                                    });

                                } else {
                                    console.log("failupdate");
                                }
                            })
                        } else {
                            console.log("failadd order");
                        }
                    });
                }
            },

        });
    })();
</script>