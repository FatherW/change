<link rel="import" href="../polymer/polymer.html">

<dom-module id="change-webcom">


    <template>

        <style>
            * {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            body {
                overflow: hidden;
            }

            #deleteall {
                align-items: center;
                text-align: center;
                padding-left: 10%;
                padding-right: 10%;
                font-family: sans-serif;
                font-family: Microsoft JhengHei;
                overflow: hidden;
            }

            #_changeicon {
                width: 90px;
                border-radius: 100%;

            }

            #para {
                color: black;
                font-size: 1rem;
                padding: 15px;
                top: 63px;
                left: 8px;
                color: black;
            }

            #review {
                height: 100px;
                width: 100%;

            }

            #click-button {
                background-color: #4CAF50;
                border: none;
                color: white;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                cursor: pointer;
                padding-top: 3%;
                width: 100%;
                text-align: center;
                padding-bottom: 3%;

            }

            #a1 {
                float: left;
                padding: 3%;
            }

            #a2 {
                font-size: 15px;
                padding-top: 5%;
            }

            #time {
                font-size: 24px;
                color: black;
                font-weight: 550;
            }

            #usericon {
                height: 100px;
                margin-bottom: 12px;
                margin-top: 12px;
                border-radius: 6px;
                padding-top: 3px;
                padding-bottom: 3px;
                width: 100%;
            }

            #owner {
                font-size: 20px;
                font-weight: bold;
            }
        </style>
        <div id="deleteall">

            <div style="float: right;">
                <button id="back"
                    style="border: none; background-color: white; margin-top: 10px; font-size: 15px; cursor: pointer; position: absolute; margin-left: 20px;">X</button>
            </div>
            <div id="usericon">
                <div id="a1">
                    <img id="_changeicon" src="https://www.gettv.hk/img/user_profile.png">
                </div>
                <div id="a2">
                    <div class="name" id="owner">1234</div>
                    <div id="time">評分/人數:</div>
                </div>
            </div>
            <div id='para'>
                Loading....
            </div>
            <vaadin-text-area id="review" placeholder="留言給賣家"></vaadin-text-area>
            <button id="click-button" on-click="_postRequest">送出</button>
        </div>
    </template>

</dom-module>

<script>
    (function() {
        Polymer({
            is: 'change-webcom',
            properties: {
                seller: Object,
                product: Object
            },
            created: function() {

                this.user = store.get('change-user') || null;
                if (this.user) {
                    this.fileManager = new AwsPackage(this.user);
                    this.dataManager = new DataPackage('_user');
                    this.prodManager = new DataPackage('product');
                    this.orderManager = new DataPackage('order');
                }


            },
            loadUser(uid) {
                return new Promise(function(resolve, reject) {
                    Polymer.getContent('/json/user-'+uid+'.json?id='+new Date().getTime()).then(res=>{
                        resolve(JSON.parse(res));
                    },err=>{
                        this.userManager.loadData(uid).then(prod=>{
                            resolve(prod);
                        });
                    });
                    // this.fileManager.getFile('json/product-' + pid + '.json').then(res => {
                    //     let json = JSON.parse(res);
                    // });
                });
                

            },
            //for adding link to the user name connecting wth the databse
            ready: function() {
                let that = this;
                let loc = location.search;
                let pid = "";
                let uid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                }
                for (b = posit + 1; b < loc.length; b++) {
                    uid += loc[b];
                }

                console.log('User',this.seller);
                console.log('Product',this.product);
                let shadow = this.shadowRoot;
                // this.loadUser(uid).then(user=>{
                    shadow.querySelector('#_changeicon').src = this.seller['head'];
                    shadow.querySelector('#owner').innerHTML = this.seller['username'];
                    shadow.querySelector('#time').innerHTML += this.seller['score']; + '( ' + this.seller['numberRate'] + ' )';                    
                // });
                shadow.querySelector('#para').innerHTML = this.product['description'];

                shadow.querySelector('#review').addEventListener("keypress", function(e) {
                    var key = e.which || e.keyCode || 0;
                    if (key === 13) {
                        that._postRequest();
                    }
                });

                let cfmDialog = shadow.querySelector('#back');
                cfmDialog.addEventListener("click", (e) => {
                    console.log("close button is working");

                    // closing pop-up
                    var event = new CustomEvent('close-item-dialog', {});
                    document.dispatchEvent(event);

                });
                // this.saveOrder();
                // this.orderManager.getAllData().then(res=>{
                //     console.log('Order',res);
                // });


            },

            sendmail(from,to,subject,html){
                let json ={
                        'from': from,
                        'to': to,
                        'subject':subject,
                        'html': html
                    }
                    let emailUrl = "https://9hhtm40jpe.execute-api.ap-northeast-1.amazonaws.com/sendemail/";

                    Polymer.postData(emailUrl, json).then(res => {
                    if (res.code > 0) {
                        alert('成功發送');
                    }
                })

            },
            _postRequest: function() {
                let shadow = this.shadowRoot;
                let loc = location.search;
                let html;
                let pid = "";
                let sellerid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                };
                for (b = posit + 1; b < loc.length; b++) {
                    sellerid += loc[b];
                };
                let msg = shadow.querySelector('#review').value;
                let id = Date.now();

                let buyer = store.get("change-user") || null;
                let contactinfo = shadow.querySelector('#review').value;
                if (buyer == null) {
                    alert("請先登入");
                } else {
                    // this.fileManager = new Awspackage(buyer);

                    // Henry's Code
                    this.saveOrder();
                    let to = this.seller['email'];
                    let html;
                    
                        let image = this.product['pics'][0];
                        let productname = this.product['productname'];
                        let sellerImage = this.seller['head'];
                        let sellerName =  this.seller['username'];
                        let price =  this.product['price'];
                        let district =  this.product['district'];
                        let deliveryMethod = this.product['deliveryMethod'];
                        let deliveryMethod2 = this.product['deliveryMethod'];                       
                        let token = "1sd895ndsd";

                    Polymer.getContent('/email-template/sendcontactemail.html').then(html=>{
                        html = html.replace("[[image]]",image);
                        html = html.replace("[[productname]]",productname);
                        html = html.replace("[[sellerImage]]",sellerImage);
                        html = html.replace("[[sellerName]]",sellerName);
                        html = html.replace("[[price]]",price);
                        html = html.replace("[[district]]",district);
                        html = html.replace("[[deliveryMethod]]",deliveryMethod);
                        html = html.replace("[[deliveryMethod2]]",deliveryMethod);
                        html = html.replace("[[contactinfo]]",contactinfo);
                        html = html.replace("[[token]]",token);


                        // // .......
                        this.sendmail('support@01power.net',to,'你有新的訊息',html);
                        alert('電郵已發出');
                        // location.reload();

                    }); 

                }
            },
            saveOrder(){
                let arr = this.product['replyArray'];
                let id = 'order-'+this.product['id']+'-'+arr.length;
                let msg = this.shadowRoot.querySelector('#review').value;
                let json = {
                    "buyerId": this.user['id'],
                    "id": id,
                    "msg": msg,
                    productId: this.product['id'],
                    status: "已提交訂單",
                    submitTime: new Date().getTime()

                };
                this.orderManager.saveData(id,json);
                this.product['replyArray'].push(id);
                this.prodManager.saveData(this.product['id'],this.product);
                this.fileManager.saveFile('json/product-' + this.product['id'] + '.json', JSON.stringify(this.product));
                this.fileManager.saveFile('json/order-' + id + '.json', JSON.stringify(json));
            
            } 






                

        });
    })();
    </script>
   