<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="change-like.html?saldfs">
<link rel="import" href="change-things.html">



<dom-module id="change-itemspecial">
    <template>
        <style>
            * {
                font-family: sans-serif, Microsoft JhengHei;

            }

            

            hr.moremore {
                width: 70%;
                align-items: center;
            }

            a:link,
            a:visited {
                text-decoration: none;
                color: black;
            }

            a:hover {
                text-decoration: none;

            }


            .titlebutton {
                border-spacing: 50px;
            }

            .catbutton {
                background-color: #f9f9f9;
                text-align: center;
                padding-left: 13px;
                padding-right: 13px;
                border: none;
                width: 110px;
                height: 30px;
                border-radius: 15px;

            }

            .catbutton:hover {
                background-color: #d9d9d9;
                cursor: pointer;
            }


            #container {
                padding-top: 10px;
            }

            .itemsall {
                padding: 50px;
                width: 150px;
                height: 150px;
                background-repeat: no-repeat;

            }



            .profile-finger {
                width: 100%;
            }

            change-like {
                width: 15px;
                height: 15px;
            }

            .profile-grid {
                width: 84%;
                padding-left: 8%;
                padding-right: 8%;
                display: grid;
                grid-row-gap: 20px;
                grid-column-gap: 15px;
                grid-template-columns: 100%;
                grid-template-rows: 1fr 2fr 4fr;
                background-color: cornsilk;
                padding-top: 20px;
                padding-bottom: 20px;
            }

            .short-profile-grid {
                display: grid;
                grid-column-gap: 15px;
                grid-template-columns: 59% 12% 12% 12%;
                background-color: white;
                border: 2px solid gainsboro;
                padding: 30px;
                padding-left: 4%;
                padding-right: 4%;
            }

            .detail-profile-grid {
                display: grid;
                grid-row-gap: 10px;
                grid-template-rows: 2fr 1fr 1fr 1fr 1fr;
                background-color: white;
                border: 2px solid gainsboro;
                padding: 20px;
                padding-left: 4%;
                padding-right: 4%;
            }

            .things-profile {
                background-color: white;
                border: 2px solid gainsboro;
            }


            #a1,
            #a2 {
                display: inline-block;
                font-size: 15px;
            }

            #a3 {
                float: right;
            }

            .button {
                margin-left: 4%;
                margin-right: 4%;
                margin-top: 41px;
            }

            .buttonGray {
                width: 150px;
                background-color: gray;
                color: black;
                border-radius: 2px;
                height: 30px;
                font-size: 16px;
                margin-right: 10px;
            }

            #left1 {
                float: left;
            }

            #left2 {
                float: left;
            }

            #left3 {
                float: left;
            }

            #right1 {
                float: right;
            }

            #right2 {
                float: right;
                padding-top: 4px;
            }

            #right3 {
                float: right;
            }

            #right4 {
                float: right;
                padding-top: 4px;
            }



            /* @media (height > 600px) {
                body { line-height: 1.4; }
            } */



            .things-grid {
                display: grid;
                width: 100%;
                height: 100%;
                grid-row-gap: 15px;
                padding-bottom: 50px;
                grid-column-gap: 30px;
                grid-row-gap: 40px;
                grid-template-columns: repeat(4, 1fr);
                background-color: white;
            }

            change-item {
                width: 100%;

            }

            svg.title_tags {
                width: 100%;
                height: 30px;
                padding-top: 10px;

            }

            svg.s_title_tags {
                margin: 5px;
                height: 15px;
                width: 80px;
                border-radius: 2px;
                padding-top: 10px;


            }

            change-things {
                border: 0px solid gainsboro;
                /* padding: 16px; */
                height: 100%;
                width: 100%;
            }

            /* .itemspic{
                width:200px;
                height:180px;
                padding-top:20px;
                background-size: contain;
                background-position: center;
                text-align: center;
                background-repeat: no-repeat;
                align-items: center;

            } */

            .img {
                width: 270px;
                height: 230px;
                background-size: contain;
                background-position: center center;
                /* background-repeat: no-repeat; */
                margin: 1%;
                background-image: url(http://change.dazzle.website/img/channel_banner/1.jpg);
                background-repeat: no-repeat;

            }

            .time {
                font-size: 6px;
            }

            .circle {
                margin: 5px;
                height: 20px;
                width: 20px;


            }

            #cat_all {
                background-color: #efefef;
                text-align: center;
                padding-left: 13px;
                padding-right: 13px;
                border: none;
                width: 110px;
                height: 30px;
                border-radius: 15px;
            }

            #cat_all:hover {
                cursor: pointer;
            }

            #cat_all:hover {
                background-color: #999999;
            }

            .price {
                font-size: 13px;
                padding-top: 10px;
                padding-bottom: 10px;

            }

            .name {
                font-size: 13px;
            }

            .small {
                font-size: 15px;

            }

            #usericon {
                height: 40px;
            }

            .initemtitle {

                font-size: 25px;
                margin-left: 10px;
                font-weight: 900;
            }

            .productname2 {
                font-size: 15px;
                font-weight: 600;
                margin-top: 10px;

            }

            .addmoreitems:hover {
                text-decoration: underline;
                cursor: pointer;
            }

            .addmoreitems {
                align-items: center;
                border: none;
                background-color: transparent;
                font-size: 25px;
            }

            @media (max-width: 992px) {
                .things-grid-middle-mobile {
                    display: grid;
                    width: 100%;
                    height: 100%;
                    grid-row-gap: 15px;
                    padding-bottom: 50px;
                    grid-column-gap: 30px;
                    grid-row-gap: 40px;
                    grid-template-columns: repeat(3, 1fr);
                    background-color: white;
                }

            }

            @media (max-width: 768px) {
                .things-grid-small-mobile {
                    display: grid;
                    height: 100%;
                    grid-row-gap: 15px;
                    padding-bottom: 50px;
                    grid-column-gap: 15px;
                    grid-row-gap: 40px;
                    grid-template-columns: repeat(2, 1fr);
                    background-color: white;
                }
            }
            
        </style>



        <div class="titlebutton"></div>
        <svg class="title_tags">
            <polygon points="0,0 90,0 70,25 0,25" style="fill:#E84D4D;stroke:#E84D4D;stroke-width:0">
            </polygon>
            <text x="5" y="17" fill="white">最新商品</text>
        </svg>

        <div class="things-grid things-grid-small-mobile things-grid-middle-mobile" id="blank"></div>

        <div style="text-align: center; padding-bottom: 10px;">
            <vaadin-button on-click="displaymore" style="cursor: pointer;">更多</vaadin-button>
        </div>

    </template>

</dom-module>
<script async defer src="../moment/moment.js"></script>
<script>
    (function() {



        Polymer({
            is: 'change-itemspecial',
            properties: {
                "data": {
                    "type": Object
                },

                "allquery": {
                    "type": Array

                },

                "countitem": {
                    "type": Number
                },
                "res": {
                    "type": Array
                }



            },

            created: function() {
                let a = moment().format();
                let b = moment();

                // this.user = store.get('change-user') || null;
                // if (this.user)
                //     this.fileManager = new AwsPackage(this.user);

                // this.dataManager = new DataPackage('_user');
                // this.dataManager.getAllData().then(res=>{
                //         res.forEach(item=>{
                //             console.log('User',item);
                //             this.fileManager.saveFile('json/user-'+item['_id']+'.json',JSON.stringify(item));
                //         });
                // });

            },
            ready: function() {
                let that = this;
                let shadow = this.shadowRoot;
                this.countitem = 0;
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";

                var paidquery = {
                    "match": {
                        "isFree": false
                    }
                }

                let param = {
                    "action": "searchData",
                    "index": "change",
                    "type": "product",
                    "body": {
                        "sort": [{
                            "createTime": {
                                "order": "desc"
                            }
                        }],
                        "query": {
                            "bool": {
                                "must": paidquery,
                                "must_not": {
                                    'match': {
                                        "postStatus": false
                                    }
                                }
                            }
                        }
                    }
                };

                let paramdistrict = {
                    "action": "searchData",
                    "index": "change",
                    "type": "categories",
                    "body": {
                        "sort": [{
                            "_id": {
                                "order": "asc"
                            }
                        }],
                        "query": {
                            "match_all": {

                            }
                        }
                    }
                };

                Polymer.postData(Url, paramdistrict).then(res => {
                    if (res.code > 0) {
                        let cat = res.resolve;
                        let maincates = [];
                        let temsubcates = [];
                        cat.forEach(item => {
                            if (item.parent == "0") {
                                maincates.push(item);
                            } else {
                                temsubcates.push(item);
                            }
                        });
                        console.log("maincat", maincates);
                        let div = shadow.querySelector('.titlebutton');
                        maincates.forEach(main => {
                            let subcate = [];
                            temsubcates.forEach(sub => {
                                if (sub.parent == main._id) {
                                    subcate.push(sub.name);
                                }
                            });

                            let button = document.createElement('button');
                            button.setAttribute('class', 'catbutton');
                            button.innerHTML = main.name;
                            button.addEventListener('click', e => {
                                let cate2list = {
                                    "main": main.name,
                                    "sub": subcate
                                };
                                store.set('change-cate', cate2list);
                                location.href = '/list-product.html';
                            });
                            div.appendChild(button);

                        })
                        let button = document.createElement('button');
                        button.setAttribute('id', 'cat_all');
                        button.innerHTML = "所有類別";
                        button.addEventListener('click', e => {
                            store.set('change-cate', null);
                            location.href = '/list-product.html';
                        })
                        div.appendChild(button);

                    };

                });

                Polymer.postData(Url, param).then(res => {
                    if (res.code > 0) {
                        let prods = res.resolve;
                        this.res = res;
                        var storeId = [];
                        let check8 = 8;
                        if (prods.length - this.countitem < 8) {
                            check8 = prods.length - this.countitem;
                        }
                        for (var i = 0; i < check8; i++) {
                            let theidis = prods[i]['_id'];

                            storeId.push(theidis)
                        };


                        if (prods.length - this.countitem < 8) {
                            check8 = prods.length - this.countitem;
                        }
                        for (var i = 0; i < check8; i++) {
                            let current = shadow.querySelector('.things-grid').innerHTML;
                            current = current +
                                "<change-things id=\"" + storeId[i] + "\"></change-things>";

                            shadow.querySelector(".things-grid").innerHTML = current;
                        }
                        this.countitem = 8;

                    } else {
                        alert("error");
                    }

                })

                document.addEventListener('areachange', e => {
                    this.isfree(e.detail.isFree);
                });


            },
            isfree(isFree) {
                let that = this;
                let shadow = this.shadowRoot;
                this.countitem = 0;
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";

                var paidquery = {
                    "match": {
                        "isFree": isFree
                    }
                }

                let param = {
                    "action": "searchData",
                    "index": "change",
                    "type": "product",
                    "body": {
                        "sort": [{
                            "createTime": {
                                "order": "desc"
                            }
                        }],
                        "query": {
                            "bool": {
                                "must": paidquery,
                                "must_not": {
                                    'match': {
                                        "postStatus": false
                                    }
                                }
                            }
                        }
                    }
                };
                console.log("query", JSON.stringify(param));
                Polymer.postData(Url, param).then(res => {
                    if (res.code > 0) {
                        let prods = res.resolve;
                        this.res = res;
                        var storeId = [];
                        let check8 = 8;
                        if (prods.length - this.countitem < 8) {
                            check8 = prods.length - this.countitem;
                        }
                        for (var i = 0; i < check8; i++) {
                            let theidis = prods[i]['_id'];

                            storeId.push(theidis)
                        };


                        if (prods.length - this.countitem < 8) {
                            check8 = prods.length - this.countitem;
                        }
                        let current = "";
                        for (var i = 0; i < check8; i++) {
                            current = current +
                                "<change-things id=\"" + storeId[i] + "\"></change-things>";

                            shadow.querySelector(".things-grid").innerHTML = current;
                        }
                        this.countitem = 8;

                    } else {
                        alert("error");
                    }

                })


            },
            displaymore: function() {
                let that = this;
                let shadow = this.shadowRoot;


                if (this.res.code > 0) {
                    let prods = this.res.resolve;

                    var storeId = [];
                    let check8 = 8;
                    if (prods.length - this.countitem < 8) {
                        check8 = prods.length - this.countitem;
                    }
                    for (var i = this.countitem; i < this.countitem + check8; i++) {
                        let theidis = prods[i]['_id'];

                        storeId.push(theidis)

                    };


                    if (prods.length - this.countitem < 8) {
                        check8 = prods.length - this.countitem;
                    }

                    for (var i = 0; i < check8; i++) {
                        let addi = document.createElement('change-things');
                        addi.setAttribute('id', storeId[i])
                        shadow.querySelector(".things-grid").appendChild(addi);

                    }
                    this.countitem += 8;

                } else {
                    alert("error");
                }




            },






        });



    })();
</script>