<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="change-orderlist-storage.html">

<dom-module id="change-order-list">
    <template>
        <style>
            * {
                color: black;
                font-family: sans-serif;
            }

            .holder {
                width: 100%;
                border: 1px solid #ccc;
                height: auto;
                background-color: #F5F5F5;
                padding-top: 5px;
                padding-bottom: 5px;
                margin-bottom: 15px;
                margin-top: 20px;
                display: inline-flex;
            }

            #a1 {
                height: 50px;
                width: 50px;
                border-radius: 50%;
            }

            #a2 {
                width: 54%;
            }

            .in {
                display: inline;
                float: left;
                padding-left: 1.5%;
                padding-right: 1.5%;
            }

            .in img {
                width: 60px;
                margin-top: 5px;
            }

            .buttons {
                width: 9%;
            }

            button {
                width: 90%;
                margin-top: 15px;
                border: 1px solid #ccc;
                cursor: pointer;
                height: 35px;
                -webkit-box-shadow: 1px 0px 8px 0px rgba(50, 49, 56, 0.2);
                -moz-box-shadow: 1px 0px 8px 0px rgba(50, 49, 56, 0.2);
                box-shadow: 1px 0px 8px 0px rgba(50, 49, 56, 0.2)
            }

            #info {
                background-color: white;
            }

            .accept {
                background-color: #32CD32;
                color: white;
            }

            .accept2 {
                background-color: #32CD32;
                color: white;
                display: none;
            }

            .reject {
                background-color: red;
                color: white;
            }

            .reject2 {
                background-color: red;
                color: white;
                display: none;
            }

            .pointer {
                cursor: pointer;
                border: none;
                background: #efefef;
                display: none;
            }

            @media only screen and (max-width: 1400px) {
                #info {
                    display: none;
                }

                .pointer {
                    display: block;
                }
            }

            @media (max-width: 667px) {
                .accept {
                    display: none;
                }

                .accept2 {
                    display: block;
                }

                .reject {
                    display: none;
                }

                .reject2 {
                    display: block;
                }

                button {
                    width: 100%;
                }
            }
        </style>

        <!-- INFO ON THE LEFT -->
        <div class="holder" id="containall">

            <div class="in">
                <img id="a1" src="" alt="">
            </div>
            <div id="a2" class="in">
                <div class="name"></div>
                <div id="time"></div>
                <div id="message" style="overflow: hidden;"></div>
            </div>

            <!-- BUTTONS ON THE RIGHT -->
            <div class="in buttons hide1">
                <button id="info" on-click="buyerinfo">查看賣家信息</button>
                <button class="pointer" style="background: #f0f0f0; border-color: black;" on-click="buyerinfo">
                    <svg class="search" viewBox="0 0 24 24" style="height: 15px;">
                        <title>Search Icon</title>
                        <path fill="#57585a"
                            d="M15.618 17.032a9 9 0 1 1 1.414-1.414l5.675 5.675a1 1 0 0 1-1.414 1.414l-5.675-5.675zm-.701-2.05a1.017 1.017 0 0 1 .065-.065 7 7 0 1 0-.066.066z">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="in buttons hide2">
                <button class="accept" on-click="accept">接受</button>
                <button class="accept2" on-click="accept">✔</button>
            </div>
            <div class="in buttons hide3">
                <button class="reject" on-click="reject">拒絕</button>
                <button class="reject2" on-click="reject">X</button>
            </div>
        </div>

    </template>

</dom-module>

<script>
    (function () {
        Polymer({
            is: 'change-order-list',
            properties: {
                "id": {
                    "type": String
                },
                "buyerId": {
                    "type": String
                }
            },
            created: function () {

            },

            accept: function () {
                let loc = location.search;
                let pid = "";
                let uid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                }

                //POSTDATA TO POSTMAN
                let param = {
                    "action": "addData",
                    "index": "change",
                    "type": "order",
                    "id": this.id,
                    "body": {
                        "status": "處理中"
                    }
                };
                let urlP = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                console.log("Param", param)
                Polymer.postData(urlP, param).then(res => {
                    console.log("postdata to postman successfully!")
                });

                //POSTDATA TO LAMBDA
                let json = {
                    "action": "sendOrderEmail",
                    "uid": this.buyerId,
                    "pid": pid,
                    "oid": this.id
                };

                let urlL = 'https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc';
                Polymer.postData(urlL, json).then(res => {
                    if (res.code > 0) {
                        Polymer.postData(url, param).then(res => {
                            if (res.code > 0) {
                                console.log("傳到email了")
                            }
                        })
                    } else {
                        console.log("發送失敗")
                    }
                })
                this.shadowRoot.querySelector('#containall').innerHTML = "<H1>已聯絡賣家</H1>";
            },

            buyerinfo: function () {
                let theurl = '/user?' + this.buyerId;
                location.href = theurl;

            },

            reject: function () {
                let that = this;
                let shadow = this.shadowRoot;
                let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let param = {
                    "action": "deleteData",
                    "index": "change",
                    "type": "order",
                    "id": this.id
                }
                Polymer.postData(url, param).then(res => {
                    if (res.code > 0) {
                        console.log("Deleted Successfully");
                        shadow.querySelector('#containall').remove();
                    } else {
                        console.log("error inreject");
                    }
                })
            },


            ready: function () {
                this.id = this.getAttribute('id');


                // search for "order" data in postman
                let that = this;
                let shadow = this.shadowRoot;
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let params = {
                    "action": "searchData",
                    "index": "change",
                    "type": "order",
                    "body": {
                        "query": {
                            "match": {
                                "_id": this.id
                            }
                        }
                    }
                }

                Polymer.postData(Url, params).then(res => {
                    if (res.code > 0) {
                        //order Array
                        let orderLen = res.resolve.length;
                        this.buyerId = res.resolve[0]['buyerId'];
                        //INFO OF USERS INTERESTED TO ORDER//
                        let params2 = {
                            "action": "searchData",
                            "index": "change",
                            "type": "_user",
                            "body": {
                                "query": {
                                    "match": {
                                        "_id": this.buyerId
                                    }
                                }
                            }
                        };
                        Polymer.postData(Url, params2).then(res => {
                            //HEAD 
                            if (res.code > 0) {
                                shadow.querySelector('.name').innerText = res.resolve[0]['username'];
                                if (res.resolve[0]['head'] == "") {
                                    shadow.querySelector('#a1').src = "http://change.dazzle.website/img/head.svg";
                                } else {
                                    shadow.querySelector('#a1').src = res.resolve[0]['head'];
                                }

                            }
                        });
                        //TIME//
                        //check time
                        let _thetimenow = Date.now();
                        for (i = 0; i < orderLen; i++) {
                            var comparetime = (_thetimenow - res.resolve[i]['submitTime']) / 1000;
                            if (comparetime < 60) {
                                shadow.querySelector('#time').innerHTML = "剛剛"
                            } else if (comparetime / 60 < 60) {
                                shadow.querySelector('#time').innerHTML = Math.floor(comparetime / 60) + "分鐘前"
                            } else if (comparetime / 60 / 60 < 24) {
                                shadow.querySelector('#time').innerHTML = Math.floor(comparetime / 60 / 60) + "小時前"
                            } else if (comparetime / 60 / 60 / 24 < 7) {
                                shadow.querySelector('#time').innerHTML = Math.floor(comparetime / 60 / 60 / 24) + "日前"
                            } else if (comparetime / 60 / 60 / 24 / 7 < 30) {
                                shadow.querySelector('#time').innerHTML = Math.floor(comparetime / 60 / 60 / 24 / 7) + "星期前"
                            } else if (comparetime / 60 / 60 / 24 / 7 / 30 < 365) {
                                shadow.querySelector('#time').innerHTML = Math.floor(comparetime / 60 / 60 / 24 / 7 / 30) + "月前"
                            }

                        }

                        //message//
                        for (i = 0; i < orderLen; i++) {
                            shadow.querySelector('#message').innerHTML = res.resolve[i]['msg'];
                        }
                    }
                });

                //*******HIDE BUTTONS IF IT IS BUYERS*******//
                let loc = location.search;
                let pid = "";
                let uid = "";
                let posit = 0;
                for (i = 1; i < loc.length; i++) {
                    if (loc[i] == "u") {
                        posit = i;
                    };
                };
                for (a = 2; a < posit; a++) {
                    pid += loc[a];
                };
                for (i = posit + 1; i < loc.length; i++) {
                    uid += loc[i];
                }
                let user = store.get('change-user') || null;
                console.log("CCC CURRENT UID", user['_id']);
                console.log("CCC PRODUCT OWNER ID", uid);

                if (user['_id'] !== uid) {
                    shadow.querySelector('.hide1').style.display = "none";
                    shadow.querySelector('.hide2').style.display = "none";
                    shadow.querySelector('.hide3').style.display = "none";
                };

            },

        });
    })();
</script>