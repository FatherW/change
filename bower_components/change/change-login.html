<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-text-field/vaadin-email-field.html">
<link rel="import" href="../vaadin-text-field/vaadin-password-field.html">
<link rel="import" href="../vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="change-register.html">
<link rel="import" href="change-reset.html">
<!-- <meta name="google-signin-client_id" content="YOUR_CLIENT_ID.apps.googleusercontent.com"> -->



<dom-module id="change-login">

    <template>
        <style>
            .login-grid {
                text-align: center;
                display: grid;
                grid-row-gap: 5px;
                grid-column-gap: 1px;
                grid-template-columns: 40% 40%;
                grid-template-rows: repeat(7，1fr);
                justify-content: center;
                align-content: flex-end;
            }

            .font-sizeh1 {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 1;
                grid-row-end: 2;
                padding-top: 4%;
                font-size: 200%;
            }

            button.logoFacebook {
                grid-column-start: 1;
                grid-column-end: 2;
                grid-row-start: 2;
                grid-row-end: 3;
                height: 44px;
                width: 100%;
                background-color: #3B5998;
                color: white;
                border-radius: 3px;
                font-size: 100%;
            }

            img.logoFacebook {
                height: 25px;
                width: auto;
                background-color: #3B5998;
            }

            button.logoGoogle {
                grid-column-start: 2;
                grid-column-end: 3;
                grid-row-start: 2;
                grid-row-end: 3;
                height: 44px;
                width: 100%;
                border-radius: 3px;
                background-color: white;
                color: black;
                font-size: 100%;
            }

            img.logoGoogle {
                height: 25px;
                width: auto;
                background-color: white;
            }

            .email {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 3;
                grid-row-end: 4;
            }

            #changeEmail1 {
                width: 100%;
            }

            button#forgot {
                height: 40px;
                width: 100%;
                background-color: white;
                font-size: 12px;
                color: black;
                border: none;
                border-radius: 3px;
            }

            button#forgot:hover {
                text-decoration: underline;
                cursor: pointer;
            }

            button#forgot:active {
                text-decoration: underline;
                border: none;
            }

            .password {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 4;
                grid-row-end: 5;
            }

            #changePassword1 {
                width: 100%;
            }

            button.login-login {
                height: 40px;
                width: 100%;
                background-color: #F0846C;
                font-size: 130%;
                color: white;
                border: none;
                border-radius: 3px;
            }

            button.login-register {
                height: 40px;
                width: 100%;
                background-color: #F06C6C;
                font-size: 130%;
                color: white;
                border-radius: 3px;
                border: none;
            }

            #forgetPassword {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 7;
                grid-row-end: 8;
            }
        </style>
        <style include="icon-styles"></style>
        <div class="g-signin2" data-onsuccess="onSignIn"></div>
        <div class="login-grid">
            <span class="font-sizeh1">登入</span>
            <div>
                <button on-click="log" class="logoFacebook">
                    <img src="img/icon/Facebook.png" class="logoFacebook">&nbspFacebook
                </button>
            </div>
            <div>
                <button class="logoGoogle"><img src="img/icon/Google.png" class="logoGoogle">&nbspGoogle</button>
            </div>
            <div class="email">
                <vaadin-email-field id="changeEmail1" placeholder="Email" name=" email"
                    error-message="Please enter a valid email address" required clear-button-visible>
                </vaadin-email-field>
            </div>
            <div class="password">
                <vaadin-password-field id="changePassword1" placeholder="password" required>
                </vaadin-password-field>
            </div>
            <div>
                <button on-click="_login" class="login-login">登入</button>
            </div>
            <div>
                <button class="login-register" on-click="_register">註冊</button>
            </div>
            <span id="forgetPassword">
                <button id="forgot" on-click="_forgot">忘記密碼?</button>

            </span>
            <vaadin-dialog></vaadin-dialog>
        </div>
    </template>

</dom-module>
<script async defer src="https://connect.facebook.net/en_US/sdk.js"></script>
<script async defer src="https://apis.google.com/js/platform.js"></script>
<script>
    (function () {
        Polymer({
            is: 'change-login',
            properties: {

            },

            _forgot: function () {
                console.log('forgot password');
                let shadow = this.shadowRoot;
                let that = this;
                let dialog = shadow.querySelector('vaadin-dialog');
                Polymer.closeDialog(dialog)
                Polymer.popup(dialog, "change", "change-reset", "30%", "50%");
            },
            ready: function () {
                window.fbAsyncInit = function () {
                    FB.init({
                        appId: '711018846416860',
                        cookie: true,
                        xfbml: true,
                        version: '7.0'
                    });

                    FB.AppEvents.logPageView();

                };

                (function (d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0];
                    if (d.getElementById(id)) {
                        return;
                    }
                    js = d.createElement(s);
                    js.id = id;
                    js.src = "https://connect.facebook.net/en_US/sdk.js";
                    fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));


                // FB.init({
                //     appId: '711018846416860',
                //     autoLogAppEvents: true,
                //     xfbml: false,
                //     version: 'v7.0',
                //     status: true
                // });




                this.status = false;
                let that = this;
                this.shadowRoot.querySelector('#changePassword1').addEventListener("keypress", function (e) {
                    var key = e.which || e.keyCode || 0;
                    if (key === 13) {
                        that._login();
                    }

                });





            },

            log: function () {
                console.log("good");
                FB.login(function (response) {
                    console.log("response", response);
                    if (response.authResponse) {
                        console.log('Welcome!  Fetching your information.... ');
                        FB.api('/me', function (response) {
                            console.log('Good to see you, ' + response.name + '.');
                        });
                    } else {
                        console.log('User cancelled login or did not fully authorize.');
                    }
                }, {
                    scope: 'public_profile,email'
                });
            },

            checkLoginState: function () { // Called when a person is finished with the Login Button.
                FB.getLoginStatus(function (response) { // See the onlogin handler
                    statusChangeCallback(response);
                });
            },

            statusChangeCallback: function (response) { // Called with the results from FB.getLoginStatus().
                console.log('statusChangeCallback');
                console.log(response); // The current login status of the person.
                if (response.status === 'connected') { // Logged into your webpage and Facebook.
                    testAPI();
                } else { // Not logged into your webpage or we are unable to tell.

                }
            },

            testAPI: function () { // Testing Graph API after login.  See statusChangeCallback() for when this call is made.
                console.log('Welcome!  Fetching your information.... ');
                FB.api('/me', function (response) {
                    console.log('Successful login for: ' + response.name);
                });
            },

            _register: function () {
                console.log('Register');
                let shadow = this.shadowRoot;
                let that = this;
                let dialog = shadow.querySelector('vaadin-dialog');
                Polymer.popup(dialog, "change", "change-register", "40%", "90%");
            },

            _login: function () {
                let shadow = this.shadowRoot;
                let that = this;
                let uid = shadow.querySelector('#changeEmail1').value;
                let password = shadow.querySelector('#changePassword1').value;
                if (uid === "") {
                    alert('Email不可以為空');
                } else {
                    if (password === "") {
                        alert('密碼不可以為空');
                    } else {
                        let loginUrl = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                        let params = {
                            "action": "login",
                            "login": uid,
                            "password": password
                        };
                        console.log("Login JSON", params);
                        Polymer.postData(loginUrl, params).then(res => {
                            console.log("Login", res);
                            if (res.code > 0) {
                                console.log("Result1", res.resolve);
                                console.log("Result2", res.resolve.length);
                                if (res.resolve) {
                                    let user = res.resolve;
                                    if (user.token == "" || user.token == null || user.token == undefined) {
                                        store.set('change-user', user);
                                        location.reload();
                                    } else if (user.token == "1") {
                                        alert("你已經被取消了用戶資格")
                                    } else {
                                        alert("請先進行電郵驗證");
                                    }
                                } else {
                                    alert("用戶不存在，請註冊後登入");
                                }
                            } else {
                                alert('登入失敗');
                            }
                        });
                    }
                }
            },




        });
    })();
</script>