<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-text-field/vaadin-email-field.html">
<link rel="import" href="../vaadin-text-field/vaadin-password-field.html">
<link rel="import" href="../vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="change-register.html">
<link rel="import" href="change-reset.html">

<meta name="google-signin-scope" content="profile email">
<meta name="google-signin-client_id" content="755964351228-2emctcoq1o2nj5vpqitv4j28411jj7jk.apps.googleusercontent.com">

<!-- <meta name="google-signin-client_id" content="YOUR_CLIENT_ID.apps.googleusercontent.com"> -->



<dom-module id="change-login">

    <template>
        <style>

    #customBtn {
      display: inline-block;
      background: white;
      color: #444;
      width: 100%;
      border-radius: 5px;
      border: thin solid #888;
      box-shadow: 1px 1px 1px grey;
      white-space: nowrap;
    }
    #customBtn:hover {
      cursor: pointer;
    }
    span.label {
      font-family: serif;
      font-weight: normal;
    }
    span.icon {
      background: url('https://developers.google.com/identity/sign-in/g-normal.png') transparent 5px 50% no-repeat;
      display: inline-block;
      vertical-align: middle;
      width: 42px;
      height: 42px;
    }
    span.buttonText {
      display: inline-block;
      vertical-align: middle;
      font-size: 14px;
      font-weight: bold;
      /* Use the Roboto font that is loaded in the <head> */
    }


            .login-grid {
                text-align: center;
                display: grid;
                grid-row-gap: 5px;
                grid-column-gap: 1px;
                grid-template-columns: 40% 40%;
                grid-template-rows: repeat(7，1fr);
                justify-content: center;
                align-content: flex-end;
            }

            .font-sizeh1 {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 1;
                grid-row-end: 2;
                padding-top: 4%;
                font-size: 200%;
            }

            button.logoFacebook {
                grid-column-start: 1;
                grid-column-end: 2;
                grid-row-start: 2;
                grid-row-end: 3;
                height: 44px;
                width: 100%;
                background-color: #3B5998;
                color: white;
                border-radius: 3px;
                font-size: 100%;
            }

            img.logoFacebook {
                height: 25px;
                width: auto;
                background-color: #3B5998;
            }

            button.logoGoogle {
                grid-column-start: 2;
                grid-column-end: 3;
                grid-row-start: 2;
                grid-row-end: 3;
                height: 44px;
                width: 100%;
                border-radius: 3px;
                background-color: white;
                color: black;
                font-size: 100%;
            }

            img.logoGoogle {
                height: 25px;
                width: auto;
                background-color: white;
            }

            .email {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 3;
                grid-row-end: 4;
            }

            #changeEmail1 {
                width: 100%;
            }

            button#forgot {
                height: 40px;
                width: 100%;
                background-color: white;
                font-size: 12px;
                color: black;
                border: none;
                border-radius: 3px;
            }

            button#forgot:hover {
                text-decoration: underline;
                cursor: pointer;
            }

            button#forgot:active {
                text-decoration: underline;
                border: none;
            }

            .password {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 4;
                grid-row-end: 5;
            }

            #changePassword1 {
                width: 100%;
            }

            button.login-login {
                height: 40px;
                width: 100%;
                background-color: #F0846C;
                font-size: 130%;
                color: white;
                border: none;
                border-radius: 3px;
            }

            button.login-register {
                height: 40px;
                width: 100%;
                background-color: #F06C6C;
                font-size: 130%;
                color: white;
                border-radius: 3px;
                border: none;
            }

            #forgetPassword {
                grid-column-start: 1;
                grid-column-end: 3;
                grid-row-start: 7;
                grid-row-end: 8;
            }
        </style>
        <style include="icon-styles"></style>
        <div class="g-signin2" data-onsuccess="onSignIn"></div>
        <div class="login-grid">
            <span class="font-sizeh1">登入</span>
            <!-- <div>
                <button on-click="log" class="logoFacebook">
                    <img src="img/icon/Facebook.png" class="logoFacebook">&nbspFacebook
                </button>

                <div id="fb-root"></div>
                <div class="fb-login-button" data-size="large" data-button-type="login_with" data-layout="default"
                    data-auto-logout-link="false" data-use-continue-as="false" data-width=""></div>
            </div>
            <div>
                <div id="googlesignin">
                    <slot> </slot>
                </div>

                <button class="logoGoogle"><img src="img/icon/Google.png" class="logoGoogle">&nbspGoogle</button>
            </div> -->
            <div>
                <button on-click="log" class="logoFacebook">
                    <img src="img/icon/Facebook.png" class="logoFacebook">&nbspFacebook
                </button>

                <div id="fb-root"></div>

            </div>
            <div>
                <!-- <div id="gSignIn" class="g-signin2" data-onsuccess="onSignIn"></div> -->
                <div id="gSignInWrapper">
                    <div id="customBtn" class="customGPlusSignIn">
                      <span class="icon"></span>
                      <span class="buttonText">Google</span>
                    </div>
                  </div>
                <!-- <slot></slot> -->
            </div>

            <div class="email">
                <vaadin-email-field id="changeEmail1" placeholder="Email" name=" email"
                    error-message="Please enter a valid email address" required clear-button-visible>
                </vaadin-email-field>
            </div>
            <div class="password">
                <vaadin-password-field id="changePassword1" placeholder="password" required>
                </vaadin-password-field>
            </div>
            <div>
                <button on-click="_login" class="login-login">登入</button>
            </div>
            <div>
                <button class="login-register" on-click="_register">註冊</button>
            </div>
            <span id="forgetPassword">
                <button id="forgot" on-click="_forgot">忘記密碼?</button>

            </span>
            <vaadin-dialog></vaadin-dialog>
            <vaadin-dialog id="registerpop"></vaadin-dialog>

        </div>
    </template>

</dom-module>
<script async defer src="https://connect.facebook.net/en_US/sdk.js"></script>
<script async defer src="https://apis.google.com/js/platform.js"></script>
<script>
    (function() {
        Polymer({
            is: 'change-login',
            properties: {

            },
            created: function() {
                // this.innerHTML = `<div class="g-signin2" data-onsuccess="onSignIn"></div>`;

                this.userManager = new DataPackage('_user');
            },
            _forgot: function() {
                console.log('forgot password');
                let shadow = this.shadowRoot;
                let that = this;
                let dialog = shadow.querySelector('vaadin-dialog');
                Polymer.closeDialog(dialog)
                Polymer.popup(dialog, "change", "change-reset", "300px", "300px");
            },
            ready: function() {

                this.status = false;
                let that = this;
                this.shadowRoot.querySelector('#changePassword1').addEventListener("keypress", function(e) {
                    var key = e.which || e.keyCode || 0;
                    if (key === 13) {
                        that._login();
                    }

                });
                FB.getLoginStatus(function(response) {
                    console.log('FB', response);
                    if (response.status === "connected") {
                        //if we do have a non-null response.session, call FB.logout(),
                        //the JS method will log the user out of Facebook and remove any authorization cookies
                        that.log();
                    }

                    if (!response.session) {
                        // window.location = "/mysite/Login.aspx";
                        var googleUser = {};

                        gapi.load('auth2', function() {
                            // Retrieve the singleton for the GoogleAuth library and set up the client.
                            auth2 = gapi.auth2.init({
                                client_id: '755964351228-2emctcoq1o2nj5vpqitv4j28411jj7jk.apps.googleusercontent.com',
                                cookiepolicy: 'single_host_origin',
                                // Request scopes in addition to 'profile' and 'email'
                                //scope: 'additional_scope'
                            });
                            attachSignin(that.shadowRoot.querySelector('#customBtn'));
                        });

                        function attachSignin(element) {
                            console.log(element.id);
                            auth2.attachClickHandler(element, {},
                                function onSignIn(googleUser) {
                                    console.log("Signed in: " +
                                        googleUser.getBasicProfile());
                                    let name = googleUser.getBasicProfile().getName();
                                    let email = googleUser.getBasicProfile().getEmail();
                                    that.loginByThirdParty(name, email);
                                    // _fb_register(name, email)
                                },
                                function(error) {
                                    alert("Google登入需要先允許使用第三方Cookie");
                                });
                        }

                        return;


                    }

                });


                // this.shadowRoot.querySelector('#googlesignin').innerHTML = `<slot></slot>`


            },
            attached: function() {

            },
            _register(json) {
                let that = this;
                console.log('Register', json);
                // let user = new DataPackage("_user");

                return new Promise(function(resolve, reject) {
                    that.userManager.saveData(json['email'], json).then(res => {
                        console.log('Resolve');
                        resolve();
                    }, err => {
                        console.log('Reject');
                        reject();
                    });
                });


            },


            google() {

                document.querySelector('.g-signin2 .abcRioButtonContentWrapper').click();
            },
            log: function() {
                let url = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                console.log("good");
                let link = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let that = this;


                // user is now logged out
                FB.login(function(response) {
                    console.log("response", response);
                    if (response.authResponse) {
                        console.log('Welcome!  Fetching your information.... ');
                        FB.api('/me', {
                            fields: 'name, email'
                        }, function(response) {
                            console.log('Good to see you, ' + JSON.stringify(response) + '.' + response.email);
                            let email = response.email;
                            let name = response.name;
                            let head = "http://graph.facebook.com/" + response.id + "/picture?type=normal";

                            that.loginByThirdParty(name, email);
                            // let json = {
                            //     'email': email
                            // };
                            // that.userManager.matchDataNosort(json).then(res => {
                            //         // let all = res.resolve;
                            //         console.log(res);
                            //         let pw = generatePassword();
                            //         if (res.length)
                            //             that.logWithPasswd(email, res[0]['password']);
                            //         else {
                            //             that._fb_register(name, email).then(res => {
                            //                 that.logWithPasswd(email, '!@#$%^#$%');
                            //             });
                            //         }
                            //     },
                            //     err => {
                            //         console.log("error la change login");
                            //     });

                        });
                    } else {
                        console.log('User cancelled login or did not fully authorize.');
                    }
                }, {
                    scope: 'email'
                });



            },
            loginByThirdParty(name, email) {
                let that = this;
                let json = {
                    'email': email
                };
                that.userManager.matchDataNosort(json).then(res => {
                        // let all = res.resolve;
                        console.log(res);
                        let pw = generatePassword();
                        if (res.length)
                            that.logWithPasswd(email, res[0]['password']);
                        else {
                            that._fb_register(name, email).then(res => {
                                that.logWithPasswd(email, '!@#$%^#$%');
                            });
                        }
                    },
                    err => {
                        console.log("error la change login");
                    });
            },
            checkLoginState: function() { // Called when a person is finished with the Login Button.
                FB.getLoginStatus(function(response) { // See the onlogin handler
                    statusChangeCallback(response);
                });
            },

            statusChangeCallback: function(response) { // Called with the results from FB.getLoginStatus().
                console.log('statusChangeCallback');
                console.log(response); // The current login status of the person.
                if (response.status === 'connected') { // Logged into your webpage and Facebook.
                    testAPI();
                } else { // Not logged into your webpage or we are unable to tell.

                }
            },

            testAPI: function() { // Testing Graph API after login.  See statusChangeCallback() for when this call is made.
                console.log('Welcome!  Fetching your information.... ');
                FB.api('/me', function(response) {
                    console.log('Successful login for: ' + response);
                });
            },

            _fb_register(name, email) {
                let registerUrl = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                let params = {
                    "action": "changeregister",
                    "username": name,
                    "area": '全港',
                    "email": email,
                    "password": '!@#$%^#$%',
                    "isPromotionMsg": false,
                    "platform": "Facebook"
                };
                console.log("Params", params);
                return new Promise(function(resolve, reject) {

                    Polymer.postData(registerUrl, params).then(res => {
                        // alert(res.text);
                        console.log('Res', res);

                        // that.userManager.getAllData().then(re => {
                        //     console.log('Result', re);
                        // });

                        if (res.code > 0) {
                            resolve();
                            // console.log(res);
                            // this.fileManager = new AwsPackage(res.resolve);
                            // this.fileManager.saveFile('json/user-' + res.resolve.id + '.json', JSON.stringify(res.resolve));

                        } else
                            reject();
                    });
                });
            },

            // _register: function() {
            //     console.log('Register');
            //     let shadow = this.shadowRoot;
            //     let that = this;
            //     let dialog = shadow.querySelector('vaadin-dialog');
            //     Polymer.popup(dialog, "change", "change-register", "40%", "90%");
            // },

            _login: function() {
                let shadow = this.shadowRoot;
                let that = this;
                let uid = shadow.querySelector('#changeEmail1').value;
                let password = shadow.querySelector('#changePassword1').value;
                if (uid === "") {
                    alert('Email不可以為空');
                } else {
                    if (password === "") {
                        alert('密碼不可以為空');
                    } else {
                        this.logWithPasswd(uid, password);
                    }
                }
            },


            logWithPasswd: function(uid, password) {

                let loginUrl = "https://0fnc1pmdce.execute-api.ap-northeast-1.amazonaws.com/default/changeMiscFc";
                let params = {
                    "action": "login",
                    "login": uid,
                    "password": password
                };
                console.log("Login JSON", params);
                Polymer.postData(loginUrl, params).then(res => {
                    console.log("Login", res);
                    if (res.code > 0) {
                        console.log("Result1", res.resolve);
                        console.log("Result2", res.resolve.length);
                        if (res.resolve) {
                            let user = res.resolve;
                            // if (user.token == "" || user.token == null || user.token == undefined) {
                            store.set('change-user', user);
                            location.reload();
                            // } else if (user.token == "1") {
                            //     alert("你已經被取消了用戶資格");
                            // } else {
                            //     alert("請先進行電郵驗證");
                            // }
                        } else {
                            alert("用戶不存在，請註冊後登入");
                        }
                    } else {
                        // alert('登入失敗');
                    }
                });
            }

        });
    })();

    function handleSessionResponse(response) {
        //if we dont have a session (which means the user has been logged out, redirect the user)
        if (!response.session) {
            // window.location = "/mysite/Login.aspx";
            return;
        }

        //if we do have a non-null response.session, call FB.logout(),
        //the JS method will log the user out of Facebook and remove any authorization cookies
        FB.logout(handleSessionResponse);
    }

    function generatePassword() {
        var length = 8,
            charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
            retVal = "";
        for (var i = 0, n = charset.length; i < length; ++i) {
            retVal += charset.charAt(Math.floor(Math.random() * n));
        }
        return retVal;
    }

    function onSignIn(googleUser) {
        console.log("running google");
        var profile = googleUser.getBasicProfile();
        console.log("myprofile", profile);
        let param = {
            "platform": "Google",
            "name": profile.getName(),
            "email": profile.getEmail()
        };
        store.set("change-platform", param);
        document.querySelector('.googleloginname').click();
    }



    function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function() {
            console.log('User signed out.');
        });
    }
</script>