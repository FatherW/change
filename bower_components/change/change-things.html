<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="change-like.html">
<link rel="import" href="change-confirm.html">
<link rel="import" href="change-in-item.html">
<link rel="import" href="change-user-tag.html">
<link rel="import" href="change-item-tag.html">
<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../dz-dazzle/css/medium-editor.html">


<dom-module id="change-things">
    <template>
        <style include="medium-editor-styles"> </style>
        <style>
            #tagbutton {
                cursor: pointer;
                margin: 6px;
            }

            #status {
                width: 15px;
                height: 15px;
                background-color: rgb(242, 253, 55);
                border-radius: 100%;
            }

            a:link,
            a:visited {
                text-decoration: none;
                color: black;
            }

            a:hover {
                text-decoration: none;

            }

            #container {
                padding-top: 10px;
            }

            .jumpeditproduct:hover {
                border: none;
                border-radius: 5px;
                background-color: orangered;
            }

            .jumpeditproduct {
                border: none;
                border-radius: 5px;
                background-color: orange;

            }

            .jumpeditproduct2:hover {
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }

            .jumpeditproduct2 {
                border: none;
                border-radius: 5px;
                background-image: url(./img/delete.png);
                background-size: contain;
                height: 25px;
                width: 25px;
                background-repeat: no-repeat;

            }

            .itemsall {
                padding: 50px;
                width: 150px;
                height: 150px;
                background-repeat: no-repeat;

            }


            .profile-finger {
                width: 100%;
            }

            change-like {
                width: 15px;
                height: 15px;
                text-align: right;
            }

            .profile-grid {
                width: 84%;
                padding-left: 8%;
                padding-right: 8%;
                display: grid;
                grid-row-gap: 20px;
                grid-column-gap: 15px;
                grid-template-columns: 100%;
                grid-template-rows: 1fr 2fr 4fr;
                background-color: cornsilk;
                padding-top: 20px;
                padding-bottom: 20px;
            }

            #tagbutton {
                background-color: #e9e9e9;
                text-align: center;
                padding-left: 13px;
                padding-right: 13px;
                border: none;
                font-size: 10px;
                color: #c1c1c1;
                border-radius: 15px;

            }

            #tagbutton a {
                color: #808080;
            }

            .short-profile-grid {
                display: grid;
                grid-column-gap: 15px;
                grid-template-columns: 59% 12% 12% 12%;
                background-color: white;
                border: 2px solid gainsboro;
                padding: 30px;
                padding-left: 4%;
                padding-right: 4%;
            }

            .detail-profile-grid {
                display: grid;
                grid-row-gap: 10px;
                grid-template-rows: 2fr 1fr 1fr 1fr 1fr;
                background-color: white;
                border: 2px solid gainsboro;
                padding: 20px;
                padding-left: 4%;
                padding-right: 4%;
            }

            .things-profile {
                background-color: white;
                border: 2px solid gainsboro;
            }

            #time {
                font-size: 11px;
                color: #808080;
            }

            #a1,
            #a2 {
                display: inline-block;
                font-size: 15px;
                margin-left: 5px;
            }

            #a3 {

                float: right;
            }

            * {
                font-family: sans-serif, Microsoft JhengHei;

            }



            .button {
                margin-left: 4%;
                margin-right: 4%;
                margin-top: 41px;
            }

            .buttonGray {
                width: 150px;
                background-color: gray;
                color: black;
                border-radius: 2px;
                height: 30px;
                font-size: 16px;
                margin-right: 10px;
            }

            #left1 {
                float: left;
            }

            #left2 {
                float: left;
            }

            #left3 {
                float: left;
            }

            #right1 {
                float: right;
            }

            #right2 {
                float: right;
                padding-top: 4px;
            }

            #right3 {
                float: right;
            }

            #right4 {
                float: right;
                padding-top: 4px;
            }


            .things-grid {
                display: grid;
                width: 100%;
                height: 100%;
                grid-row-gap: 15px;
                padding: 50px;
                grid-column-gap: 50px;
                grid-row-gap: 40px;
                grid-template-columns: repeat(4, 1fr);
                background-color: white;
                -webkit-box-shadow: 0px 0px 11px 1px rgba(50, 49, 56, 1);
                -moz-box-shadow: 0px 0px 11px 1px rgba(50, 49, 56, 1);
                box-shadow: 0px 0px 11px 1px rgba(50, 49, 56, 1);

            }

            change-item {
                width: 100%;

            }

            svg.title_tags {
                width: 100%;
                height: 30px;
                padding-top: 10px;

            }

            svg.s_title_tags {
                margin: 5px;
                height: 16px;
                width: 60px;
                border-radius: 2px;
                padding-top: 10px;
                font-size: 80%;

            }

            change-things {
                border: 0px solid gainsboro;

                height: 100%;
                width: 100%;
            }

            .svg {
                background-image: url('./img/loading.svg');
                position: relative;
                background-size: 30px;
                background-position: center center;
                background-repeat: no-repeat;
                width: 100%;

            }


            #pics {

                position: relative;
                background-size: cover;
                background-position: center center;
                background-repeat: no-repeat;
                width: 100%;
                padding-top: 75%;
                /* 4:3 Aspect Ratio */

            }

            .img {
                width: 270px;
                height: 230px;
                background-size: contain;
                background-position: center center;
                /* background-repeat: no-repeat; */
                margin: 1%;
                background-image: url(./img/channel_banner/1.jpg);
                background-repeat: no-repeat;

            }

            .time {
                font-size: 6px;
            }

            .circle {
                margin: 5px;
                height: 20px;
                width: 20px;


            }

            .price {
                font-size: 13px;
                padding-top: 10px;
                padding-bottom: 10px;
                color: #666666;
                display: block;
            }

            .name {
                font-size: 13px;
                color: #1a1a1a;
            }

            .small {
                font-size: 15px;

            }

            #usericon {
                height: 40px;
                margin-bottom: 12px;
                margin-top: 12px;
                border-radius: 6px;
                padding-top: 3px;
                padding-bottom: 3px;
            }

            .initemtitle {

                font-size: 25px;
                margin-left: 10px;
                font-weight: 900;
            }

            .shouldhide {

                visibility: hidden;
            }

            img#_changeicon {
                width: 40px;
                height: 40px;
                border-radius: 9999999999999px;
            }


            .productname2 {
                font-size: 15px;
                font-weight: 600;
                margin-top: 10px;
                color: #505050;


            }

            .remove-product {
                position: absolute;
                top: 0px;
                right: 0px;
                z-index: 2;
            }

            .remove-product:hover {
                color: orange;
            }

            /* #deleteall{
                filter: blur(0);
            } */
            /* #deleteall{
                position:relative;  
            } */
            :host {
                position: relative;
            }
        </style>

        <i class="fa fa-minus-circle remove-product shouldhide" on-click="_deleteproduct"></i>
        <div id="deleteall" style="display: block;">
            <div style="display: flex; width:100%; position:relative;">
                <a style="width: 90%;" href$="{{userUrl}}">
                    <change-user-tag></change-user-tag>
                </a>
                <div class="shouldhide" style="display:flex;visibility: hidden;align-self: center;">
                    <!-- <button class="jumpeditproduct2" on-click="_deleteproduct"></button> -->
                    <div id="status1"></div>
                </div>
            </div>

            <a href$="{{detailUrl}}">
                <div class="svg">
                    <div id="pics" style="background-image:url({{pics}})">
                    </div>
                </div>
            </a>
            <svg class="s_title_tags" style="float: left;">
            </svg>
            <div id="templike">
                <change-like id$="{{id}}"></change-like>
            </div>
            <a href$="{{detailUrl}}">
                <div class="productname2" id="productname">
                    {{productname}}

                </div>
                <div id="price" class="price"> {{price}}
                </div>

            </a>
            <change-item-tag>
                <change-tag class="small" id="description"></change-tag>
                <div class="clear"></div>
            </change-item-tag>

            <div class="clear"></div>
            <vaadin-dialog id="tempqqq"></vaadin-dialog>
        </div>

    </template>
</dom-module>
<script>
    (function () {
        Polymer({
            is: 'change-things',
            properties: {
                like: {
                    "type": Object
                },
                id: {
                    "type": String
                },
                status: {
                    "type": Boolean
                },
                checkhide: {
                    "type": String
                },
                "pid": {
                    "type": String
                },
                "res": {
                    "type": String
                }

            },
            created: function () {

                document.addEventListener('close-item-dialog', e => {
                    if (this.shadowRoot.querySelector('#tempqqq' + this.id).opened == true) {

                        this.shadowRoot.querySelector('#tempqqq' + this.id).opened = false;
                        // console.log("(Btn) close successfully");
                    }
                });

                document.addEventListener('delete-item', e => {
                    if (this.shadowRoot.querySelector('#tempqqq' + this.id).opened == true) {
                        this.shadowRoot.querySelector('#tempqqq' + this.id).opened = false;
                        this._reallydelete();
                    }

                });

                this.dataManager = new DataPackage('product');
                this.user = store.get('change-user') || null;

            },
            _reallydelete: function () {
                let that = this;
                let shadow = this.shadowRoot;
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let param = {
                    "action": "deleteData",
                    "index": "change",
                    "type": "product",
                    "id": this.id
                };
                Polymer.postData(Url, param).then(res => {
                    if (res.code > 0) {
                        // location.reload();
                        shadow.querySelector('#deleteall').style.display = "none";
                    } else {
                        console.log("error in reallydelete");
                    }
                })
            },

            _deleteproduct: function () {
                // console.log("inside deleteproduct");
                let that = this;
                let shadow = this.shadowRoot;
                let Url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                let dialog = shadow.querySelector('#tempqqq' + this.id);
                Polymer.popup(dialog, "change", "change-confirm", "30%", "50%");
            },
            ready: function () {
                this.id = this.getAttribute('id');
                this.shadowRoot.querySelector('#tempqqq').id = 'tempqqq' + this.id;
                let that = this;
                var json;
                let url = "https://d25k6mzsu7mq5l.cloudfront.net/user-data/change/json/product-" + this.id + ".json?id=" + new Date().getTime();
                Polymer.getContent(url).then(str => {
                    json = JSON.parse(str);
                    that.userdata(json);
                }, err => {
                    that.dataManager.loadData(that.id).then(res => {
                        console.log('Cannot read product', res);
                        that.userdata(res);
                    });
                });

            },

            userdata(all) {
                var user = this.user;
                let shadow = this.shadowRoot;
                this.all = all;
                this.id = this.getAttribute('id');
                if (Array.isArray(all['pics']))
                    this.pics = all['pics'][0];
                else
                    this.pics = all['pics'];

                if (!this.pics)
                    this.pics = './img/nopic.png';

                this.productname = all['productname'];
                this.price = "$" + all['price'];
                if (all['isFree'] == true) {
                    shadow.querySelector('#price').style.display = 'none';
                };
                this.ownerId = all['ownerId'];
                this.detailUrl = '/edit-product.html?p' + all['id'] + 'u' + all['ownerId'];
                this.userUrl = "/user.html?" + this.ownerId;
                // console.log('Link', this.detailUrl, this.userUrl);
                if (all['isNew'] == true)
                    shadow.querySelector('.s_title_tags').innerHTML = "<polygon points=\"0,0 40,0 30,16 0,16\" style=\"fill:#ebbd35;stroke:#ebbd35;stroke-width:0\"></polygon><text x=\"3\" y=\"12\" fill=\"white\" id=\"isNew\" >全新</text>"
                else
                    shadow.querySelector('.s_title_tags').innerHTML = "<polygon points=\"0,0 40,0 30,16 0,16\" style=\"fill:#7cd3da;stroke:#7cd3da;stroke-width:0\"></polygon><text x=\"3\" y=\"12\" fill=\"white\" id=\"isNew\" >二手</text>"
                if (all.replyArray) {
                    if (all.replyArray.length > 0) {
                        shadow.querySelector('#status1').id = "status";
                    }
                }
                if (all['isFanpage'] == true) {
                    this.shadowRoot.querySelector('change-user-tag').loadPage(all['fanpage'], all['createTime']);

                } else {
                    this.shadowRoot.querySelector('change-user-tag').loadData(all['ownerId'], all['createTime']);

                }
                this.shadowRoot.querySelector('change-item-tag').loadTags(all['tags']);
                if (user) {
                    let boolean = user['isAdmin'] || null;
                    if (boolean || user['_id'] == all['ownerId']) {
                        shadow.querySelector('.shouldhide').style.visibility = 'visible';
                    }

                }


            }

        });
    })();
</script>