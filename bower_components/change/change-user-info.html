<link href="../polymer/polymer.html" rel="import">
<link href="../dz-menu/css/style.html" rel="import" />
<link rel="import" href="../vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../vaadin-select/vaadin-select.html">
<link rel="import" href="../vaadin-button/vaadin-button.html">
<link rel="import" href="../vaadin-text-field/vaadin-email-field.html">
<link rel="import" href="../vaadin-text-field/vaadin-number-field.html">
<dom-module id="change-user-info">
    <template>
        <style include="icon-styles"></style>
        <style>
            *,
            p,
            h5 {
                color: black;
                font-family: sans-serif, Microsoft JhengHei;
            }

            a {
                text-decoration: none;

            }

            #info {
                padding: 8px;
                margin-left: 100px;
            }

            #left {
                width: 80%;
                float: left;
            }

            .inf {
                line-height: 2.5;
                color: grey;
            }

            .infotext {
                color: black;

            }

            #right {
                /* width: 75%; */
                display: inline-flex;
                align-content: flex-end;
            }

            /* #top {
                margin-left: 8%;
                margin-right: 8%;
                margin-top: 2%;
                padding-top: 2%;
                padding-left: 2%;
                background-color: white;
                height: auto;
            } */

            .grid-container {
                display: grid;
                grid-template-columns: 2.5fr 1fr;
                background-color: white;
                width: 84%;
                margin: 0 auto;
            }

            h5 {
                font-size: 1em;
                color: black;
            }

            #container {
                float: left;
                background-color: #FFFBF2;
                width: 100%;
                padding-top: 30px;
                padding-bottom: 30px;
                margin-bottom: 10px;
            }

            .buttons {
                margin-block-start: 1.67em;
                margin-block-end: 1.67em;
                margin-right: 100px;
                display: flex;
            }

            @media (max-width: 640px) {
                .grid-container {
                    display: block;
                    height: 340px;
                    width: 100%;
                    margin: 0px;
                    padding: 0px;
                    margin-bottom: 10px;
                }

                #container {
                    padding-top: 0;
                    padding-bottom: 0;
                    margin-bottom: 0;
                }

                #info {
                    margin-left: 0;
                }

                .buttons {
                    display: block;
                    margin-block-start: 0em;
                    margin-block-end: 0em;
                    margin-left: 20px;
                }
            }
        </style>
        <div id="container">
            <div class="grid-container">
                <div id="left">
                    <div id="info">
                        <h5>賣家資料</h5>
                        <p class="inf">名稱: <span class="infotext" id="name">{{user.username}}</span></p>
                        <p class="inf">地區: <span class="infotext" id="area">{{user.area}}</span></p>
                        <p class="inf">電郵: <span class="infotext" id="email">{{user.email}}</span></p>
                        <!-- <p class="inf">電話: <span class="infotext" id="contact"></span></p> -->
                    </div>
                </div>
                <div id="right">
                    <div class="buttons">
                        <a href="/add-product.html">
                            <vaadin-button id="ap" style="margin-right: 10px;">新增貨品</vaadin-button>
                        </a>

                        <vaadin-button id="vb" on-click="toggle">{{edit}}</vaadin-button>

                    </div>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    (function() {
        Polymer({
            is: 'change-user-info',
            properties: {

            },
            created: function() {

            },
            ready: function() {
                let loc = location.search;
                let user = store.get('change-user') || null;
                let shadow = this.shadowRoot;
                let that = this
                let id = "";
                for (var i = 1; i < loc.length; i++) {
                    console.log("Working");
                    id += loc[i];
                }
                this.id = id;
                if (user == null || id != user['_id']) {
                    shadow.querySelector('#right').style.display = 'none'; /*none*/
                }

                if (id != "") {
                    let url = "/json/user-" + id + ".json?id=" + new Date().getTime();
                    Polymer.getContent(url).then(res => {
                        res = JSON.parse(res);
                        that.user = res;
                    })
                }

                this.edit = "編輯";

            },
            execute: function() {
                console.log("Entered");
                let shadow = this.shadowRoot;
                customElements.whenDefined('vaadin-select').then(function() {
                    const district = [{
                        id: '中西區',
                        name: '中西區'
                    }, {
                        id: '灣仔區',
                        name: '灣仔區'
                    }, {
                        id: '東區',
                        name: '東區'
                    }, {
                        id: '南區',
                        name: '南區'
                    }, {
                        id: '油尖旺區',
                        name: '油尖旺區'
                    }, {
                        id: '深水埗',
                        name: '深水埗區'
                    }, {
                        id: '九龍城區',
                        name: '九龍城區'
                    }, {
                        id: '黃大仙區',
                        name: '黃大仙區'
                    }, {
                        id: '觀塘區',
                        name: '觀塘區'
                    }, {
                        id: '葵青區',
                        name: '葵青區'
                    }, {
                        id: '荃灣區',
                        name: '荃灣區'
                    }, {
                        id: '屯門區',
                        name: '屯門區'
                    }, {
                        id: '元朗區',
                        name: '元朗區'
                    }, {
                        id: '離島區',
                        name: '離島區'
                    }, {
                        id: '北區',
                        name: '北區'
                    }, {
                        id: '大埔區',
                        name: '大埔區'
                    }, {
                        id: '沙田區',
                        name: '沙田區'
                    }, {
                        id: '西貢區',
                        name: '西貢區'
                    }];
                    shadow.querySelector('vaadin-select').renderer = function(root) {
                        // Check if there is a list-box generated with the previous renderer call to update its content instead of recreation
                        if (root.firstChild) {
                            return;
                        }
                        // Create the <vaadin-list-box>
                        const listBox = document.createElement('vaadin-list-box');
                        district.forEach(function(item) {
                            const vaadinItem = document.createElement('vaadin-item');
                            vaadinItem.textContent = item.name;
                            listBox.appendChild(vaadinItem);
                            vaadinItem.setAttribute('value', item.id);
                        });
                        // update the content
                        root.appendChild(listBox);
                    };
                });
            },
            toggle: function() {
                //GET BANNER INFO//
                let userBan = document.querySelector('change-user-banner');
                let mp = userBan.shadowRoot.querySelector('#mp').style.backgroundImage;
                bannerSrc = mp.replace('url(', '').replace(')', '').replace(/\"/gi, "");
                let headSrc = userBan.shadowRoot.querySelector('#dp').src;

                let user = store.get('change-user') || null;
                let loc = location.search;
                let id = "";
                for (var i = 1; i < loc.length; i++) {
                    console.log("Working");
                    id += loc[i];
                }
                if (id == "") {
                    id = user['_id'];
                }
                if (id != user['_id']) {} else {
                    let shadow = this.shadowRoot;
                    let text = shadow.querySelector('#vb');
                    if (this.edit == "編輯") {
                        this.user.username = "<vaadin-text-field id='name1' value='" + name + "'></vaadin-text-field>";
                        this.user.area = "<vaadin-select id='area1' value='" + area + "' label=''></vaadin-select>";
                        this.execute();
                        this.user.email = "<vaadin-email-field id='email1' value='" + email + "'disabled></vaadin-text-field>";
                        this.edit = "提交";
                    } else {
                        let url = "https://41khtanrje.execute-api.ap-northeast-1.amazonaws.com/prod/Dazzle-elasticSearchController";
                        let name = shadow.querySelector('#name1').value;
                        let area = shadow.querySelector('#area1').value;
                        let email = shadow.querySelector('#email1').value;

                        let params = {
                            "action": "addData",
                            "index": "change",
                            "type": "_user",
                            "id": user['_id'],
                            "body": {
                                "email": email,
                                "username": name,
                                "area": area,
                                "banner": bannerSrc,
                                "head": headSrc
                            }
                        };
                        Polymer.postData(url, params).then(res => {
                            if (res.code > 0) {
                                this.user.name = name;
                                this.user.area = area;
                                this.user.email = email;
                                this.edit = "編輯";
                                user['email'] = email;
                                user['area'] = area;
                                user['username'] = name;
                                user['banner'] = bannerSrc;
                                user['head'] = headSrc;
                                store.set("change-user", user);

                                this._saveJson();
                            }
                        })
                    }
                }

            },


            _saveJson: function() {
                let url = "/json/user-" + this.id + ".json?id=" + new Date().getTime();
                Polymer.getContent(url).then(res => {
                    res = JSON.parse(res);
                    this.fileManager.saveFile('json/user-' + userJson.id + '.json', JSON.stringify(res));
                    alert("用戶資料已更新!");

                });

            }
        });
    })();
</script>